function SaikuTableRenderer(e,t){this._data=e,this._options=_.extend({},SaikuRendererOptions,t)}function genTotalDataCells(e,t,i,s,a){var r="";a=a[ROWS];for(var n=i.length-1;0<=n;n--)if(e==i[n]){for(var o=a[n][s[n]],l=0;l<o.cells.length;l++)r+='<td class="data total">'+o.cells[l][t].value+"</td>";++s[n]<a[n].length&&(i[n]+=a[n][s[n]].width)}return r}function genTotalHeaderCells(e,t,i,s,a,r){for(var n="",o=t;0<=o;o--)if(e==i[o]){var l,d=a[o][s[o]];l=0==o&&1==t?"col":o==t?"col_total_corner":o==t-1&&d.captions?"col_total_first":"col_null";for(var c=0;c<d.cells.length;c++){var h="&nbsp;";t==a.length-1&&(d.captions&&(h=a[o][s[o]].captions[c]),0==o&&0==s[o]&&(h=d.captions?h+"&nbsp;":"",h+=r?"<span class='i18n'>Grand Total</span>":"Grand Total")),n+='<th class="'+l+'">'+(r?"<div>"+h+"</div>":h)+"</th>"}++s[o]<a[o].length&&(i[o]+=a[o][s[o]].width)}return n}function totalIntersectionCells(e,t,i,s,a){for(var r="";0<=t;t--)if(e==i[t]){for(var n=a[t][s[t]],o=0;o<n.cells.length;o++)r+='<td class="data total">&nbsp;</td>';++s[t]<a[t].length&&(i[t]+=a[t][s[t]].width)}return r}function genTotalHeaderRowCells(e,t,i,s,a){for(var r=s[COLUMNS],n=t[COLUMNS],o=i[COLUMNS],l=r.length-2,d="",c=l;0<=c;c--)if(e==n[c]){for(var h=0;h<r[c][o[c]].cells.length;h++){for(d+="<tr>",t=0;t<=l;t++){var u="&nbsp;";i=0==c&&0==t?"row":c==t+1?"row_total_corner":c==t&&r[c][o[c]].captions?"row_total_first":c<t+1?"row_total":"row_null",t==l&&(r[c][o[c]].captions&&(u=r[c][o[c]].captions[h]),0==c&&0==o[c]&&(u=r[c][o[c]].captions?u+"&nbsp;":"",u+=a?"<span class='i18n'>Grand Total</span>":"Grand Total")),d+='<th class="'+i+'">'+(a?"<div>"+u+"</div>":u)+"</th>"}for(i={},t={},u=0;u<s[ROWS].length;u++)i[u]=0,t[u]=s[ROWS][u][i[u]].width;for(u=0;u<r[c][o[c]].cells[h].length;u++)d+='<td class="data total">'+r[c][o[c]].cells[h][u].value+"</td>",d+=totalIntersectionCells(u+1,s[ROWS].length-1,t,i,s[ROWS]);d+="</tr>"}++o[c]<r[c].length&&(n[c]+=r[c][o[c]].width)}return d}function nextParentsDiffer(e,t,i){for(;0<t--;)if(e[t][i].properties.uniquename!=e[t][i+1].properties.uniquename)return!0;return!1}function topParentsDiffer(e,t,i){for(;0<i--;)if(e[t][i].properties.uniquename!=e[t-1][i].properties.uniquename)return!0;return!1}var oldqueryModel,oldmdx,conditions,queryFormatted,condFormatting,initFormat=function(){oldqueryModel=null,oldmdx=null,conditions=[],queryFormatted=!0,condFormatting=!1};initFormat();var getHtml=function(e,t){return'<div id="mainRow'+e+'" class="row mainRow"><div class="col-md-3 col-xs-3"><select id="measure" class="form-control condFormSelect">'+t.html()+'</select></div><div class="col-md-3"><select id="cond" class="form-control condition condFormSelect"><option value="<">Less than</option><option value="<=">Less than or equal to</option><option value=">">Greater than</option><option value=">=">Greater than or equal to</option><option value="=">Equal to</option><option value="<>">Not equal to</option><option value="><">Between</option></select></div><div class="col-md-2"><input id="val1" class="form-control condFormText" type="text" value="1000" /><input id="val2" class="form-control condFormText" type="text" value="2000" style="display:none" /></div><div class="col-md-1"><input id="colorval" type="hidden" id="hidden-input" class="demo condFormText" value="#19b326"></div><div class="col-md-1"><div class="checkbox"><input type="checkbox" id="hideVal" name="hide" value="hide"><span>Hide</span></div></div><div style="float:left;margin-top:10px;"><button class="btn btn-warning removeEntry"><i class="fa fa-remove"></i></button></div></div>'},condFormatDialog=function(e,t){var i=e.queryModel.details.measures,s=[],a=$('<select class="form-control">');$(i).each(function(){a.append($("<option>").attr("value",this.name).text(this.caption)),s.push(this.name)});e.mdx;var r=0,n="";$.each(conditions,function(e,t){n+=getHtml(r,a),r++}),conditions.length<1&&(n=getHtml(r,a),r++);BootstrapDialog.show({title:"Conditional Formatting",message:function(e){var t=$('<div align="center"></div>'),i='<div style="padding:0 20px"><div class="main_cond_div" >'+n+'</div><div class="row"><button id="add_cond" class="btn btn-primary"> Add Condition </button></div><div style="overflow:hidden;height:0;clear:both;"></div></div>';return t.append(i),t},draggable:!0,closable:!1,cssClass:"browse-dialog",onshown:function(e){function t(){$(".removeEntry").on("click",function(){$("#"+$(this).parent().parent().attr("id")).remove()}),$(".demo").minicolors({control:$(this).attr("data-control")||"hue",defaultValue:$(this).attr("data-defaultValue")||"",format:$(this).attr("data-format")||"hex",keywords:$(this).attr("data-keywords")||"",inline:"true"===$(this).attr("data-inline"),letterCase:$(this).attr("data-letterCase")||"lowercase",opacity:$(this).attr("data-opacity"),position:$(this).attr("data-position")||"bottom left",swatches:$(this).attr("data-swatches")?$(this).attr("data-swatches").split("|"):[],change:function(e,t){var i;try{i=e||"transparent",t&&(i+=", "+t)}catch(e){}},theme:"default"}),$(".condition").on("change",function(){var e=$(this).parent().parent().attr("id");"><"==$("#"+e+" #cond option:selected").val()?$("#"+e+" #val2").css("display","block"):$("#"+e+" #val2").css("display","none")})}$.each(conditions,function(e,t){$("#mainRow"+e).find("#measure").val(t.measure),$("#mainRow"+e).find("#cond").val(t.condition),$("#mainRow"+e).find("#val1").val(t.value),$("#mainRow"+e).find("#colorval").val(t.color),void 0!=t.hideVal&&$("#mainRow"+e).find("#hideVal").prop("checked",t.hideVal),"><"==t.condition?($("#mainRow"+e).find("#val2").val(t.value2),$("#mainRow"+e).find("#val2").css("display","block")):($("#mainRow"+e).find("#val2").val(t.value2),$("#mainRow"+e).find("#val2").css("display","none"))});t(),$("#add_cond").on("click",function(){var e=getHtml(r,a);$(".main_cond_div").append(e),t(),r++})},buttons:[{label:"Apply",cssClass:"btn-primary",action:function(e){var i=[];$(".mainRow").each(function(){var e={};e.measure=$(this).find("#measure option:selected").val(),e.condition=$(this).find("#cond option:selected").val(),e.value=$(this).find("#val1").val(),e.value2=$(this).find("#val2").val(),e.color=$(this).find("#colorval").val(),e.hideVal=$(this).find("#hideVal").is(":checked"),(void 0!=e.measure||null!=e.measure||void 0!=e.condition||null!=e.condition||void 0!=e.value||null!=e.value||e.value.length>0)&&i.push(e)}),e.close(),t(i)}},{label:"Cancel",action:function(e){e.close()},cssClass:"btn-danger"}]})},SaikuOlapQueryTemplate={queryModel:{axes:{FILTER:{mdx:null,filters:[],sortOrder:null,sortEvaluationLiteral:null,hierarchizeMode:null,location:"FILTER",hierarchies:[],nonEmpty:!1},COLUMNS:{mdx:null,filters:[],sortOrder:null,sortEvaluationLiteral:null,hierarchizeMode:null,location:"COLUMNS",hierarchies:[],nonEmpty:!0},ROWS:{mdx:null,filters:[],sortOrder:null,sortEvaluationLiteral:null,hierarchizeMode:null,location:"ROWS",hierarchies:[],nonEmpty:!0}},visualTotals:!1,visualTotalsPattern:null,lowestLevelsOnly:!1,details:{axis:"COLUMNS",location:"BOTTOM",measures:[]},calculatedMeasures:[],calculatedMembers:[]},queryType:"OLAP",type:"QUERYMODEL"},SaikuOlapQueryHelper=function(e){this.query=e};SaikuOlapQueryHelper.prototype.model=function(){return this.query.model},SaikuOlapQueryHelper.prototype.clearAxis=function(e){this.model().queryModel.axes[e].hierarchies=[]},SaikuOlapQueryHelper.prototype.getHierarchy=function(e){var t;for(t in this.model().queryModel.axes){var i=this.model().queryModel.axes[t];if(i=_.find(i.hierarchies,function(t){return t&&t.name==e}))return i}return null},SaikuOlapQueryHelper.prototype.moveHierarchy=function(e,t,i,s){i=this.getHierarchy(i);var a=this.model().queryModel.axes[e].hierarchies.indexOf(i);t=this.model().queryModel.axes[t].hierarchies,this.model().queryModel.axes[e].hierarchies.splice(a,1),void 0!==s&&-1<s&&t.length>s?t.splice(s,0,i):t.push(i)},SaikuOlapQueryHelper.prototype.removeHierarchy=function(e){var t=this.getHierarchy(e);if(!t)return null;if(e=this.findAxisForHierarchy(e)){var i=e.hierarchies.indexOf(t);e.hierarchies.splice(i,1)}return t},SaikuOlapQueryHelper.prototype.findAxisForHierarchy=function(e){for(var t in this.model().queryModel.axes){var i=this.model().queryModel.axes[t];if(i.hierarchies&&0<i.hierarchies.length)for(var s=0,a=i.hierarchies.length;s<a;s++)if(i.hierarchies[s].name==e)return i}return null},SaikuOlapQueryHelper.prototype.getAxis=function(e){if(e in this.model().queryModel.axes)return this.model().queryModel.axes[e];Saiku.log("Cannot find axis: "+e)},SaikuOlapQueryHelper.prototype.removeFilter=function(e,t){if(t&&1<e.filters.length){for(var i=-1,s=0,a=e.filters.length;s<a;s++)e.filters[s].flavour==t&&(i=s);i&&0<=i&&e.filters.splice(i,0)}else e.filters=[]},SaikuOlapQueryHelper.prototype.includeLevel=function(e,t,i,s){var a=this.getHierarchy(t);a||(a={name:t,levels:{},cmembers:{}}),a.levels[i]={name:i};var r=this.findAxisForHierarchy(t);r?this.moveHierarchy(r.location,e,t,s):(t=this.model().queryModel.axes[e])?void 0!==s&&-1<s&&t.hierarchies.length>s?t.hierarchies.splice(s,0,a):t.hierarchies.push(a):Saiku.log("Cannot find axis: "+e+" to include Level: "+i)},SaikuOlapQueryHelper.prototype.includeLevelCalculatedMember=function(e,t,i,s,a){var r=this.getHierarchy(t);r||(r={name:t,levels:{},cmembers:{}}),r.cmembers[s]=s,(s=this.findAxisForHierarchy(t))?this.moveHierarchy(s.location,e,t,a):(t=this.model().queryModel.axes[e])?void 0!==a&&-1<a&&t.hierarchies.length>a?t.hierarchies.splice(a,0,r):t.hierarchies.push(r):Saiku.log("Cannot find axis: "+e+" to include Level: "+i)},SaikuOlapQueryHelper.prototype.removeLevel=function(e,t){(e=this.getHierarchy(e))&&e.levels.hasOwnProperty(t)&&delete e.levels[t]},SaikuOlapQueryHelper.prototype.removeLevelCalculatedMember=function(e,t){(e=this.getHierarchy(e))&&e.cmembers.hasOwnProperty(t)&&delete e.cmembers[t]},SaikuOlapQueryHelper.prototype.includeMeasure=function(e){var t,i=this.model().queryModel.details.measures,s=i.length,a=!1;if(i&&!_.isEmpty(i)){for(t=0;t<s;t++){if(i[t].name===e.name){a=!0;break}a=!1}!1===a&&i.push(e)}else i.push(e)},SaikuOlapQueryHelper.prototype.removeMeasure=function(e){var t=this.query.model.queryModel.details.measures;(e=_.findWhere(t,{name:e}))&&-1<_.indexOf(t,e)&&_.without(t,e)},SaikuOlapQueryHelper.prototype.clearMeasures=function(){this.model().queryModel.details.measures=[]},SaikuOlapQueryHelper.prototype.setMeasures=function(e){this.model().queryModel.details.measures=e},SaikuOlapQueryHelper.prototype.addCalculatedMeasure=function(e){e&&(this.removeCalculatedMeasure(e.name),this.model().queryModel.calculatedMeasures.push(e))},SaikuOlapQueryHelper.prototype.editCalculatedMeasure=function(e,t){t&&(this.removeCalculatedMeasure(e),this.removeCalculatedMember(e),this.model().queryModel.calculatedMeasures.push(t))},SaikuOlapQueryHelper.prototype.removeCalculatedMeasure=function(e){var t=this.model().queryModel.calculatedMeasures;(e=_.findWhere(t,{name:e}))&&-1<_.indexOf(t,e)&&(t=_.without(t,e),this.model().queryModel.calculatedMeasures=t)},SaikuOlapQueryHelper.prototype.getCalculatedMeasures=function(){var e=this.model().queryModel.calculatedMeasures;return e||null},SaikuOlapQueryHelper.prototype.addCalculatedMember=function(e){e&&(this.removeCalculatedMember(e.name),this.model().queryModel.calculatedMembers.push(e))},SaikuOlapQueryHelper.prototype.editCalculatedMember=function(e,t){t&&(this.removeCalculatedMeasure(e),this.removeCalculatedMember(e),this.model().queryModel.calculatedMembers.push(t))},SaikuOlapQueryHelper.prototype.removeCalculatedMember=function(e){var t=this.model().queryModel.calculatedMembers;(e=_.findWhere(t,{name:e}))&&-1<_.indexOf(t,e)&&(t=_.without(t,e),this.model().queryModel.calculatedMembers=t)},SaikuOlapQueryHelper.prototype.getCalculatedMembers=function(){var e=this.model().queryModel.calculatedMembers;return e||null},SaikuOlapQueryHelper.prototype.swapAxes=function(){var e=this.model().queryModel.axes,t=e.ROWS;t.location="COLUMNS",e.ROWS=e.COLUMNS,e.ROWS.location="ROWS",e.COLUMNS=t},SaikuOlapQueryHelper.prototype.nonEmpty=function(e){e?(this.model().queryModel.axes.ROWS.nonEmpty=!0,this.model().queryModel.axes.COLUMNS.nonEmpty=!0):(this.model().queryModel.axes.ROWS.nonEmpty=!1,this.model().queryModel.axes.COLUMNS.nonEmpty=!1)};var DateFilterModel=Backbone.Model.extend({}),DateFilterCollection=Backbone.Collection.extend({model:DateFilterModel}),SaikuRendererOptions={mode:null,dataMode:null,htmlObject:null,width:null,height:null},SaikuRenderer=function(e,t){this._options=_.extend(SaikuRendererOptions,t),this._hasProcessed=!1,"undefined"!=typeof Backbone&&_.extend(this,Backbone.Events),this.render=function(e,t){var i=null;return"undefined"!=typeof Backbone&&this.trigger("render:start",this),this.hasProcessedData()||this.processData(e,t),i=this._render(e,t),"undefined"!=typeof Backbone&&this.trigger("render:end",this),i},this.processData=function(e,t){"undefined"!=typeof Backbone&&this.trigger("processData:start",this),this._processData(e,t),"undefined"!=typeof Backbone&&this.trigger("processData:end",this)},this.hasProcessedData=function(){return this._hasProcessed},this._render=function(e,t){},this._processData=function(e,t){},e&&(this._data=e,this.processData(e,t),this._hasProcessed=!0)};SaikuTableRenderer.prototype.render=function(e,t){var i=this;if(e&&(this._data=e),t&&(this._options=_.extend({},SaikuRendererOptions,t)),void 0!==this._data&&!(null!=this._data&&null!=this._data.error||null==this._data||this._data.cellset&&0===this._data.cellset.length)){if(!this._options.htmlObject)return this.internalRender(this._data,i._options);i._options.hasOwnProperty("batch")&&$(i._options.htmlObject).parent().parent().unbind("scroll"),_.defer(function(e){return i._options.hasOwnProperty("batch")&&!i._options.hasOwnProperty("batchSize")&&(i._options.batchSize=1e3),e=i.internalRender(i._data,i._options),$(i._options.htmlObject).html(e),_.defer(function(e){if(i._options.hasOwnProperty("batch")&&i._options.hasBatchResult){var t=0,s=!1,a=i._options.hasOwnProperty("batchIntervalSize")?i._options.batchIntervalSize:20;e=i._options.hasOwnProperty("batchIntervalTime")?i._options.batchIntervalTime:20;var r=i._options.batchResult.length,n=_.debounce(function(){if(!s&&0<r&&t<r){s=!0;for(var e="",n=t,o=0;t<r&&o<a;o++,t++)e+=i._options.batchResult[t];t>n&&$(i._options.htmlObject).append($(e)),s=!1}t>=r&&$(i._options.htmlObject).parent().parent().unbind("scroll")},e);$(i._options.htmlObject).parent().parent().scroll(function(){n()})}}),e})}},SaikuTableRenderer.prototype.clear=function(e,t){this._options&&this._options.htmlObject&&this._options.hasOwnProperty("batch")&&$(this._options.htmlObject).parent().parent().unbind("scroll")},SaikuTableRenderer.prototype.processData=function(e,t){this._hasProcessed=!0};var ROWS="ROWS",COLUMNS="COLUMNS";SaikuTableRenderer.prototype.internalRender=function(e,t){var i,s,a,r,n,o="",l="",d=e.cellset,c=d||[],h=0,u=[],p=null,f=!1,m=!1,_=!1,y=[],g=!0;t&&(p=t.hasOwnProperty("batchSize")?t.batchSize:null,g=!t.hasOwnProperty("wrapContent")||t.wrapContent);var v={};v[COLUMNS]=e.rowTotalsLists,v[ROWS]=e.colTotalsLists;for(var b={},k={},m=[ROWS,COLUMNS],l=0;l<m.length;l++)b[m[l]]=[],k[m[l]]=[];if(v[COLUMNS])for(l=0;l<v[COLUMNS].length;l++)k[COLUMNS][l]=0,b[COLUMNS][l]=v[COLUMNS][l][k[COLUMNS][l]].width;for(var w=0,$=c.length;w<$;w++){var S=w-e.topOffset;i=1;var x=m=r=s=!1;if(v[ROWS])for(l=0;l<v[ROWS].length;l++)k[ROWS][l]=0,b[ROWS][l]=v[ROWS][l][k[ROWS][l]].width;l="<tr>",0===w&&(l="<thead>"+l);for(var q=0,C=c[w].length;q<C;q++){O=q-e.leftOffset;if("COLUMN_HEADER"===(T=d[w][q]).type&&(m=!0),"COLUMN_HEADER"===T.type&&"null"===T.value&&(null==a||q<a))l+='<th class="all_null">&nbsp;</th>';else if("COLUMN_HEADER"===T.type){if(null==a&&(a=q),c[w].length==q+1?r=!0:n=d[w][q+1],r)"null"==T.value?l+='<th class="col_null">&nbsp;</th>':(v[ROWS]&&(i=v[ROWS][w+1][k[ROWS][w+1]].span),l+='<th class="col" style="text-align: center;" colspan="'+i+'" title="'+T.value+'">'+(g?'<div rel="'+w+":"+q+'">'+T.value+"</div>":T.value)+"</th>");else{var O=1<q&&1<w&&!s&&q>a&&(d[w-1][q+1].value!=d[w-1][q].value||d[w-1][q+1].properties.uniquename!=d[w-1][q].properties.uniquename),E=999<i;T.value!=n.value||nextParentsDiffer(d,w,q)||s||O||E?("null"==T.value?l+='<th class="col_null" colspan="'+i+'">&nbsp;</th>':(v[ROWS]&&(i=v[ROWS][w+1][k[ROWS][w+1]].span),l+='<th class="col" style="text-align: center;" colspan="'+(0==i?1:i)+'" title="'+T.value+'">'+(g?'<div rel="'+w+":"+q+'">'+T.value+"</div>":T.value)+"</th>"),i=1):i++}v[ROWS]&&(l+=genTotalHeaderCells(q-e.leftOffset+1,w+1,b[ROWS],k[ROWS],v[ROWS],g))}else if("ROW_HEADER"===T.type&&"null"===T.value)l+='<th class="row_null">&nbsp;</th>';else if("ROW_HEADER"===T.type){h==q?s=!0:n=d[w][q+1],O=d[w-1],x=!(E=!(x||s||0!=q&&topParentsDiffer(d,w,q)||T.value!==O[q].value)),O=E?"<div>&nbsp;</div>":'<div rel="'+w+":"+q+'">'+T.value+"</div>",g||(O=E?"&nbsp;":T.value);var E=E?"row_null":"row",M=0;if(!s&&(void 0===n||"null"===n.value)){for(var M=1,R=T.properties.dimension,T=T.properties.level,T=(R in u?u[R].length-u[R].indexOf(T):1),R=q+1;M<T&&R<=h+1&&"null"!==d[w][R];R++)M=R-q;q=q+M-1}l+='<th class="'+E+'" '+(0<M?' colspan="'+M+'"':"")+">"+O+"</th>"}else if("ROW_HEADER_HEADER"===T.type)l+='<th class="row_header">'+(g?"<div>"+T.value+"</div>":T.value)+"</th>",s=!0,h=q,T.properties.hasOwnProperty("dimension")&&((R=T.properties.dimension)in u||(u[R]=[]),u[R].push(T.properties.level));else if("DATA_CELL"===T.type){if(f=!0,E="",R=T.value,M="",T.properties.hasOwnProperty("image"))var R=T.properties.hasOwnProperty("image_height")?" height='"+T.properties.image_height+"'":"",D=T.properties.hasOwnProperty("image_width")?" width='"+T.properties.image_width+"'":"",R="<img "+R+" "+D+" style='padding-left: 5px' src='"+T.properties.image+"' border='0'>";T.properties.hasOwnProperty("style")&&(E=" style='background-color: "+T.properties.style+"' "),T.properties.hasOwnProperty("link")&&(R="<a target='__blank' href='"+T.properties.link+"'>"+R+"</a>"),T.properties.hasOwnProperty("arrow")&&(M="<img height='10' width='10' style='padding-left: 5px' src='./images/arrow-"+T.properties.arrow+".gif' border='0'>"),l+='<td class="data" '+E+">"+(g?'<div class="datadiv" alt="'+T.properties.raw+'" rel="'+T.properties.position+'">':"")+R+M+(g?"</div>":"")+"</td>",v[ROWS]&&(l+=genTotalDataCells(O+1,S,b[ROWS],k[ROWS],v,g))}}l+="</tr>",i="",v[COLUMNS]&&0<=S&&(i+=genTotalHeaderRowCells(S+1,b,k,v,g)),f&&p?w<=p?(m||_||(o+="</thead><tbody>",_=!0),o+=l,0<i.length&&(o+=i)):(y.push(l),0<i.length&&y.push(i)):(m||_||(o+="</thead><tbody>",_=!0),o+=l,0<i.length&&(o+=i))}return t&&(t.batchResult=y,t.hasBatchResult=0<y.length),"<table>"+o+"</tbody></table>"};var SaikuChartRenderer=function(e,t){if(this.rawdata=e,this.cccOptions={},this.data=null,this.hasRendered=this.hasProcessed=!1,!t&&!t.hasOwnProperty("htmlObject"))throw"You need to supply a html object in the options for the SaikuChartRenderer!";if(this.el=$(t.htmlObject),this.id=_.uniqueId("chart_"),$(this.el).html('<div class="canvas_wrapper" style="display:none;"><div id="canvas_'+this.id+'"></div></div>'),this.zoom=t.zoom){var i=this;$("<span style='float:left;' class='zoombuttons'><a href='#' class='button rerender i18n' title='Re-render chart'></a><a href='#' class='button zoomout i18n' style='display:none;' title='Zoom back out'></a></span>").prependTo($(this.el).find(".canvas_wrapper")),$(this.el).find(".zoomout").on("click",function(e){e.preventDefault(),i.zoomout()}),$(this.el).find(".zoomin").on("click",function(e){e.preventDefault(),i.zoomin()}),$(this.el).find(".rerender").on("click",function(e){e.preventDefault(),$(i.el).find(".zoomout").hide(),i.switch_chart(i.type)})}t.chartDefinition&&(this.chartDefinition=t.chartDefinition),this.cccOptions.canvas="canvas_"+this.id,this.adjustSizeTo=this.data=null,this.adjustSizeTo=t.adjustSizeTo?t.adjustSizeTo:t.htmlObject,this.rawdata&&("sunburst"==this.type?this.process_data_tree({data:this.rawdata}):this.process_data_tree({data:this.rawdata},!0,!0)),t.mode?this.switch_chart(t.mode):this.switch_chart("stackedBar"),this.adjust()};SaikuChartRenderer.prototype.adjust=function(){var e=this,t=_.debounce(function(){e.hasRendered&&$(e.el).is(":visible")&&e.switch_chart(e.type)},300);$(window).resize(function(){$(e.el).find(".canvas_wrapper").fadeOut(150),t()})},SaikuChartRenderer.prototype.zoomin=function(){$(this.el).find(".canvas_wrapper").hide();var e=this.chart.root,t=e.data;t.datums(null,{selected:!1}).each(function(e){e.setVisible(!1)}),t.clearSelected(),e.render(!0,!0,!1),this.render_chart_element()},SaikuChartRenderer.prototype.zoomout=function(){var e=this.chart.root,t=e.data,i=e.keptVisibleDatumSet;null===i||0===i.length?$(this.el).find(".zoomout").hide():1==i.length?($(this.el).find(".zoomout").hide(),e.keptVisibleDatumSet=[],pvc.data.Data.setVisible(t.datums(null,{visible:!1}),!0)):1<i.length&&(e.keptVisibleDatumSet.splice(i.length-1,1),t=t.datums(null,{visible:!1}).array(),_.intersection(e.keptVisibleDatumSet[i.length-1],t).forEach(function(e){e.setVisible(!0)})),e.render(!0,!0,!1)},SaikuChartRenderer.prototype.render=function(){_.delay(this.render_chart_element,0,this)},SaikuChartRenderer.prototype.switch_chart=function(e,t){null==t&&void 0==t||null==t.chartDefinition&&void 0==t.chartDefinition||(this.chartDefinition=t.chartDefinition);var i={stackedBar:{type:"BarChart",stacked:!0},bar:{type:"BarChart"},multiplebar:{type:"BarChart",multiChartIndexes:[1],dataMeasuresInColumns:!0,orientation:"vertical",smallTitlePosition:"top",multiChartMax:30,multiChartColumnsMax:Math.floor(this.cccOptions.width/200),smallWidth:200,smallHeight:150},line:{type:"LineChart"},pie:{type:"PieChart",multiChartIndexes:[0]},heatgrid:{type:"HeatGridChart"},stackedBar100:{type:"NormalizedBarChart"},area:{type:"StackedAreaChart"},dot:{type:"DotChart"},waterfall:{type:"WaterfallChart"},treemap:{type:"TreemapChart"},sunburst:{type:"SunburstChart"},multiplesunburst:{type:"SunburstChart",multiChartIndexes:[1],dataMeasuresInColumns:!0,orientation:"vertical",smallTitlePosition:"top",multiChartMax:30,multiChartColumnsMax:Math.floor(this.cccOptions.width/200),smallWidth:200,smallHeight:150,seriesInRows:!1}};null!==e&&""!==e&&("sunburst"==e?($(this.el).find(".zoombuttons a").hide(),this.type=e,i=i[e],this.sunburst(i),this.hasProcessed&&this.render()):i.hasOwnProperty(e)?($(this.el).find(".zoombuttons a").hide(),this.type=e,i=i[e],this.cccOptions=this.getQuickOptions(i),this.define_chart(),this.hasProcessed&&this.render()):alert("Do not support chart type: '"+e+"'"))},SaikuChartRenderer.prototype.sunburst=function(e){this.type="sunburst";var t=this.process_data_tree({data:this.rawdata});e=this.getQuickOptions(e);var i=pv.dom(t).nodes();pv.colors(e.colors).by(function(e){return e.parentNode&&e.parentNode.nodeName}),(i=(t=(new pv.Panel).width(e.width).height(e.height).canvas(e.canvas)).add(pv.Layout.Partition.Fill).nodes(i).size(function(e){return e.nodeValue}).order("descending").orient("radial")).node.add(pv.Wedge).fillStyle(pv.colors(e.colors).by(function(e){return e.parentNode&&e.parentNode.nodeName})).visible(function(e){return 0<e.depth}).strokeStyle("#000").lineWidth(.5).text(function(e){var t="";return void 0!==e.nodeValue&&(t=" : "+e.nodeValue),e.nodeName+t}).cursor("pointer").events("all").event("mousemove",pv.Behavior.tipsy({delayIn:200,delayOut:80,offset:2,html:!0,gravity:"nw",fade:!1,followMouse:!0,corners:!0,arrow:!1,opacity:1})),i.label.add(pv.Label).visible(function(e){return 6<=e.angle*e.outerRadius}),this.chart=t},SaikuChartRenderer.prototype.cccOptionsDefault={Base:{animate:!1,selectable:!0,valuesVisible:!1,legend:!0,legendPosition:"top",legendAlign:"right",compatVersion:2,legendSizeMax:"30%",axisSizeMax:"40%",plotFrameVisible:!1,orthoAxisMinorTicks:!1,colors:"#1f77b4 #aec7e8 #ff7f0e #ffbb78 #2ca02c #98df8a #d62728 #ff9896 #9467bd #c5b0d5 #8c564b #c49c94 #e377c2 #f7b6d2 #7f7f7f #c7c7c7 #bcbd22 #dbdb8d #17becf #9edae5".split(" ")},HeatGridChart:{orientation:"horizontal",useShapes:!0,shape:"circle",nullShape:"cross",colorNormByCategory:!1,sizeRole:"value",legendPosition:"right",legend:!0,hoverable:!0,axisComposite:!0,colors:["red","yellow","lightgreen","darkgreen"],yAxisSize:"20%"},WaterfallChart:{orientation:"horizontal"},PieChart:{multiChartColumnsMax:3,multiChartMax:30,smallTitleFont:"bold 14px sans-serif",valuesVisible:!0,valuesMask:"{category} / {value.percent}",explodedSliceRadius:"10%",extensionPoints:{slice_innerRadiusEx:"40%",slice_offsetRadius:function(e){return e.isSelected()?"10%":0}},clickable:!0},LineChart:{extensionPoints:{area_interpolate:"monotone",line_interpolate:"monotone"}},StackedAreaChart:{extensionPoints:{area_interpolate:"monotone",line_interpolate:"monotone"}},TreemapChart:{legendPosition:"right",multiChartIndexes:0,extensionPoints:{leaf_lineWidth:2},layoutMode:"slice-and-dice",valuesVisible:!0},SunburstChart:{valuesVisible:!1,hoverable:!1,selectable:!0,clickable:!1,multiChartIndexes:[0],multiChartMax:30}},SaikuChartRenderer.prototype.getQuickOptions=function(e){var t=e&&e.type||"BarChart";if(e=_.extend({type:t,canvas:"canvas_"+this.id},this.cccOptionsDefault.Base,this.cccOptionsDefault[t],e),this.adjustSizeTo){var i=$(this.adjustSizeTo);i&&0<i.length&&(t=i.width()-40,i=i.height()-40,0<t&&(e.width=t),0<i&&(e.height=i))}return null!==this.data&&5<this.data.resultset.length&&"HeatGridChart"!==e.type&&"horizontal"!==e.orientation&&(e.extensionPoints=_.extend(Object.create(e.extensionPoints||{}),{xAxisLabel_textAngle:-Math.PI/2,xAxisLabel_textAlign:"right",xAxisLabel_textBaseline:"middle"})),e.colors=["#AE1717","#AE5B17","#0E6868"],e},SaikuChartRenderer.prototype.define_chart=function(e){this.hasProcessed||this.process_data_tree({data:this.rawdata},!0,!0);var t=this,i=this.adjustSizeTo?$(this.adjustSizeTo):$(this.el),s=null!==this.data&&80>this.data.height&&80>this.data.width,a=null!==this.data&&300>this.data.height&&300>this.data.width,a=!s&&!a,r=i.width()-40,n=i.height()-40,i=_.clone(this.cccOptions);e&&e.width&&(r=e.width),e&&e.height&&(n=e.height),0<r&&(i.width=r),0<n&&(i.height=n),a&&(i.hasOwnProperty("extensionPoints")&&i.extensionPoints.hasOwnProperty("line_interpolate")&&delete i.extensionPoints.line_interpolate,i.hasOwnProperty("extensionPoints")&&i.extensionPoints.hasOwnProperty("area_interpolate")&&delete i.extensionPoints.area_interpolate),e={legend:{scenes:{item:{execute:function(){var e=this.chart();e.hasOwnProperty("keptVisibleDatumSet")||(e.keptVisibleDatumSet=[]),0<(e=0<e.keptVisibleDatumSet.length?e.keptVisibleDatumSet[e.keptVisibleDatumSet.length-1]:[]).length?_.intersection(this.datums().array(),e).forEach(function(e){e.toggleVisible()}):pvc.data.Data.toggleVisible(this.datums()),this.chart().render(!0,!0,!1)}}}},userSelectionAction:function(e){if(0===e.length)return[];var i=t.chart.root,s=i.data,a=this.chart;if(a.hasOwnProperty("keptVisibleDatumSet")||(a.keptVisibleDatumSet=[]),1500<s.datums().count())pvc.data.Data.setSelected(e,!0);else if(s.datums(null,{visible:!0}).count()==s.datums().count()){$(t.el).find(".zoomout, .rerender").show();var r=s.datums().array();_.each(_.difference(r,e),function(e){e.setVisible(!1)}),a.keptVisibleDatumSet=[],a.keptVisibleDatumSet.push(e)}else{r=0<a.keptVisibleDatumSet.length?a.keptVisibleDatumSet[a.keptVisibleDatumSet.length-1]:[],(s=s.datums(null,{visible:!0}).array()).length<r.length&&a.keptVisibleDatumSet.push(s);var n=[];_.each(_.difference(s,e),function(e){e.setVisible(!1)}),_.each(_.intersection(s,e),function(e){n.push(e)}),0<n.length&&a.keptVisibleDatumSet.push(n)}return i.render(!0,!0,!1),[]}},i=_.extend(i,{hoverable:s,animate:!1},this.chartDefinition),t.zoom&&(s=i.legend,i=_.extend(i,e),!1===s&&(i.legend=!1)),"TreemapChart"==i.type&&(i.legend.scenes.item.labelText=function(){var e="",t=this.group;if(t)switch(t=t.depth){case 0:return"";case 1:break;case 2:e=" └ ";break;default:e=Array(2*(t-2)+1).join(" ")+" └ "}return e+this.base()}),this.chart=new pvc[i.type](i),this.chart.setData(this.data,{crosstabMode:!0,seriesInRows:!1})},SaikuChartRenderer.prototype.render_chart_element=function(e){var t=null!==(e=e||this).data&&300>e.data.height&&300>e.data.width,t=!(null!==e.data&&80>e.data.height&&80>e.data.width||t),i=!1;e.chart.options&&e.chart.options.animate&&(i=!0),i&&!$(e.el).find(".canvas_wrapper").is(":visible")||($(e.el).find(".canvas_wrapper"),$(e.el).find(".canvas_wrapper").hide());try{i&&$(e.el).find(".canvas_wrapper").show(),e.chart.render(),e.hasRendered=!0}catch(t){$("#canvas_"+e.id).text("Could not render chart"+t)}return(!e.chart.options||!e.chart.options.animate)&&(isIE||t?$(e.el).find(".canvas_wrapper").show():$(e.el).find(".canvas_wrapper").fadeIn(400),!1)},SaikuChartRenderer.prototype.process_data_tree=function(e,t,i){var s={};t&&(s.resultset=[],s.metadata=[],s.height=0,s.width=0);p=s;if(void 0!==e&&void 0!==e.data&&!(null!==e.data&&null!==e.data.error||null===e.data||e.data.cellset&&0===e.data.cellset.length)){var a=e.data.cellset;if(a&&0<a.length){var r,n,o,l=0,d=0,c=!1;for(r=0,n=a.length;0===d&&r<n;r++)for(var h=0,u=a[r].length;h<u;h++){if(!c)for(;"COLUMN_HEADER"==a[r][h].type&&"null"==a[r][h].value;)r++;if(c=!0,"ROW_HEADER_HEADER"==a[r][h].type){for(;"ROW_HEADER_HEADER"==a[r][h].type;)t&&s.metadata.push({colIndex:h,colType:"String",colName:a[r][h].value}),h++;l=h-1}if("COLUMN_HEADER"==a[r][h].type){for(d=0,o=[];d<=r;)"null"!==a[d][h].value&&o.push(a[d][h].value),d++;t&&s.metadata.push({colIndex:h,colType:"Numeric",colName:o.join(" ~ ")}),d=r+1}}for(c=[],o=0;o<=l;o++)c.push(null);for(r=d,n=a.length;r<n;r++)if(""!==a[r][0].value){for(u=[],o=[],h=d=null,o=0;o<=l;o++){if(a[r]&&"null"===a[r][o].value){for(var p=s,f=0;f<l&&"null"===a[r][f].value;f++)p=p[c[f]];f>o&&(o=f)}if(a[r]&&"null"!==a[r][o].value){if(0===o)for(f=0;f<=l;f++)c[f]=null;"number"==typeof p&&(d[h]={},p=d[h]),h=a[r][o].value,c[o]=h,p.hasOwnProperty(h)||(p[h]={}),d=p,p=p[h]}}for(o=_.clone(c),p=l+1,f=a[r].length;p<f;p++){var m=a[r][p],y=m.value||0,g=0!==y,v=m.properties.raw;v&&"null"!==v?y=parseFloat(v):"number"!=typeof m.value&&parseFloat(m.value.replace(/[^a-zA-Z 0-9.]+/g,""))&&(y=parseFloat(m.value.replace(/[^a-zA-Z 0-9.]+/g,"")),g=!1),0<y&&g&&(y=m.value&&0<=m.value.indexOf("%")?100*y:y),u.push(y),o.push({f:m.value,v:y})}t&&s.resultset.push(o),p=_.reduce(u,function(e,t){return e+t},0),d[h=null===h?"null":h]=p,p=s}return i&&(this.rawdata=e.data,this.data=s,this.hasProcessed=!0,this.data.height=this.data.resultset.length),s}$(this.el).find(".canvas_wrapper").text("No results").show()}};var Cube=Backbone.Model.extend({initialize:function(e){this.url=Saiku.session.username+"/discover/"+e.key+"/metadata"},parse:function(e){var t=_.template($("#template-dimensions").html(),{dimensions:e.dimensions}),i=_.template($("#template-measures").html(),{measures:e.measures}),s=_.template($("#template-attributes").html(),{cube:e});return this.set({template_measures:i,template_dimensions:t,template_attributes:$(s).html(),data:e}),"undefined"!=typeof localStorage&&localStorage&&localStorage.setItem("cube."+this.get("key"),JSON.stringify(this)),e}}),DimensionList=Backbone.View.extend({events:{"click span":"select","click a":"select","click .parent_dimension ul li a.level":"select_dimension","click .measure":"select_measure","click .addMeasure":"measure_dialog"},initialize:function(e){_.bindAll(this,"render","load_dimension","select_dimension"),this.workspace=e.workspace,this.cube=e.cube},load_dimension:function(){this.template=this.cube.get("template_attributes"),this.render_attributes(),this.workspace.sync_query()},render:function(){if(this.cube&&this.cube.has("template_attributes"))this.load_dimension();else if(this.cube){var e=_.template($("#template-attributes").html());$(this.el).html(e),$(this.el).find(".loading").removeClass("hide"),this.workspace.bind("cube:loaded",this.load_dimension)}else $(this.el).html("Could not load attributes. Please log out and log in again.");return this},render_attributes:function(){$(this.el).html(this.template),isIE&&8>=isIE?$(this.el).show():$(this.el).fadeTo(500,1),$(this.el).find(".addMeasure, .calculated_measures").show(),$(this.el).find(".measure").parent("li").draggable({cancel:".not-draggable",connectToSortable:$(this.workspace.el).find(".fields_list_body.details ul.connectable"),helper:"clone",placeholder:"placeholder",opacity:.6,tolerance:"touch",containment:$(this.workspace.el),cursorAt:{top:10,left:35}}),$(this.el).find(".level").parent("li").draggable({cancel:".not-draggable, .hierarchy",connectToSortable:$(this.workspace.el).find(".fields_list_body.columns > ul.connectable, .fields_list_body.rows > ul.connectable, .fields_list_body.filter > ul.connectable"),containment:$(this.workspace.el),helper:function(e,t){var i=$(e.target).hasClass("d_level")?$(e.target):$(e.target).parent(),s=i.find("a").attr("hierarchy"),a=i.find("a").attr("level");return(i=i.parent().clone().removeClass("d_hierarchy").addClass("hierarchy")).find('li a[hierarchy="'+s+'"]').parent().hide(),i.find('li a[level="'+a+'"]').parent().show(),(s=$('<li class="selection"></li>')).append(i),s},placeholder:"placeholder",opacity:.6,tolerance:"touch",cursorAt:{top:10,left:85}})},select:function(e){return(e=$(e.target).hasClass("root")?$(e.target):$(e.target).parent().find("span")).hasClass("root")&&(e.find("a").toggleClass("folder_collapsed").toggleClass("folder_expand"),e.toggleClass("collapsed").toggleClass("expand"),e.parents("li").find("ul").children("li").toggle()),!1},select_dimension:function(e,t){if("QUERYMODEL"==this.workspace.query.model.type){if(!$(e.target).parent().hasClass("ui-state-disabled")){var i=$(e.target).attr("hierarchy");$(e.target).parent().parent().attr("hierarchycaption");var s=$(e.target).attr("level"),a="ROWS",r=$(e.target).parent().hasClass("dimension-level-calcmember"),a=0<$(this.workspace.el).find(".workspace_fields ul.hierarchy[hierarchy='"+i+"']").length?$(this.workspace.el).find(".workspace_fields ul[hierarchy='"+i+"'] a[level='"+s+"']").parent().show().parents(".fields_list_body").hasClass("rows")?"ROWS":"COLUMNS":(0<$(this.workspace.el).find(".workspace_fields .fields_list[title='ROWS'] ul.hierarchy").length?$(this.workspace.el).find(".workspace_fields .fields_list[title='COLUMNS'] ul.connectable"):$(this.workspace.el).find(".workspace_fields .fields_list[title='ROWS'] ul.connectable")).parents(".fields_list").attr("title");return r?(r=$(e.target).attr("uniquename"),this.workspace.toolbar.$el.find(".group_parents").removeClass("on"),this.workspace.toolbar.group_parents(),this.workspace.query.helper.includeLevelCalculatedMember(a,i,s,r)):this.workspace.query.helper.includeLevel(a,i,s),Saiku.session.trigger("dimensionList:select_dimension",{workspace:this.workspace}),this.workspace.sync_query(),this.workspace.query.run(),e.preventDefault(),!1}e.preventDefault(),e.stopPropagation()}},select_measure:function(e,t){if(!$(e.target).parent().hasClass("ui-state-disabled")){var i={name:(i=$(e.target).parent().clone()).find("a").attr("measure"),type:i.find("a").attr("type")};return this.workspace.query.helper.includeMeasure(i),this.workspace.sync_query(),this.workspace.query.run(),e.preventDefault(),!1}},measure_dialog:function(e,t){new CalculatedMemberModal({workspace:this.workspace,measure:null}).render().open()}}),Toolbar=Backbone.View.extend({tagName:"div",events:{"click a":"call"},template:function(){return _.template($("#template-toolbar").html())({data:this})},initialize:function(){this.logo=Settings.LOGO?"<h1 id='logo_override'><img src='"+Settings.LOGO+"'/></h1>":"<h1 id='logo'><a href='http://www.meteorite.bi/' title='Saiku - Next Generation Open Source Analytics' target='_blank' class='sprite'>Saiku</a></h1>",this.render()},render:function(){return $(this.el).attr("id","toolbar").html(this.template()),Saiku.events.trigger("toolbar:render",{toolbar:this}),this},call:function(e){var t=$(e.target).attr("href").replace("#","");this[t]&&this[t](e),e.preventDefault()},new_query:function(){return"undefined"!=typeof ga&&ga("send","event","MainToolbar","New Query"),Saiku.tabs.add(new Workspace),!1},open_query:function(){var e=_.find(Saiku.tabs._tabs,function(e){return e.content instanceof OpenQuery});return e?e.select():Saiku.tabs.add(new OpenQuery),!1},logout:function(){Saiku.session.logout()},about:function(){return(new AboutModal).render().open(),!1},issue_tracker:function(){return window.open("http://jira.meteorite.bi/"),!1},help:function(){return window.open("http://wiki.meteorite.bi/display/SAIK/Saiku+Documentation"),!1}}),Upgrade=Backbone.View.extend({events:{},initialize:function(e,t){this.workspace=e.workspace,this.workspace.trigger("workspace:toolbar:render",{workspace:this.workspace})},daydiff:function(e,t){return Math.round((t-e)/864e5)},render:function(){if(new License,Settings.BIPLUGIN5){if(void 0!=Saiku.session.get("notice")&&null!=Saiku.session.get("notice")&&""!=Saiku.session.get("notice")&&$(this.el).append("<div><div id='uphead' class='upgradeheader'>Notice:"+Saiku.session.get("notice")+"</div>"),void 0!=Settings.LICENSE.licenseType&&"trial"!=Settings.LICENSE.licenseType&&"Open Source License"!=Settings.LICENSE.licenseType)return this;if(void 0!=Settings.LICENSE&&"trial"===Settings.LICENSE.licenseType){var e=parseFloat(Settings.LICENSE.expiration),e=new Date(e);this.remainingdays=this.daydiff(new Date,e),$(this.el).append("<div><div id='uphead' class='upgradeheader'>You are using a Saiku Enterprise Trial license, you have "+this.remainingdays+" days remaining. <a href='http://www.meteorite.bi/saiku-pricing'>Buy licenses online.</a></div>")}else $(this.el).append("<div><div id='uphead' class='upgradeheader'>You are using Saiku Community Edition, please consider upgrading to <a target='_blank' href='http://meteorite.bi'>Saiku Enterprise</a>, or entering a <a href='http://meteorite.bi/products/saiku/sponsorship'>sponsorship agreement with us</a> to support development. <a href='http://meteorite.bi/products/saiku/community'>Or contribute by joining our community and helping other users!</a></div></div>")}else{if(void 0!=Saiku.session.get("notice")&&null!=Saiku.session.get("notice")&&""!=Saiku.session.get("notice")&&$(this.el).append("<div><div id='uphead' class='upgradeheader'>Notice:"+Saiku.session.get("notice")+"</div>"),void 0!=Settings.LICENSE.licenseType&&"trial"!=Settings.LICENSE.licenseType&&"Open Source License"!=Settings.LICENSE.licenseType)return this;"trial"===Settings.LICENSE.licenseType?(e=parseFloat(Settings.LICENSE.expiration),e=new Date(e),this.remainingdays=this.daydiff(new Date,e),$(this.el).append("<div><div id='uphead' class='upgradeheader'>You are using a Saiku Enterprise Trial license, you have "+this.remainingdays+" days remaining. <a href='http://www.meteorite.bi/saiku-pricing'>Buy licenses online.</a></div>")):$(this.el).append("<div><div id='uphead' class='upgradeheader'>You are using Saiku Community Edition, please consider upgrading to <a target='_blank' href='http://meteorite.bi'>Saiku Enterprise</a>, or entering a <a href='http://meteorite.bi/products/saiku/sponsorship'>sponsorship agreement with us</a> to support development. <a href='http://meteorite.bi/products/saiku/community'>Or contribute by joining our community and helping other users!</a></div></div>")}return this},call:function(e){}}),Modal=Backbone.View.extend({tagName:"div",className:"dialog",type:"modal",message:"Put content here",options:{autoOpen:!1,modal:!0,title:"Modal dialog",resizable:!1,draggable:!0},events:{"click a":"call"},buttons:[{text:"OK",method:"close"}],template:function(){return _.template("<div class='dialog_icon'></div><div class='dialog_body'><%= message %></div><div class='dialog_footer'><% _.each(buttons, function(button) { %><a class='form_button i18n' href='#<%= button.method %>'>&nbsp;<%= button.text %>&nbsp;</a><% }); %><div class='dialog_response'></div></div>")(this)},initialize:function(e){_.extend(this,e),_.bindAll(this,"call"),_.extend(this,Backbone.Events)},render:function(){$(this.el).html(this.template()).addClass("dialog_"+this.type).dialog(this.options);var e=$(".ui-dialog-title");return e.html(this.options.title),e.addClass("i18n"),Saiku.i18n.translate(),this},call:function(e){var t=e.target.hash.replace("#","");return!$(e.target).hasClass("disabled_toolbar")&&this[t]&&this[t](e),!1},open:function(){return $(this.el).dialog("open"),this.trigger("open",{modal:this}),this},close:function(){return $(this.el).dialog("destroy").remove(),$(this.el).remove(),!1}});$.ui.dialog.prototype._allowInteraction=function(e){return!!$(e.target).closest(".ui-dialog, .ui-datepicker, .sp-input").length};var MDXModal=Modal.extend({type:"mdx",initialize:function(e){this.options.title="MDX",this.message=_.template("<textarea><%= mdx %></textarea>")(e),this.bind("open",function(){$(this.el).parents(".ui-dialog").css({width:"550px"})})}}),SelectionsModal=Modal.extend({type:"selections",buttons:[{text:"OK",method:"save"},{text:"Open Date Filter",method:"open_date_filter"},{text:"Cancel",method:"close"}],events:{"click a":"call","click .search_term":"search_members","click .clear_search":"clear_search","change #show_unique":"show_unique_action","change #use_result":"use_result_action","dblclick .selection_options li.option_value label":"click_move_selection","click li.all_options":"click_all_member_selection","change #show_totals":"show_totals_action"},show_unique_option:!1,use_result_option:Settings.MEMBERS_FROM_RESULT,show_totals_option:"",members_limit:Settings.MEMBERS_LIMIT,members_search_limit:Settings.MEMBERS_SEARCH_LIMIT,members_search_server:!1,selection_type:"INCLUSION",initialize:function(e){_.extend(this,e),this.options.title="<span class='i18n'>Selections for</span> "+this.name,this.message="Fetching members...",this.query=e.workspace.query,this.selected_members=[],this.available_members=[],_.bindAll(this,"fetch_members","populate","finished","get_members","use_result_action","show_totals_action"),this.axis="undefined",e.axis?(this.axis=e.axis,"FILTER"==e.axis&&(this.use_result_option=!1)):(e.target.parents(".fields_list_body").hasClass("rows")&&(this.axis="ROWS"),e.target.parents(".fields_list_body").hasClass("columns")&&(this.axis="COLUMNS"),e.target.parents(".fields_list_body").hasClass("filter")&&(this.axis="FILTER",this.use_result_option=!1)),this.bind("open",this.post_render),this.render(),$(this.el).parent().find(".ui-dialog-titlebar-close").bind("click",this.finished),this.member=new Member({},{cube:e.workspace.selected_cube,dimension:e.key}),$(this.el).find(".dialog_body").html(_.template($("#template-selections").html())(this));var t=this.member.level,i=null;(e=this.workspace.query.helper.getHierarchy(this.member.hierarchy))&&e.levels.hasOwnProperty(t)&&(i=e.levels[t]),"DateFilterModal"===this.source&&_.has(i,"selection")&&0===i.selection.members.length||"DateFilterModal"===this.source&&1===_.size(i)&&_.has(i,"name")?this.$el.find(".dialog_footer a:nth-child(2)").show():this.$el.find(".dialog_footer a:nth-child(2)").hide(),Settings.ALLOW_PARAMETERS&&(i&&(t=i.selection?i.selection.parameterName:null)&&$(this.el).find("input.parameter").val(t),$(this.el).find(".parameter").removeClass("hide")),(t=$(this.el).find("#show_totals")).val(""),1<_.size(e.levels)&&i&&i.hasOwnProperty("aggregators")&&i.aggregators?(0<i.aggregators.length&&(this.show_totals_option=i.aggregators[0]),t.removeAttr("disabled")):(t.attr("disabled",!0),this.show_totals_option=""),t.val(this.show_totals_option),t.removeAttr("disabled"),$(this.el).find("#use_result").attr("checked",this.use_result_option),$(this.el).find(".search_limit").text(this.members_search_limit),$(this.el).find(".members_limit").text(this.members_limit),this.get_members()},open_date_filter:function(e){e.preventDefault(),new DateFilterModal({dimension:this.objDateFilter.dimension,hierarchy:this.objDateFilter.hierarchy,target:this.target,name:this.name,data:this.objDateFilter.data,analyzerDateFormat:this.objDateFilter.analyzerDateFormat,dimHier:this.objDateFilter.dimHier,key:this.key,workspace:this.workspace}).open(),this.$el.dialog("destroy").remove()},show_totals_action:function(e){this.show_totals_option=$(e.target).val()},get_members:function(){var e=this,t="/result/metadata/hierarchies/"+encodeURIComponent(this.member.hierarchy)+"/levels/"+encodeURIComponent(this.member.level);this.search_path=t,e.workspace.block('<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">'+e.message+"</span> "),this.workspace.query.action.gett(t,{success:this.fetch_members,error:function(){e.workspace.unblock()},data:{result:this.use_result_option,searchlimit:this.members_limit}})},clear_search:function(){$(this.el).find(".filterbox").val(""),this.get_members()},search_members:function(){var e=this,t=$(this.el).find(".filterbox").val();if(!t)return!1;e.workspace.block('<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Searching for members matching:</span> '+t),e.workspace.query.action.gett(e.search_path,{async:!1,success:function(t,i){i&&0<i.length&&(e.available_members=i),e.populate()},error:function(){e.workspace.unblock()},data:{search:t,searchlimit:e.members_search_limit}})},fetch_members:function(e,t){t&&0<t.length&&(this.available_members=t),this.populate()},populate:function(e,t){var i=this;i.workspace.unblock(),this.members_search_server=this.available_members.length>=this.members_limit||0==this.available_members.length,i.show_unique_option=!1,$(this.el).find(".options #show_unique").attr("checked",!1),$(this.el).find(".items_size").text(this.available_members.length),this.members_search_server?$(this.el).find(".warning").text("More items available than listed. Pre-Filter on server."):$(this.el).find(".warning").text("");a=i.member.level;(r=i.workspace.query.helper.getHierarchy(i.member.hierarchy))&&r.levels.hasOwnProperty(a)&&(this.selected_members=r.levels[a].selection?r.levels[a].selection.members:[],this.selection_type=r.levels[a].selection?r.levels[a].selection.type:"INCLUSION");for(var s=[],a=0,r=this.selected_members.length;a<r;a++)s.push(this.selected_members[a].caption);0==$(this.el).find(".used_selections .selection_options li.option_value").length&&((r=$(this.el).find(".used_selections .selection_options")).empty(),a=_.template($("#template-selections-options").html())({options:this.selected_members}),$(r).html(a)),this.available_members=_.select(this.available_members,function(e){return-1===s.indexOf(e.caption)}),0<this.available_members.length&&((r=$(this.el).find(".available_selections .selection_options")).empty(),a=_.template($("#template-selections-options").html())({options:this.available_members}),$(r).html(a)),0<$(i.el).find(".selection_options.ui-selectable").length&&$(i.el).find(".selection_options").selectable("destroy"),$(i.el).find(".selection_options").selectable({distance:20,filter:"li",stop:function(e,t){$(i.el).find(".selection_options li.ui-selected input").each(function(e,t){t&&t.hasAttribute("checked")?t.checked=!0:$(t).attr("checked",!0),$(t).parents(".selection_options").find("li.all_options input").prop("checked",!0)}),$(i.el).find(".selection_options li.ui-selected").removeClass("ui-selected")}}),$(this.el).find(".filterbox").autocomplete({minLength:1,delay:200,appendTo:".autocomplete",source:function(e,t){var s=0==i.show_unique_option?"caption":"name";t($.map(i.available_members,function(t){if(-1<t[s].toLowerCase().indexOf(e.term.toLowerCase()))return{label:0==i.show_unique_option?t.caption:t.uniqueName,value:0==i.show_unique_option?t.uniqueName:t.caption}}))},select:function(e,t){encodeURIComponent(t.item.value);var s=t.item.label,a=0==i.show_unique_option?t.item.value:t.item.label,r=0==i.show_unique_option?t.item.label:t.item.value;$(i.el).find('.available_selections .selection_options input[value="'+encodeURIComponent(a)+'"]').parent().remove(),$(i.el).find('.used_selections .selection_options input[value="'+encodeURIComponent(a)+'"]').parent().remove(),s='<li class="option_value"><input type="checkbox" class="check_option" value="'+encodeURIComponent(a)+'" label="'+encodeURIComponent(r)+'">'+s+"</input></li>",$(s).appendTo($(i.el).find(".used_selections .selection_options ul")),$(i.el).find(".filterbox").val(""),t.item.value=""},close:function(e,t){},open:function(e,t){}}),$(this.el).find(".filterbox").autocomplete("enable"),"EXCLUSION"===this.selection_type?($(this.el).find(".selection_type_inclusion").prop("checked",!1),$(this.el).find(".selection_type_exclusion").prop("checked",!0)):($(this.el).find(".selection_type_inclusion").prop("checked",!0),$(this.el).find(".selection_type_exclusion").prop("checked",!1)),Saiku.i18n.translate(),Saiku.ui.unblock()},post_render:function(e){var t=($(window).width()-1e3)/2,i=1040>$(window).width()?$(window).width():1040;$(e.modal.el).parents(".ui-dialog").css({width:i,left:"inherit",margin:"0",height:530}).offset({left:t}),$("#filter_selections").attr("disabled",!1),$(this.el).find("a[href=#save]").focus(),$(this.el).find("a[href=#save]").blur()},move_selection:function(e){e.preventDefault();var t=-1!==(e=$(e.target).attr("id")).indexOf("add")?$(this.el).find(".used_selections .selection_options ul"):$(this.el).find(".available_selections .selection_options ul"),i=-1!==e.indexOf("add")?$(this.el).find(".available_selections .selection_options ul"):$(this.el).find(".used_selections .selection_options ul");(-1!==e.indexOf("all")?i.find("li.option_value input").parent():i.find("li.option_value input:checked").parent()).detach().appendTo(t),$(this.el).find(".selection_options ul li.option_value input:checked").prop("checked",!1),$(this.el).find(".selection_options li.all_options input").prop("checked",!1)},updown_selection:function(e){return e.preventDefault(),!1},click_all_member_selection:function(e,t){$(e.currentTarget).find("input").is(":checked")?$(e.currentTarget).parent().find("li.option_value input").prop("checked",!0):$(e.currentTarget).parent().find("li.option_value input").removeAttr("checked")},click_move_selection:function(e,t){e.preventDefault();var i=$(e.target).parent().parent().parent().parent().hasClass("used_selections")?".available_selections":".used_selections";$(e.target).parent().appendTo($(this.el).find(i+" .selection_options ul"))},show_unique_action:function(){this.show_unique_option=!this.show_unique_option,!0===this.show_unique_option?($(this.el).find(".available_selections, .used_selections").addClass("unique"),$(this.el).find(".available_selections, .used_selections").removeClass("caption")):($(this.el).find(".available_selections, .used_selections").addClass("caption"),$(this.el).find(".available_selections, .used_selections").removeClass("unique"))},use_result_action:function(){this.use_result_option=!this.use_result_option,this.get_members()},save:function(){t=$("<div>Saving...</div>");$(this.el).find(".dialog_body").children().hide(),$(this.el).find(".dialog_body").prepend(t);var e=decodeURIComponent(this.member.hierarchy),t=decodeURIComponent(this.member.level),e=this.workspace.query.helper.getHierarchy(e),i=[],s=this.show_totals_option;0!==$(this.el).find(".used_selections input").length&&$(this.el).find(".used_selections .option_value input").each(function(e,t){var s=$(t).val(),a=$(t).attr("label");i.push({uniqueName:decodeURIComponent(s),caption:decodeURIComponent(a)})});var a=$("#parameter").val();e&&e.levels.hasOwnProperty(t)&&(e.levels[t].aggregators=[],s&&e.levels[t].aggregators.push(s),s=$(this.el).find("input.selection_type:checked").val(),e.levels[t].selection={type:s||"INCLUSION",members:i},Settings.ALLOW_PARAMETERS&&a&&(e.levels[t].selection.parameterName=a,this.workspace.query.helper.model())),this.finished()},finished:function(){$("#filter_selections").remove(),this.available_members=null,$(this.el).find(".filterbox").autocomplete("destroy").remove(),$(this.el).dialog("destroy"),$(this.el).remove(),this.query.run()}}),DrillthroughModal=Modal.extend({type:"drillthrough",buttons:[{text:"Ok",method:"ok"},{text:"Cancel",method:"close"}],events:{"click .collapsed":"select","click .expand":"select","click .folder_collapsed":"select","click .folder_expanded":"select","click .dialog_footer a":"call","click .parent_dimension input":"select_dimension","click .measure_tree input":"select_measure","click input.all_measures":"select_all_measures","click input.all_dimensions":"select_all_dimensions"},allMeasures:!1,templateContent:function(){return $("#template-drillthrough").html()},initialize:function(e){_.extend(this,e),this.options.title=e.title,this.query=e.workspace.query,this.position=e.position,this.action=e.action,Saiku.ui.unblock(),_.bindAll(this,"ok","drilled","template"),this.render(),$(this.el).find(".dialog_body").html(_.template(this.templateContent())(this)),$(this.el).find(".maxrows").val(this.maxrows),this.query.get("schema"),e=$("#template-drillthrough-list").html();var t=Saiku.session.sessionworkspace.cube[a],i=null,s=null,a=this.workspace.selected_cube;t&&t.has("data")&&(i=t.get("data").dimensions,s=t.get("data").measures),t&&i&&s||("undefined"!=typeof localStorage&&localStorage&&null!==localStorage.getItem("cube."+a)?Saiku.session.sessionworkspace.cube[a]=new Cube(JSON.parse(localStorage.getItem("cube."+a))):(Saiku.session.sessionworkspace.cube[a]=new Cube({key:a}),Saiku.session.sessionworkspace.cube[a].fetch({async:!1})),i=Saiku.session.sessionworkspace.cube[a].get("data").dimensions,s=Saiku.session.sessionworkspace.cube[a].get("data").measures),a=_.template($("#template-drillthrough-dimensions").html())({dimensions:i}),s=_.template($("#template-drillthrough-measures").html())({measures:s,allMeasures:this.allMeasures}),$(e).appendTo($(this.el).find(".dialog_body")),$(this.el).find(".sidebar").height($("body").height()/2+$("body").height()/6),$(this.el).find(".sidebar").width(380),$(this.el).find(".dimension_tree").html("").append($(a)),$(this.el).find(".measure_tree").html("").append($(s)),Saiku.i18n.translate()},select:function(e){return(e=$(e.target).hasClass("root")?$(e.target):$(e.target).parent().find("span")).hasClass("root")&&(e.find("a").toggleClass("folder_collapsed").toggleClass("folder_expand"),e.toggleClass("collapsed").toggleClass("expand"),e.parents("li").find("ul").children("li").toggle()),!1},select_dimension:function(e){var t=(e=$(e.target)).is(":checked");e.parent().find("input").attr("checked",t)},select_all_dimensions:function(e){e=$(e.target).is(":checked"),$(this.el).find(".dimension_tree input").attr("checked",e)},select_all_measures:function(e){e=$(e.target).is(":checked"),$(this.el).find(".measure_tree input").attr("checked",e)},select_measure:function(e){$(e.target).is(":checked")},ok:function(){"undefined"!=typeof ga&&ga("send","event","Drillthrough","Execute");var e=$("<div>Drilling through...</div>");$(this.el).find(".dialog_body").children().hide(),$(this.el).find(".dialog_body").prepend(e);var t="";$(this.el).find(".check_level:checked").each(function(e){0<e&&(t+=", "),t+=$(this).val()});var i;return i="?maxrows="+(e=$(this.el).find(".maxrows").val())+(void 0!==this.position?"&position="+this.position:""),i+="&returns="+t,"export"==this.action?(e=Settings.REST_URL+"api/query/"+this.query.id+"/drillthrough/export/csv"+i,this.close(),window.open(e)):"table"==this.action&&(Saiku.ui.block("Executing drillthrough..."),this.query.action.gett("/drillthrough",{data:{position:this.position,maxrows:e,returns:t},success:this.drilled}),this.close()),!1},drilled:function(e,t){var i="",i=null!=t&&null!=t.error?safe_tags_replace(t.error):(new SaikuTableRenderer).render(t);Saiku.ui.unblock(),i='<div id="fancy_results" class="workspace_results" style="overflow:visible">'+i+"</div>",this.remove(),$.fancybox(i,{autoDimensions:!1,autoScale:!1,height:$("body").height()-100,width:$("body").width()-100,transitionIn:"none",transitionOut:"none"})},finished:function(){$(this.el).dialog("destroy").remove(),this.query.run()}}),DrillAcrossModal=DrillthroughModal.extend({allMeasures:!0,templateContent:function(){return $("#template-drillacross").html()},ok:function(){"undefined"!=typeof ga&&ga("send","event","DrillAcross","Execute");var e=this,t={};return $(this.el).find(".check_level:checked").each(function(e){e=$(this).attr("key"),t[e]||(t[e]=[]),t[e].push($(this).val())}),Saiku.ui.block("Executing drillacross..."),this.query.action.post("/drillacross",{data:{position:this.position,drill:JSON.stringify(t)},success:function(t,i){e.workspace.query.parse(i),e.workspace.unblock(),e.workspace.sync_query(),e.workspace.query.run()},error:function(t,i,s){e.workspace.unblock(),t="",i&&i.hasOwnProperty("responseText")&&(t=i.responseText),alert("Error drilling across. Check logs! "+t)}}),this.close(),!1}}),PermissionsModal=Modal.extend({type:"permissions",buttons:[{text:"Ok",method:"ok"},{text:"Cancel",method:"close"}],events:{"click .add_role":"add_role","click .remove_acl":"remove_acl","submit form":"add_role","click a":"call","click input.private":"keep_private"},rolesacl:{},acltype:"SECURED",initialize:function(e){_.extend(this,e),this.options.title=e.title,this.file=e.file,this.rolesacl={},Saiku.ui.unblock(),_.bindAll(this,"ok","add_role","remove_acl"),this.bind("open",Saiku.i18n.translate()),this.render(),$(this.el).find(".dialog_body").html(_.template($("#template-permissions").html())(this)),$(this.el).find(".filterbox").autocomplete({minLength:1,source:Saiku.session.roles}).data("autocomplete"),(e=new RepositoryAclObject({file:this.file})).fetch({async:!1});var t=void 0===e.get("roles")||null===e.get("roles")?{}:e.get("roles");this.rolesacl=t,t=_.template($("#template-permissions-rolelist").html())({roles:t}),$(this.el).find(".rolelist").html(t),t=void 0===e.get("owner")||null===e.get("owner")?"":e.get("owner"),null!==(e=void 0===e.get("type")||null===e.get("type")?null:e.get("type"))&&"PRIVATE"==e&&($(this.el).find(".private_owner .owner").text(t),$(this.el).find(".private_owner").show()),$(this.el).find(".i18n").i18n(Saiku.i18n.po_file)},add_role:function(e){if(e.preventDefault(),"PRIVATE"==this.acltype)return!1;var t=[],i="",s=0;return(e=$(this.el).find(".filterbox").val())&&0<e.length&&($(this.el).find(".acl:checked").each(function(e){0<e&&(i+=", "),s++,i+=$(this).val(),t.push($(this).val())}),0<s?(this.rolesacl[e]=t,$("<option value='"+e+"'>"+e+" ["+i+"]</option>").appendTo($(this.el).find(".select_roles")),e=$(this.el).find(".filterbox").val("")):alert("You need to chose at least one ACL method for this role.")),!1},keep_private:function(e){$(this.el).find("input.private").is(":checked")?($(this.el).find(".permissions").addClass("disabled_toolbar"),$("input.acl, input.filterbox, input.add_role, input.remove_acl").prop("disabled",!0),this.acltype="PRIVATE"):($(this.el).find(".permissions").removeClass("disabled_toolbar"),$("input.acl, input.filterbox, input.add_role, input.remove_acl").prop("disabled",!1),this.acltype="SECURED")},remove_acl:function(e){var t=this;return"PRIVATE"!=this.acltype&&($(this.el).find(".select_roles option:selected").each(function(e){delete t.rolesacl[$(this).val()]}),$(this.el).find(".select_roles option:selected").remove(),!1)},ok:function(){var e=this.close(),t={},t="PRIVATE"==this.acltype?{type:"PRIVATE",owner:Saiku.session.username}:{type:"SECURED",roles:this.rolesacl,owner:Saiku.session.username};return new RepositoryAclObject({file:this.file,acl:JSON.stringify(t)}).save({success:e}),!1}}),DemoLoginForm=Modal.extend({type:"login",message:"<form id='demo_form'><label for='email'>Email:</label><input type='text' id='email' name='email' value='' /></form>",buttons:[{text:"Start Demo",method:"login"}],events:{"click a":"call","submit form ":"login"},initialize:function(e){_.extend(this,e),_.bindAll(this,"adjust"),this.options.title=Settings.VERSION,this.bind("open",this.adjust),this.session.login(Settings.USERNAME,Settings.PASSWORD),$(this.el).dialog("close")},adjust:function(){$(this.el).parent().find(".ui-dialog-titlebar-close").hide(),$(this.el).find("#email").select().focus()},login:function(e){var t=Settings.USERNAME,i=Settings.PASSWORD,s=$(this.el).find("#email").val();return s&&(new logger({url:Settings.TELEMETRY_SERVER+"/input/demo"}).log({email:s,created_at:Math.round((new Date).getTime()/1e3)}),$(this.el).dialog("close"),this.session.login(t,i)),e&&(e.preventDefault(),e.stopPropagation()),!0}}),LoginForm=Modal.extend({type:"login",message:_.template('<form id="login_form"><label for="username" class="i18n">Username</label><input type="text" id="username" name="username"><label for="password" class="i18n">Password</label><input type="password" id="password" name="password"><% if (Settings.EVALUATION_PANEL_LOGIN) { %><div class="eval-panel"><a href="#eval_login" class="i18n" id="eval-login">Evaluation Login</a><div class="eval-panel-user clearfix" hidden><ul><li class="i18n">Administrator</li><li class="i18n">Username: admin</li><li class="i18n">Password: admin</li></ul></div></div><% } %></form>')(),options:{autoOpen:!1,closeOnEscape:!1,modal:!0,title:Settings.VERSION,resizable:!1,draggable:!1},buttons:[{text:"Login",method:"login"},{text:"Upload License",method:"upload_license"}],events:{"click .dialog_footer a":"call","keyup #login_form input":"check","click #eval-login":"show_panel_user","click .clearlink":"clear_login"},initialize:function(e){_.extend(this,e),_.bindAll(this,"adjust"),this.bind("open",this.adjust)},adjust:function(){this.$el.parent().find(".ui-dialog-titlebar-close").hide(),this.$el.find("#username").focus(),this.$el.find(".dialog_footer").find('a[href="#upload_license"]').hide()},check:function(e){13===e.which&&this.login()},login:function(){var e=this.$el.find("#username").val(),t=this.$el.find("#password").val();return this.$el.dialog("close"),this.session.login(e,t,this.$el),!0},clear_login:function(e){window.open("/clear.html","_blank")},setMessage:function(e){this.$el.find(".dialog_body").html(this.message)},setError:function(e){this.$el.find(".dialog_response").html(e),"license expired"===e&&this.$el.find(".dialog_footer").find('a[href="#upload_license"]').show(),this.$el.find(".clearlink").unbind()},show_panel_user:function(e){e.preventDefault(),$(e.currentTarget).next().slideToggle("fast")},upload_license:function(e){e.preventDefault(),""===(e=window.location).search?window.open(e.href+"upload.html","_self"):window.open(e.origin+"/upload.html","_self")}}),AboutModal=Modal.extend({type:"info",events:{"click a":"close"},message:Settings.VERSION+'<br><a href="http://saiku.meteorite.bi" target="_blank">http://saiku.meteorite.bi</a><br><br><h2>License Type</h2><span class="licensetype"/> - Expires: <span class="licenseexpr"/><br/>Number of users: <span class="licenseuserlimit"/><br/>Licensed to: <span class="licensename"/> - <span class="licenseemail"/><br/><div id="licensetable"><h2>Unlicenced User Quota</h2><br/><div class="table-wrapper"><div class="table-scroll"><table><thead><tr><th><span class="text">Username</span></th><th><span class="text">Logins Remaining</span></th></tr></thead><tbody><tr id="quotareplace"/></tbody></table></div></div></div><strong><a href="www.meteorite.bi/saiku-pricing" target="_blank">Order more licenses here</a></strong><br/>Powered by <img src="images/src/meteorite_free.png" width="20px"> <a href="http://www.meteorite.bi/consulting/" target="_blank">www.meteorite.bi</a><br/>',initialize:function(){this.options.title="About "+Settings.VERSION},ObjectLength_Modern:function(e){return Object.keys(e).length},ObjectLength_Legacy:function(e){var t,i=0;for(t in e)e.hasOwnProperty(t)&&++i;return i},render:function(){$(this.el).html(this.template()).addClass("dialog_"+this.type).dialog(this.options);var e=$(".ui-dialog-title");if(e.html(this.options.title),e.addClass("i18n"),Saiku.i18n.translate(),license=new License,void 0!=Settings.LICENSE.expiration&&(yourEpoch=parseFloat(Settings.LICENSE.expiration),e=new Date(yourEpoch),$(this.el).find(".licenseexpr").text(e.toLocaleDateString())),void 0!=Settings.LICENSE.licenseType?($(this.el).find(".licensetype").text(Settings.LICENSE.licenseType),$(this.el).find(".licensename").text(Settings.LICENSE.name),$(this.el).find(".licenseuserlimit").text(Settings.LICENSE.userLimit),$(this.el).find(".licenseemail").text(Settings.LICENSE.email)):$(this.el).find(".licensetype").text("Open Source License"),ObjectLength=Object.keys?this.ObjectLength_Modern:this.ObjectLength_Legacy,void 0!=Settings.LICENSEQUOTA&&0<ObjectLength(Settings.LICENSEQUOTA)){var t="",i=!1;$.each(Settings.LICENSEQUOTA,function(){var e="";$.each(this,function(t,i){e+="<td>"+i+"</td>"}),t+='<tr class="'+(i?"odd":"even")+'">'+e+"</tr>",i=!i}),$(this.el).find("#quotareplace").replaceWith(t)}else $(this.el).find("#licensetable").hide();return this},close:function(e){"#close"===e.target.hash&&e.preventDefault(),this.$el.dialog("destroy").remove()}}),OverwriteModal=Modal.extend({type:"info",message:"Are you sure you want to overwrite the existing query?",buttons:[{text:"Yes",method:"save"},{text:"No",method:"close"}],initialize:function(e){_.extend(this,e),this.options.title="Warning",this.queryname=this.name,this.queryfolder=this.foldername,this.parentobj=this.parent},dummy:function(){return!0},save:function(e){e.preventDefault(),this.parentobj.save_remote(this.queryname,this.queryfolder,this.parentobj),$(this.el).dialog("destroy").remove()}}),AddFolderModal=Modal.extend({type:"save",closeText:"Save",events:{"click .form_button":"save","submit form":"save"},buttons:[{text:"OK",method:"save"}],initialize:function(e){this.success=e.success,this.path=e.path,this.message="<form id='add_folder'><label class='i18n' for='name'>To add a new folder, please type a name in the text box below:</label><input type='text' class='newfolder' name='name' /></form>",_.extend(this.options,{title:"Add Folder"}),isIE&&9>isIE&&$(this.el).find("form").on("submit",this.save)},save:function(e){return e.preventDefault(),e=$(this.el).find('input[name="name"]').val(),new SavedQuery({file:this.path+e,name:e}).save({},{success:this.success,dataType:"text",error:this.error}),this.close(),!1},error:function(){$(this.el).find("dialog_body").html("Could not add new folder")}}),FilterModal=Modal.extend({type:"filter",closeText:"Save",events:{"submit form":"save","click .dialog_footer a":"call"},buttons:[{text:"OK",method:"save"},{text:"Cancel",method:"close"}],message:"",expression_text:function(){var e="<form id='custom_filter'><table border='0px'>";return"Order"==this.expressionType&&(e+="<tr><td class='col1'>Sort Type: <select id='fun'><option>ASC</option><option>BASC</option><option>DESC</option><option>BDESC</option> </select></td></tr>"),e+="<tr><td class='col1'>"+this.expressionType+" MDX Expression:</td></tr><tr><td class='col1'><textarea class='filter_expression'></textarea></td></tr></table></form>"},expression:" ",expressonType:"",initialize:function(e){var t=this;this.axis=e.axis,this.query=e.query,this.success=e.success,this.expression=e.expression,this.expressionType=e.expressionType,_.bindAll(this,"save","expression_text"),_.extend(this.options,{title:"Custom "+this.expressionType+" for "+this.axis}),this.message=this.expression_text(this.expressionType),this.bind("open",function(){$(this.el).find("textarea").val("").val(t.expression)}),isIE&&9>isIE&&$(this.el).find("form").on("submit",this.save)},save:function(e){return e.preventDefault(),this.expression=$(this.el).find("textarea").val(),e="",void 0!==this.expression&&this.expression&&""!==this.expression?("Order"==this.expressionType?(e=$("#fun").val(),this.success(e,this.expression)):this.success(this.expression),this.close()):(e+="You have to enter a MDX expression for the "+this.expressionType+" function! ",alert(e)),!1},error:function(){$(this.el).find("dialog_body").html("Could not add new folder")}}),CustomFilterModal=Modal.extend({type:"filter",closeText:"Save",events:{"submit form":"save","change .function":"switch_function","change .type":"switch_type","click .dialog_footer a":"call"},buttons:[{text:"OK",method:"save"},{text:"Cancel",method:"close"}],message:"<form id='custom_filter'><table border='0px'><tr><td class='col0'>Define Filter:</td><td class='col1'><select class='function'><option>Select a Function...</option><option value='TopCount'>TopCount</option><option value='TopPercent'>TopPercent</option><option value='TopSum'>TopSum</option><option value='BottomCount'>BottomCount</option><option value='BottomPercent'>BottomPercent</option><option value='BottomSum'>BottomSum</option></select></td></tr><tr class='filter_details hide'><td><span class='ntype'></span></td><td><input class='n' /></td></tr><tr class='filter_details hide'><td>Sort by:</td><td><select class='type'><option value='measure'>Measure</option><option value='custom'>MDX Expression</option></select></td></tr><tr class='filter_details hide'><td>&nbsp;</td><td class='sortingoption'>&nbsp;</td></table></form>",func:null,func_type:"Measure",n:"",sortliteral:"",measure_list:null,initialize:function(e){var t=this;this.axis=e.axis,this.measures=e.measures,this.query=e.query,this.success=e.success,this.func=e.func,this.n=e.n,this.sortliteral=e.sortliteral,this.isMdx=!0,_.bindAll(this,"build_measures_list","save"),this.measure_list=this.build_measures_list(),_.extend(this.options,{title:"Custom Filter for "+this.axis}),this.bind("open",function(){null!==t.func&&($(t.el).find(".function").val(t.func),t.switch_function({target:$(t.el).find(".function")}),$(t.el).find(".n").val(t.n),!0===t.isMdx&&null!==t.sortliteral&&($(this.el).find(".type").val("custom"),$(this.el).find(".sortingoption").html("").html("<textarea class='sortliteral'>"+t.sortliteral+"</textarea>")))}),isIE&&9>isIE&&$(this.el).find("form").on("submit",this.save)},build_measures_list:function(){var e=this;if(null!==this.measure_list)return"";var t="<select class='sortliteral'>";return _.each(this.measures,function(i){var s="";i.uniqueName==e.sortliteral&&(s=" selected ",e.isMdx=!1),t+="<option "+s+"value='"+i.uniqueName+"'>"+i.caption+"</option>"}),t+="</select>"},switch_function:function(e){return e=$(e.target).val(),void 0===e||""===e?$(this.el).find(".filter_details").hide():(e=e.replace("Top","").replace("Bottom",""),$(this.el).find(".ntype").html(e+":"),$(this.el).find(".filter_details").show(),$(this.el).find(".sortingoption").html("").html(this.measure_list)),!1},switch_type:function(e){return"measure"==$(e.target).val()?$(this.el).find(".sortingoption").html("").html(this.measure_list):$(this.el).find(".sortingoption").html("").html("<textarea class='sortliteral' />"),!1},save:function(e){return e.preventDefault(),this.func=$(this.el).find(".function").val(),this.n=parseInt($(this.el).find(".n").val()),this.sortliteral=$(this.el).find(".sortliteral").val(),e="",void 0!==this.n&&this.n||(e+="You have to enter a numeric for N! "),void 0!==this.sortliteral&&this.sortliteral&&""!==this.sortliteral||(e+="You have to enter a MDX expression for the sort literal! "),""!==e?alert(e):(this.success(this.func,this.n,this.sortliteral),this.close()),!1},error:function(){$(this.el).find("dialog_body").html("Could not add new folder")}}),CalculatedMemberModal=Modal.extend({type:"calculated-member",template_modal:_.template('<div class="cms-container-group"><div class="calculated-measure-group"><h4>Calculated Measures:</h4><div class="cms-box"><table class="cms-list measures-list"><%= tplCalculatedMeasures %></table></div></div><div class="calculated-member-group"><h4>Calculated Members:</h4><div class="cms-box"><table class="cms-list members-list"><%= tplCalculatedMembers %></table></div></div></div><div class="cms-container-form"><form class="form-group-inline" data-action="cad"><label for="cms-name">Name:</label><input type="text" id="cms-name" autofocus><label for="cms-measure">Measure:</label><select id="cms-measure"><option value="" selected>-- Add a measure in formula --</option><% _(measures).each(function(measure) { %><option value="<%= measure.uniqueName %>"><%= measure.name %></option><% }); %></select><label for="<%= idEditor %>">Formula:</label><div class="formula-editor" id="<%= idEditor %>"></div><div class="btn-group-math"><a class="form_button btn-math" href="#add_math_operator_formula" data-math="+">&nbsp;+&nbsp;</a><a class="form_button btn-math" href="#add_math_operator_formula" data-math="-">&nbsp;-&nbsp;</a><a class="form_button btn-math" href="#add_math_operator_formula" data-math="*">&nbsp;*&nbsp;</a><a class="form_button btn-math" href="#add_math_operator_formula" data-math="/">&nbsp;/&nbsp;</a><a class="form_button btn-math" href="#add_math_operator_formula" data-math="(">&nbsp;(&nbsp;</a><a class="form_button btn-math" href="#add_math_operator_formula" data-math=")">&nbsp;)&nbsp;</a><a class="form_button btn-math" href="#add_math_operator_formula" data-math="and">&nbsp;and&nbsp;</a><a class="form_button btn-math" href="#add_math_operator_formula" data-math="or">&nbsp;or&nbsp;</a><a class="form_button btn-math" href="#add_math_operator_formula" data-math="not">&nbsp;not&nbsp;</a></div><div class="cms-function"><label for="cms-function">Functions:</label> <input type="button" class="form_button growthBtn" style="padding-bottom: 18px;" value="Growth"           title="Calculate difference. Good to calculate previous period growth "   id="growthBtn" >  </input>  <input type="button" class="form_button formatBtn" style="padding-bottom: 18px;" value="Format %" id="formatBtn"  title="Post-process step: format this view as percentage of rows, columns or grand total. " /></div><label for="cms-dimension">Dimension:</label><select id="cms-dimension"><option value="" selected>-- Select an existing dimension --</option><% if (measures.length > 0) { %><optgroup label="<%= dataMeasures.name %>"><option value="<%= dataMeasures.uniqueName %>" data-type="calcmeasure"><%= dataMeasures.name %></option></optgroup><% } %><% _(dimensions).each(function(dimension) { %><optgroup label="<%= dimension.name %>"><% _(dimension.hierarchies).each(function(hierarchy) { %><option value="<%= hierarchy.uniqueName %>" data-dimension="<%= dimension.name %>" data-type="calcmember"><%= hierarchy.name %></option><% }); %></optgroup><% }); %></select><label for="cms-format">Format:</label><select id="cms-format"><option value="" selected>-- Select a format --</option><option value="custom">Custom</option><option value="#,##0.00">#,##0.00 Decimal</option><option value="#,###">#,### Integer</option><option value="##.##%">##.##% Decimal percentage</option><option value="##%">##% Interger percentage</option><option value="mmmm dd yyyy">mmmm dd yyyy Month Day Year</option><option value="mmmm yyyy">mmmm yyyy Month Year</option><option value="yyyy-mm-dd">yyyy-mm-dd ISO format date</option><option value="yyyy-mm-dd hh:mi:ss">yyyy-mm-dd hh:mi:ss Date and time</option><option value="##h ##m">##h ##m Minutes</option></select><div class="div-format-custom"><label for="cms-format-custom">Format Custom:</label><input type="text" id="cms-format-custom" value="" placeholder="Add a format custom"></div></form></div>'),buttons:[{text:"Add",method:"save"},{text:"Edit",method:"save"},{text:"New",method:"new"},{text:"Cancel",method:"close"}],events:{"click  .dialog_footer a":"call","blur   #cms-name":"trigger_input_name","change #cms-measure":"add_measure_formula","click  .btn-math":"add_math_operator_formula","change #cms-format":"type_format","click  .btn-action-edit":"edit_cms","click  .btn-action-del":"show_del_cms","click .form_button.growthBtn":"openGrowthModal","click .form_button.formatBtn":"openFormatModal"},initialize:function(e){_.extend(this,e),this.workspace=e.workspace,this.options.title="Calculated Member",this.id=_.uniqueId("cms-formula-");var t=this,i=this.workspace.selected_cube;e=Saiku.session.sessionworkspace.cube[i].get("data").measures;var i=Saiku.session.sessionworkspace.cube[i].get("data").dimensions,s=this.workspace.query.helper.getCalculatedMeasures(),a=this.workspace.query.helper.getCalculatedMembers(),s=this.template_cms(s,"calcmeasure"),a=this.template_cms(a,"calcmember"),r={name:e?e[0].dimensionUniqueName.replace(/[\[\]]/gi,""):null,uniqueName:e?e[0].hierarchyUniqueName:null};Saiku.ui.block("Loading..."),this.message=this.template_modal({tplCalculatedMeasures:s,tplCalculatedMembers:a,idEditor:this.id,measures:e,dataMeasures:r,dimensions:i}),this.bind("open",function(){var e=this.$el.find(".cms-container-form").height();this.post_render(),this.$el.find(".dialog_footer a:nth-child(2)").hide(),this.$el.find(".dialog_footer a:nth-child(3)").hide(),this.$el.find(".cms-container-group").height(e),this.$el.find(".calculated-measure-group").height(e/2),this.$el.find(".calculated-member-group").height(e/2),_.defer(function(){t.start_editor()})})},post_render:function(){var e=($("body").height()-500)/2*100/$("body").height(),t=($("body").width()-800)/2*100/$("body").width();this.$el.dialog("option","position","center"),this.$el.parents(".ui-dialog").css({width:"800px",top:e+"%",left:t+"%"})},start_editor:function(){this.formulaEditor=ace.edit(this.id),this.formulaEditor.getSession().setMode("ace/mode/text"),this.formulaEditor.getSession().setUseWrapMode(!0),Saiku.ui.unblock()},template_cms:function(e,t){var i=this,s="";return e&&0!==e.length?"calcmeasure"===t?_.each(e,function(e){s+='<tr class="row-cms-'+i.replace_cms(e.name)+'"><td class="cms-name">'+e.name+'</td><td class="cms-actions"><a class="edit button sprite btn-action-edit" href="#edit_cms" data-name="'+e.name+'" data-type="calcmeasure"></a><a class="delete button sprite btn-action-del" href="#show_del_cms" data-name="'+e.name+'" data-type="calcmeasure"></a></td></tr>'}):_.each(e,function(e){s+='<tr class="row-cms-'+i.replace_cms(e.name)+'"><td class="cms-name">'+e.name+'</td><td class="cms-actions"><a class="edit button sprite btn-action-edit" href="#edit_cms" data-name="'+e.name+'" data-type="calcmember"></a><a class="delete button sprite btn-action-del" href="#show_del_cms" data-name="'+e.name+'" data-type="calcmember"></a></td></tr>'}):s="calcmeasure"===t?'<p class="msg-no-cms">No calculated measures created</p>':'<p class="msg-no-cms">No calculated members created</p>',s},replace_cms:function(e){return e=e.replace(/\s/g,"-")},edit_cms:function(e){e.preventDefault();var t=this,i=$(e.currentTarget);e="calcmeasure"===i.data("type")?this.workspace.query.helper.getCalculatedMeasures():this.workspace.query.helper.getCalculatedMembers(),this.$el.find(".cms-actions a").removeClass("on"),_.each(e,function(e){e.name===i.data("name")&&(i.addClass("on"),t.$el.find("#cms-name").val(e.name),t.formulaEditor.setValue(e.formula),t.$el.find("#cms-dimension").val(e.hierarchyName),0!==$('#cms-format option[value="'+e.properties.FORMAT_STRING+'"]').length||void 0===e.properties.FORMAT_STRING&&0===$('#cms-format option[value="'+e.properties.FORMAT_STRING+'"]').length?(t.$el.find("#cms-format").val(e.properties.FORMAT_STRING),t.$el.find(".div-format-custom").hide()):(t.$el.find("#cms-format").prop("selectedIndex",1),t.$el.find(".div-format-custom").show(),t.$el.find("#cms-format-custom").val(e.properties.FORMAT_STRING)),t.$el.find(".form-group-inline").data("action","edit"),t.$el.find(".form-group-inline").data("oldcms",e.name))}),this.$el.find(".dialog_footer a:nth-child(1)").hide(),this.$el.find(".dialog_footer a:nth-child(2)").show(),this.$el.find(".dialog_footer a:nth-child(3)").show()},show_del_cms:function(e){e.preventDefault();var t="calcmeasure"===(e=$(e.currentTarget)).data("type")?"measure":"member";this.$delcms=e,this.new(),new WarningModal({title:"Delete Member",message:"You want to delete this calculated "+t+" <b>"+e.data("name")+"</b>?",okay:this.del_cms,okayobj:this}).render().open(),this.$el.parents(".ui-dialog").find(".ui-dialog-title").text("Calculated Member")},del_cms:function(e){e.$delcms.parent().closest(".row-cms-"+e.replace_cms(e.$delcms.data("name"))).remove(),"calcmeasure"===e.$delcms.data("type")?e.workspace.query.helper.removeCalculatedMeasure(e.$delcms.data("name")):e.workspace.query.helper.removeCalculatedMember(e.$delcms.data("name")),e.workspace.sync_query(),e.workspace.drop_zones.set_measures(),e.new(),e.check_len_cms(e.$delcms.data("type"))||("calcmeasure"===e.$delcms.data("type")?e.$el.find(".measures-list").append('<p class="msg-no-cms">No calculated measures created</p>'):e.$el.find(".members-list").append('<p class="msg-no-cms">No calculated members created</p>'))},trigger_input_name:function(){var e=this.$el.find(".form-group-inline").data("action"),t=this.$el.find("#cms-name").val(),i=this.$el.find("#cms-dimension option:selected").data("type"),s="";"calcmeasure"===i?this.check_name_cms(i,t)&&"cad"===e&&(s="Exists a measure with the same name added!"):"calcmember"===i?this.check_name_cms(i,t)&&"cad"===e&&(s="Exists a member with the same name added!"):this.check_name_cms(i,t)&&"cad"===e&&(s="Exists a measure or member with the same name added!"),""!==s&&alert(s)},check_name_cms:function(e,t){a="calcmeasure"===e?this.workspace.query.helper.getCalculatedMeasures():this.workspace.query.helper.getCalculatedMembers();if(null===e||void 0===e)var i=this.workspace.query.helper.getCalculatedMeasures(),s=this.workspace.query.helper.getCalculatedMembers(),a=[],a=a.concat(i,s);for(;0<a.length;)return a[0].name===t},check_len_cms:function(e){return 0<("calcmeasure"===e?this.workspace.query.helper.getCalculatedMeasures():this.workspace.query.helper.getCalculatedMembers()).length},reset_form:function(){this.$el.find("#cms-name").val(""),this.$el.find("#cms-measure").prop("selectedIndex",0),this.formulaEditor.setValue(""),this.$el.find("#cms-dimension").prop("selectedIndex",0),this.$el.find("#cms-format").prop("selectedIndex",0),this.$el.find(".div-format-custom").hide(),this.$el.find("#cms-format-custom").val("")},reset_dropdown:function(){this.$el.find("#cms-measure").prop("selectedIndex",0)},add_measure_formula:function(e){e.preventDefault(),e=this.$el.find("#cms-measure option:selected").val();var t=this.formulaEditor.getValue();this.formulaEditor.setValue(t+e),this.reset_dropdown()},add_math_operator_formula:function(e){e.preventDefault(),e=$(e.currentTarget);var t=(t=this.formulaEditor.getValue())+" "+e.data("math")+" ";this.formulaEditor.setValue(t)},type_format:function(e){e.preventDefault(),"custom"===this.$el.find("#cms-format option:selected").val()?this.$el.find(".div-format-custom").show():this.$el.find(".div-format-custom").hide()},new:function(e){e&&e.preventDefault(),this.$el.find(".cms-actions a").removeClass("on"),this.$el.find(".form-group-inline").data("action","cad"),this.$el.find(".form-group-inline").data("oldcms",""),this.$el.find(".dialog_footer a:nth-child(1)").show(),this.$el.find(".dialog_footer a:nth-child(2)").hide(),this.$el.find(".dialog_footer a:nth-child(3)").hide(),this.reset_form()},openGrowthModal:function(e){e=function(e){var t=[];return _.each(e,function(e){t.push(e.name)},this),t}(this.workspace.query.helper.model().queryModel.axes.ROWS.hierarchies.concat(this.workspace.query.helper.model().queryModel.axes.COLUMNS.hierarchies));var t=Saiku.session.sessionworkspace.cube[this.workspace.selected_cube].get("data").measures;this.close(),new GrowthModal({workspace:this.workspace,measures:t,dimensions:e}).render().open()},openFormatModal:function(e){e=this.workspace.query.helper.model().queryModel.details.measures,this.close(),new FormatAsPercentageModal({workspace:this.workspace,measures:e}).render().open()},save:function(e){e.preventDefault(),$(e.currentTarget),e=this.$el.find(".form-group-inline").data("oldcms");var t=this.$el.find("#cms-name").val(),i=this.formulaEditor.getValue(),s=this.$el.find("#cms-dimension option:selected").val(),a=this.$el.find("#cms-dimension option:selected").text(),r=this.$el.find("#cms-dimension option:selected").data("dimension"),n=this.$el.find("#cms-dimension option:selected").data("type"),o=this.$el.find("#cms-format option:selected").val(),l=this.$el.find(".form-group-inline").data("action"),d="",o="custom"===o?this.$el.find("#cms-format-custom").val():this.$el.find("#cms-format option:selected").val();void 0!==t&&""!==t&&t||(d+="You have to enter a name for the member! "),void 0!==i&&""!==i&&i||(d+="You have to enter a MDX formula for the calculated member! "),void 0!==s&&""!==s&&s||(d+="You have to choose a dimension for the calculated member! "),""!==d?alert(d):("calcmeasure"===n?(t={name:t,formula:i,properties:{},uniqueName:t,hierarchyName:s},o&&(t.properties.FORMAT_STRING=o),"cad"===l?(this.workspace.query.helper.addCalculatedMeasure(t),this.workspace.sync_query()):(this.workspace.query.helper.editCalculatedMeasure(e,t),this.workspace.sync_query(),this.workspace.drop_zones.set_measures())):(t={name:t,dimension:r,uniqueName:"["+a+"].["+t+"]",caption:t,properties:{},formula:i,hierarchyName:s},o&&(t.properties.FORMAT_STRING=o),"cad"===l?(this.workspace.query.helper.addCalculatedMember(t),this.workspace.sync_query()):(this.workspace.query.helper.removeLevelCalculatedMember(s,"["+a+"].["+e+"]"),this.workspace.query.helper.editCalculatedMember(e,t),this.workspace.sync_query(),this.workspace.drop_zones.set_measures())),this.$el.dialog("close"))}}),DataSourcesModal=Modal.extend({type:"data-sources",message:'<form class="form-group-inline"><label for="data-sources">Select a data source:</label><select id="data-sources"></select></form>',buttons:[{text:"Add",method:"add"},{text:"Cancel",method:"close"}],events:{"click .dialog_footer a":"call"},initialize:function(e){_.extend(this,e),this.options.title="Data Sources",new DataSources({},{dialog:this}).fetch(),this.bind("open")},option_template:function(e){return _.template('<option value="">-- Select --</option><% _.each(obj, function(value) { %><option value="<%= value.name %>"><%= value.name %></option><% }); %>')(e)},callback:function(e){var t=this.option_template(e);this.dataSources=e,this.$el.find("#data-sources").append(t)},populate_form:function(e){var t,i=this.dataSources,s=i.length;for(t=0;t<s;t++)i[t].name===e&&(this.dialog.$el.find(this.formElements.url).val(i[t].url),this.dialog.$el.find(this.formElements.driver).val(i[t].driver),this.dialog.$el.find(this.formElements.username).val(i[t].username),this.dialog.$el.find(this.formElements.password).val(i[t].password))},add:function(e){e.preventDefault(),(e=this.$el.find("#data-sources option:selected").val())&&this.populate_form(e),this.$el.dialog("close")}}),QueryToolbar=Backbone.View.extend({events:{"click .options a.button":"call","click .renderer a.button":"switch_render_button"},chart:{},render_mode:"table",spark_mode:null,initialize:function(e){this.workspace=e.workspace,_.bindAll(this,"call","activate_buttons","spark_bar","spark_line","render_row_viz","run_row_viz","switch_render_button"),this.render_mode="table",this.spark_mode=null,this.workspace.bind("query:new",this.activate_buttons),this.workspace.bind("query:result",this.activate_buttons),this.workspace.bind("table:rendered",this.run_row_viz)},activate_buttons:function(e){void 0!==e&&null!==e&&($(this.el).find("a").removeClass("disabled_toolbar"),e.data||$(this.el).find("a.export_button, a.stats").addClass("disabled_toolbar"),isIE&&$(this.el).find("a.export_button").addClass("disabled_toolbar"))},template:function(){var e=$("#template-query-toolbar").html()||"";return _.template(e)()},render:function(){return $(this.el).html(this.template()),$(this.el).find("render_table").addClass("on"),$(this.el).find("ul.table").show(),this},switch_render_button:function(e){var t=$(e.target);if(e.preventDefault(),$(e.target).hasClass("disabled_toolbar"))return!1;t.parent().siblings().find(".on").removeClass("on"),e=0<$(this.el).find("ul.chart li a.on:first").size()?$(this.el).find("ul.chart li a.on:first").attr("href").replace("#",""):null,t.hasClass("render_chart")?"map"===e?(t=(t=this.workspace.query.getProperty("saiku.ui.map.options"))?t.mapDefinition.type:"",this.switch_render("map"),this.workspace.query.setProperty("saiku.ui.render.mode","map"),this.workspace.query.setProperty("saiku.ui.render.type",t)):(this.switch_render("chart"),this.workspace.query.setProperty("saiku.ui.render.mode","chart"),null!==(t=0<$(this.el).find("ul.chart li a.on:first").size()?$(this.el).find("ul.chart li a.on:first").attr("href").replace("#",""):null)&&("charteditor"===t&&(t=$(this.el).find("ul.chart li").not(".chart_editor").find("a.on").attr("href").replace("#","")),this.workspace.query.setProperty("saiku.ui.render.type",t))):(this.switch_render("table"),this.workspace.query.setProperty("saiku.ui.render.mode","table"),this.workspace.query.setProperty("saiku.ui.render.type",this.spark_mode))},switch_render:function(e){return e=void 0!==e?e.toLowerCase():"table",$(this.el).find("ul.renderer a.on").removeClass("on"),$(this.el).find("ul.renderer a.render_"+e).addClass("on"),"chart"==e?($(this.el).find("ul.chart").show(),$(this.el).find("ul.table").hide(),this.render_mode="chart",$(this.workspace.el).find(".workspace_results").children().hide(),$(this.workspace.chart.el).find(".canvas_wrapper").hide(),this.workspace.chart.show(),this.workspace.set_class_charteditor()):"map"===e?(this.$el.find("ul.renderer a.render_chart").addClass("on"),this.$el.find("ul.chart").show(),this.$el.find("ul.table").hide(),this.render_mode="map",this.workspace.$el.find(".workspace_results").children().hide(),this.workspace.chart.$el.find(".canvas_wrapper").hide(),this.workspace.chart.show()):($(this.el).find("ul.chart").hide(),$(this.el).find("ul.table").show(),$(this.el).find("ul.table .stats").removeClass("on"),$(this.workspace.el).find(".workspace_results").children().hide(),$(this.workspace.el).find(".workspace_results .table_wrapper").show(),$(this.workspace.chart.el).hide().children().hide(),this.render_mode="table",this.workspace.query.result.hasRun()&&this.workspace.table.render({data:this.workspace.query.result.lastresult()})),!1},call:function(e){var t=$(e.target).hasClass("button")?$(e.target):$(e.target).parent();if(!t.hasClass("disabled_toolbar")){var i=t.attr("href").replace("#","");if("table"==this.render_mode&&this[i])this[i](e);else if("chart"==this.render_mode){if(this.workspace.chart.$el.find(".canvas_wrapper").find(".map-render").data("action","querytoolbar"),t.hasClass("chartoption")){var s={mapDefinition:{}};this.workspace.query.setProperty("saiku.ui.map.options",s),this.workspace.query.setProperty("saiku.ui.render.mode","chart"),this.workspace.querytoolbar.$el.find('ul.chart [href="#export_button"]').parent().removeAttr("disabled"),this.workspace.querytoolbar.$el.find("ul.chart > li#charteditor").removeAttr("disabled"),this.workspace.querytoolbar.$el.find('ul.chart [href="#map"]').removeClass("on"),t.parent().siblings().find(".chartoption.on").removeClass("on"),t.addClass("on"),this.workspace.set_class_charteditor()}"export_button"==i?this.workspace.chart[i](e):(this.workspace.chart.renderer.switch_chart(i),this.workspace.query.setProperty("saiku.ui.render.type",i))}else"map"===this.render_mode&&"map"!==i&&(this.workspace.chart.$el.find(".canvas_wrapper").find(".map-render").data("action","querytoolbar"),t.hasClass("chartoption")&&(s={mapDefinition:{}},this.workspace.query.setProperty("saiku.ui.map.options",s),this.workspace.query.setProperty("saiku.ui.render.mode","chart"),this.workspace.querytoolbar.$el.find('ul.chart [href="#export_button"]').parent().removeAttr("disabled"),this.workspace.querytoolbar.$el.find("ul.chart > li#charteditor").removeAttr("disabled"),this.workspace.querytoolbar.$el.find('ul.chart [href="#map"]').removeClass("on"),t.parent().siblings().find(".chartoption.on").removeClass("on"),t.addClass("on")),"export_button"==i?this.workspace.chart[i](e):(this.workspace.chart.renderer.switch_chart(i),this.workspace.query.setProperty("saiku.ui.render.type",i)))}return e.preventDefault(),!1},spark_bar:function(){$(this.el).find("ul.table .spark_bar").toggleClass("on"),$(this.el).find("ul.table .spark_line").removeClass("on"),$(this.workspace.table.el).find("td.spark").remove(),$(this.el).find("ul.table .spark_bar").hasClass("on")?(this.spark_mode="spark_bar",this.workspace.query.setProperty("saiku.ui.render.type","spark_bar"),_.delay(this.render_row_viz,10,"spark_bar")):this.spark_mode=null},spark_line:function(){$(this.el).find("ul.table .spark_line").toggleClass("on"),$(this.el).find("ul.table .spark_bar").removeClass("on"),$(this.workspace.table.el).find("td.spark").remove(),$(this.el).find("ul.table .spark_line").hasClass("on")?(this.spark_mode="spark_line",this.workspace.query.setProperty("saiku.ui.render.type","spark_line"),_.delay(this.render_row_viz,10,"spark_line")):this.spark_mode=null},run_row_viz:function(e){"table"==this.render_mode&&null!==this.spark_mode&&this.render_row_viz(this.spark_mode)},render_row_viz:function(e){$(this.workspace.table.el).find("tr").each(function(t,i){var s=[];$(i).find("td.data div").each(function(e,t){var i=void 0!==(i=$(t).attr("alt"))&&""!==i&&null!==i&&"undefined"!=i?parseFloat(i):0;s.push(i)}),$("<td class='data spark'>&nbsp;<div id='chart"+t+"'></div></td>").appendTo($(i));var a=9*s.length;if(0<s.length){var r=(new pv.Panel).canvas("chart"+t).height(12).width(a).margin(0);"spark_bar"==e?r.add(pv.Bar).data(s).left(pv.Scale.linear(0,s.length).range(0,a).by(pv.index)).height(pv.Scale.linear(0,_.max(s)).range(0,12)).width(6).bottom(0):"spark_line"==e&&(a/=2,r.width(a),r.add(pv.Line).data(s).left(pv.Scale.linear(0,s.length-1).range(0,a).by(pv.index)).bottom(pv.Scale.linear(s).range(0,12)).strokeStyle("#000").lineWidth(1)),r.render()}})}}),WorkspaceToolbar=Backbone.View.extend({enabled:!1,events:{"click a":"call"},initialize:function(e){this.workspace=e.workspace,_.bindAll(this,"call","reflect_properties","run_query","swap_axes_on_dropzones","display_drillthrough","clicked_cell_drillthrough_export","clicked_cell_drillacross","clicked_cell_drillthrough","activate_buttons","switch_to_mdx","post_mdx_transform","toggle_fields_action","group_parents"),this.workspace.bind("workspace:toolbar:render",this.translate),this.workspace.bind("properties:loaded",this.reflect_properties),this.workspace.trigger("workspace:toolbar:render",{workspace:this.workspace}),this.workspace.bind("query:new",this.activate_buttons),this.workspace.bind("query:result",this.activate_buttons)},activate_buttons:function(e){null!==e&&e.data&&e.data.cellset&&0<e.data.cellset.length?($(e.workspace.toolbar.el).find(".button").removeClass("disabled_toolbar"),$(e.workspace.el).find("td.data").removeClass("cellhighlight").unbind("click"),$(e.workspace.el).find(".table_mode").removeClass("on")):($(e.workspace.toolbar.el).find(".button").addClass("disabled_toolbar").removeClass("on"),$(e.workspace.el).find(".fields_list .disabled_toolbar").removeClass("disabled_toolbar"),$(e.workspace.toolbar.el).find(".about, .new, .open, .save, .edit, .run,.auto,.non_empty,.toggle_fields,.toggle_sidebar,.switch_to_mdx, .mdx").removeClass("disabled_toolbar")),this.reflect_properties()},template:function(){var e=$("#template-workspace-toolbar").html()||"";return _.template(e)()},render:function(){return $(this.el).html(this.template()),this},translate:function(){},call:function(e){e.preventDefault();var t=e.target.hash.replace("#","");return!$(e.target).hasClass("disabled_toolbar")&&this[t]&&this[t](e),!1},reflect_properties:function(){var e=this.workspace.query.model.properties?this.workspace.query.model.properties:Settings.QUERY_PROPERTIES;!0===e["saiku.olap.query.nonempty"]&&$(this.el).find(".non_empty").addClass("on"),!0===e["saiku.olap.query.automatic_execution"]&&$(this.el).find(".auto").addClass("on"),!0!==e["saiku.olap.query.drillthrough"]&&$(this.el).find(".drillthrough, .drillthrough_export").addClass("disabled_toolbar"),!0!==e["org.saiku.query.explain"]&&$(this.el).find(".explain_query").addClass("disabled_toolbar"),!0!==e["org.saiku.connection.scenario"]?$(this.el).find(".query_scenario").addClass("disabled_toolbar"):($(this.el).find(".query_scenario").removeClass("disabled_toolbar"),$(this.el).find(".drillthrough, .drillthrough_export").addClass("disabled_toolbar")),"true"!=e["saiku.olap.query.limit"]&&!0!==e["saiku.olap.query.filter"]||$(this.workspace.el).find(".fields_list_header").addClass("limit"),"undefined"!==this.workspace.query.getProperty("saiku.olap.result.formatter")&&"flattened"==this.workspace.query.getProperty("saiku.olap.result.formatter")&&($(this.el).find(".group_parents").hasClass("on")||$(this.el).find(".group_parents").addClass("on")),0<$(this.workspace.el).find(".workspace_results tbody.ui-selectable").length&&$(this.el).find(".zoom_mode").addClass("on"),$(this.el).find(".spark_bar, .spark_line").removeClass("on"),$(this.el).find("a.edit").removeClass("disabled_toolbar"),"VIEW"==Settings.MODE||this.workspace.isReadOnly?($(this.el).find("a.edit").hide(),$(this.el).find("a.save").hide()):("view"==this.workspace.viewState?$(this.el).find("a.edit").removeClass("on"):$(this.el).find("a.edit").addClass("on"),$(this.el).find("a.edit").show("normal"))},new_query:function(e){return"undefined"!=typeof ga&&ga("send","event","Toolbar","New Query"),this.workspace.switch_view_state("edit"),this.workspace.new_query(),!1},edit_query:function(e){$(e.target).toggleClass("on"),$(e.target).hasClass("on")?this.workspace.switch_view_state("edit"):this.workspace.switch_view_state("view")},save_query:function(e){this.workspace.query&&(void 0!==this.editor&&(e=this.editor.getValue(),this.workspace.query.model.mdx=e),new SaveQuery({query:this.workspace.query}).render().open())},open_query:function(e){(new OpenDialog).render().open()},run_query:function(e){this.workspace.query.run(!0)},automatic_execution:function(e){var t=!this.workspace.query.getProperty("saiku.olap.query.automatic_execution");this.workspace.query.setProperty("saiku.olap.query.automatic_execution",t),t?$(e.target).addClass("on"):$(e.target).removeClass("on")},toggle_fields:function(e){e&&$(this.el).find(".toggle_fields").toggleClass("on"),$(this.el).find(".toggle_fields").hasClass("on")?this.toggle_fields_action("show"):this.toggle_fields_action("hide")},toggle_fields_action:function(e,t){"show"==e&&$(".workspace_editor").is(":visible")||"hide"==e&&$(".workspace_editor").is(":hidden")||(t?($(".workspace_editor").css("height",""),$(".workspace_editor").is(":hidden")?$(".workspace_editor").show():$(".workspace_editor").hide()):"hide"==e?$(this.workspace.el).find(".workspace_editor").hide():$(this.workspace.el).find(".workspace_editor").show())},about:function(){return(new AboutModal).render().open(),!1},toggle_sidebar:function(){this.workspace.toggle_sidebar()},group_parents:function(e){e&&$(e.target).toggleClass("on"),this.$el.find(".group_parents").hasClass("on")?this.workspace.query.setProperty("saiku.olap.result.formatter","flattened"):this.workspace.query.setProperty("saiku.olap.result.formatter","flat"),this.workspace.query.run()},non_empty:function(e){var t=!this.workspace.query.getProperty("saiku.olap.query.nonempty");this.workspace.query.helper.nonEmpty(t),this.workspace.query.setProperty("saiku.olap.query.nonempty",t),$(e.target).toggleClass("on"),this.workspace.query.run()},swap_axis:function(e){$(this.workspace.el).find(".workspace_results table").html(""),this.workspace.query.helper.swapAxes(),this.workspace.sync_query(),this.workspace.query.run(!0)},check_modes:function(e){if(void 0!==e&&null!==e)if(0<$(this.workspace.el).find(".workspace_results tbody.ui-selectable").length&&$(this.workspace.el).find(".workspace_results tbody").selectable("destroy"),$(e).hasClass("on")){if($(e).hasClass("drillthrough_export"))$(this.workspace.el).find("td.data").addClass("cellhighlight").unbind("click").click(this.clicked_cell_drillthrough_export),$(this.workspace.el).find(".query_scenario, .drillthrough, .zoom_mode, .drillacross").removeClass("on");else if($(e).hasClass("drillthrough"))$(this.workspace.el).find("td.data").addClass("cellhighlight").unbind("click").click(this.clicked_cell_drillthrough),$(this.workspace.el).find(".query_scenario, .drillthrough_export, .zoom_mode, .drillacross").removeClass("on");else if($(e).hasClass("query_scenario"))this.workspace.query.scenario.activate(),$(this.workspace.el).find(".drillthrough, .drillthrough_export, .zoom_mode, .drillacross").removeClass("on");else if($(e).hasClass("drillacross"))$(this.workspace.el).find("td.data").addClass("cellhighlight").unbind("click").click(this.clicked_cell_drillacross),$(this.workspace.el).find(".query_scenario, .drillthrough, .drillthrough_export, .zoom_mode").removeClass("on");else if($(e).hasClass("zoom_mode")){var t=this;$(t.workspace.el).find(".workspace_results tbody").selectable({filter:"td",stop:function(e,i){var s=[];$(t.workspace.el).find(".workspace_results").find("td.ui-selected div").each(function(e,t){var i=$(t).attr("rel");i&&s.push(i)}),$(t.workspace.el).find(".workspace_results").find(".ui-selected").removeClass(".ui-selected"),0<(s=_.uniq(s)).length&&t.workspace.query.action.put("/zoomin",{success:function(e,i){t.workspace.query.parse(i),t.workspace.unblock(),t.workspace.sync_query(),Saiku.ui.unblock(),t.workspace.query.run()},data:{selections:JSON.stringify(s)}})}}),$(this.workspace.el).find(".drillthrough, .drillthrough_export, .query_scenario, .drillacross, .about").removeClass("on")}}else $(this.workspace.el).find("td.data").removeClass("cellhighlight").unbind("click"),$(this.workspace.el).find(".table_mode").removeClass("on"),this.workspace.query.run()},query_scenario:function(e){$(e.target).toggleClass("on"),this.check_modes($(e.target))},zoom_mode:function(e){$(e.target).toggleClass("on"),this.check_modes($(e.target))},drillacross:function(e){$(e.target).toggleClass("on"),this.check_modes($(e.target))},drillthrough:function(e){$(e.target).toggleClass("on"),this.check_modes($(e.target))},display_drillthrough:function(e,t){this.workspace.table.render({data:t}),Saiku.ui.unblock()},export_drillthrough:function(e){$(e.target).toggleClass("on"),this.check_modes($(e.target))},clicked_cell_drillacross:function(e){$target=$(e.target).hasClass("data")?$(e.target).find("div"):$(e.target),e=$target.attr("rel"),new DrillAcrossModal({workspace:this.workspace,title:"Drill Across",action:"export",position:e,query:this.workspace.query}).open()},clicked_cell_drillthrough_export:function(e){$target=$(e.target).hasClass("data")?$(e.target).find("div"):$(e.target),e=$target.attr("rel"),new DrillthroughModal({workspace:this.workspace,maxrows:1e4,title:"Drill-Through to CSV",action:"export",position:e,query:this.workspace.query}).open()},clicked_cell_drillthrough:function(e){$target=$(e.target).hasClass("data")?$(e.target).find("div"):$(e.target),e=$target.attr("rel"),new DrillthroughModal({workspace:this.workspace,maxrows:200,title:"Drill-Through",action:"table",success:this.display_drillthrough,position:e,query:this.workspace.query}).open()},swap_axes_on_dropzones:function(e,t){this.workspace.query.parse(t),this.workspace.unblock(),this.workspace.sync_query(),Saiku.ui.unblock(),this.workspace.unblock(),this.workspace.sync_query(),Saiku.ui.unblock()},show_mdx:function(e){new MDXModal({mdx:this.workspace.query.model.mdx}).render().open()},workspace_titles:function(e){new TitlesModal({query:this.workspace.query}).render().open()},export_xls:function(e){void 0!=this.workspace.query.name?(e=this.workspace.query.name.substring(this.workspace.query.name.lastIndexOf("/")+1).slice(0,-5),window.location=Settings.REST_URL+this.workspace.query.url()+"/export/xls/"+this.workspace.query.getProperty("saiku.olap.result.formatter")+"?exportname="+encodeURIComponent(e)+"xls"):window.location=Settings.REST_URL+this.workspace.query.url()+"/export/xls/"+this.workspace.query.getProperty("saiku.olap.result.formatter")},export_csv:function(e){void 0!=this.workspace.query.name?(e=this.workspace.query.name.substring(this.workspace.query.name.lastIndexOf("/")+1).slice(0,-6),window.location=Settings.REST_URL+this.workspace.query.url()+"/export/csv/"+this.workspace.query.getProperty("saiku.olap.result.formatter")+"?exportname="+encodeURIComponent(e)):window.location=Settings.REST_URL+this.workspace.query.url()+"/export/csv/"+this.workspace.query.getProperty("saiku.olap.result.formatter")},export_pdf:function(e){void 0!=this.workspace.query.name?(e=this.workspace.query.name.substring(this.workspace.query.name.lastIndexOf("/")+1).slice(0,-6),window.location=Settings.REST_URL+this.workspace.query.url()+"/export/pdf/"+this.workspace.query.getProperty("saiku.olap.result.formatter")+"?exportname="+encodeURIComponent(e)):window.location=Settings.REST_URL+this.workspace.query.url()+"/export/pdf/"+this.workspace.query.getProperty("saiku.olap.result.formatter")},switch_to_mdx:function(e){var t=this;if($(this.workspace.el).find(".workspace_fields").addClass("hide"),$(this.el).find(".auto, .query_scenario, .buckets, .non_empty, .swap_axis, .mdx, .switch_to_mdx, .zoom_mode, .drillacross").parent().hide(),0<$(this.workspace.el).find(".workspace_results tbody.ui-selectable").length&&$(this.workspace.el).find(".workspace_results tbody").selectable("destroy"),$(this.el).find(".run").attr("href","#run_mdx"),$(this.el).find(".run, .save, .open, .new, .edit").removeClass("disabled_toolbar"),"view"!=Settings.MODE&&"table"!=Settings.MODE&&!this.workspace.isReadOnly){$mdx_editor=$(this.workspace.el).find(".mdx_input"),$(this.workspace.el).find(".workspace_editor .mdx_input, .workspace_editor .editor_info, .workspace_editor").removeClass("hide").show(),this.editor=ace.edit("mdx_editor"),this.editor.setShowPrintMargin(!1),this.editor.setFontSize(11),this.editor.commands.addCommand({name:"runmdx",bindKey:{win:"Ctrl-Enter",mac:"Command-Enter"},exec:function(e){t.run_mdx()},readOnly:!0}),e=function(){var e=t.editor.getCursorPosition();$mdx_editor.parent().find(".editor_info").html("&nbsp; "+(e.row+1)+", "+e.column)},this.editor.on("changeSelection",e),e();var i=function(){var e=$(document).height()/3,e=Math.floor(e/t.editor.renderer.lineHeight),e=((t.editor.getSession().getScreenLength()>e?e:t.editor.getSession().getScreenLength())+1)*t.editor.renderer.lineHeight+t.editor.renderer.scrollBar.getWidth();$mdx_editor.height(e.toString()+"px"),t.editor.resize(),t.workspace.adjust()};(e=function(){var e=t.editor.session;if(t.editor.resize(),e.setUseWrapMode(!0),e.getUseWrapMode()){var i=t.editor.renderer.characterWidth,s=t.editor.renderer.scroller.clientWidth;0<s&&e.setWrapLimitRange(null,parseInt(s/i,10))}})(),i(),t.editor.focus(),t.editor.clearSelection(),t.editor.getSession().setValue(""),t.editor.getSession().on("change",i),$(window).resize(e),t.editor.on("changeSelection",i),t.editor.on("focus",function(e){return i(),!0}),t.editor.on("blur",function(e){return 100<$(t.workspace.el).find(".mdx_input").height()&&$(t.workspace.el).find(".mdx_input").height(100),t.editor.resize(),t.workspace.adjust(),!0}),this.editor.getSession().setMode("ace/mode/text")}this.workspace.dimension_list&&$(this.workspace.el).find(".sidebar_inner ul li a").css({fontWeight:"normal"}).parent("li").removeClass("ui-draggable ui-draggable-disabled ui-state-disabled"),this.activate_buttons({workspace:this.workspace}),$(this.workspace.toolbar.el).find(".run").removeClass("disabled_toolbar"),$(this.workspace.table.el).empty(),this.workspace.adjust(),this.post_mdx_transform()},conditional_format:function(e){var t=this,i=[],s=function(e){for(var t=[],i=[],s=[],a=e.length-1;a>=0;a--)""!=e[a].child?e[a].string+=e[e[a].child].string+")":e[a].string+="'|#|style=\"#fff\"')";return $.each(e,function(e,a){$.inArray(a.measure,s)<0&&(s.push(a.measure),mainFmtStr="MEMBER [Measures].["+a.measure+" ] AS '[Measures].["+a.measure+"]',FORMAT_STRING = "+a.string,columnName="[Measures].["+a.measure+"_cond]",t.push(mainFmtStr),i.push(columnName))}),[t,i]};$.each(this.workspace.query.model.queryModel.details.measures,function(e,t){i.push(t.name)});var a=this.workspace.query.model;if(!queryFormatted){var r=[];r=a.mdx.split("-------------------"),oldmdx=r[1],this.workspace.query.model.mdx=r[0],this.workspace.query.model.type="MDX",queryFormatted=!0}"QUERYMODEL"==a.type&&(a.mdx.indexOf("FORMAT_STRING")<0&&(oldmdx=a.mdx),oldqueryModel=a.queryModel),condFormatDialog(this.workspace.query.model,function(e){conditions=e;var a=[],r=[],n=[],o=[];$.each(e,function(e,t){var i={};i.string="",i.child="",i.measure=t.measure;var s=$.inArray(t.measure,a);if(s<0)r.push(e),a.push(t.measure);else if(""!=n[r[s]].child){var l=n[r[s]].child;n[l].child=e}else n[r[s]].child=e;t.value=parseFloat(t.value),t.value2=parseFloat(t.value2),t.hideVal&&("><"==t.condition&&t.value<t.value2?o.push("([Measures].["+t.measure+"] <"+t.value+") OR ([Measures].["+t.measure+"] > "+t.value2+")"):"><"==t.condition&&t.value>t.value2?o.push("([Measures].["+t.measure+"] >"+t.value+") OR ([Measures].["+t.measure+"] < "+t.value2+")"):">"==t.condition?o.push("[Measures].["+t.measure+"] <"+t.value):">="==t.condition?o.push("[Measures].["+t.measure+"] <="+t.value):"<"==t.condition?o.push("[Measures].["+t.measure+"] >"+t.value):"<="==t.condition?o.push("[Measures].["+t.measure+"] >="+t.value):"="==t.condition?o.push("[Measures].["+t.measure+"] <>"+t.value):"<>"==t.condition&&o.push("[Measures].["+t.measure+"] ="+t.value)),"><"==t.condition&&t.value<t.value2?i.string="Iif(([Measures].["+t.measure+"] >="+t.value+") AND ([Measures].["+t.measure+"] <= "+t.value2+"), '|#|style=\""+t.color+"\"',":"><"==t.condition&&t.value>t.value2?i.string="Iif(([Measures].["+t.measure+"] >="+t.value2+") AND ([Measures].["+t.measure+"] <= "+t.value+"), '|#|style=\""+t.color+"\"',":t.hideVal?i.string="Iif([Measures].["+t.measure+"]"+t.condition+" "+t.value+", '\" \"',":i.string="Iif([Measures].["+t.measure+"]"+t.condition+" "+t.value+", '|#|style=\""+t.color+"\"',",n.push(i)});var l="";$.each(i,function(e,t){$.inArray(t,a)>=0&&(i[e]=t+" "),l=l.length>0?l+", [Measures].["+i[e]+"]":"[Measures].["+i[e]+"]"});var d=s(n),c=oldmdx;$.each(oldqueryModel.axes.ROWS.hierarchies,function(e,t){for(property in t.levels)t.name,property}),mid1str=c.substring(c.indexOf("SELECT")),mid2str=mid1str.substring(0,mid1str.indexOf("{")),mid3str=mid1str.substring(mid1str.indexOf("}")),commastr=",",d[1].length<1&&(commastr=""),newMdxQry=c.substring(0,c.indexOf("SELECT"))+d[0].join(" \n")+mid2str+" {"+l+mid3str,t.workspace.query.model.type="MDX",t.workspace.query.model.mdx=newMdxQry,t.workspace.query.run(!0),condFormatting=!0,$(".workspace_editor").hide(),$(".sidebar").hide(),$(".workspace_inner").css("margin-left","0px")})},switch_queryModel:function(e){$(".workspace_editor").show(),$(".sidebar").show(),$(".workspace_inner").css("margin-left","241px"),"MDX"==this.workspace.query.model.type&&(this.workspace.query.model.queryModel=oldqueryModel,this.workspace.query.model.type="QUERYMODEL")},post_mdx_transform:function(){var e=this;"MDX"!==this.workspace.query.model.type&&(this.workspace.query.model.queryModel={},this.workspace.query.model.type="MDX",this.workspace.query.setProperty("saiku.olap.result.formatter","flat"),e.workspace.query.helper.model().parameters={});i=this.workspace.query.model.mdx;if(e.editor&&(e.editor.setValue(i,0),e.editor.clearSelection(),e.editor.focus()),$(e.el).find(".group_parents").removeClass("on"),Settings.ALLOW_PARAMETERS){var t=function(){var t=e.editor.getValue(),i=[];if(t)for(var s=0,a=t.length;s<a-1;s++)if("$"===t[s]&&"{"===t[s+1]){for(var r="",n=!1,s=s+2;s<a;s++){if("}"===t[s]){n=!0,s++;break}r+=t[s]}n&&r&&0<r.length&&i.push(r)}var o=e.workspace.query.helper.model().parameters,l={};_.each(i,function(e){l[e]=o[e]?o[e]:""}),e.workspace.query.helper.model().parameters=l,e.workspace.update_parameters()},i=function(){_.delay(t,1e3)};e.editor&&(e.editor.getSession().off("change",i),e.editor.getSession().on("change",i)),e.workspace.update_parameters()}},run_mdx:function(e){100<$(this.workspace.el).find(".mdx_input").height()&&$(this.workspace.el).find(".mdx_input").height(100),this.editor.resize(),e=this.editor.getValue(),this.workspace.query.model.mdx=e,this.workspace.query.run(!0)},explain_query:function(e){return this.workspace.query.action.gett("/explain",{success:function(e,t){var i="<textarea style='width: "+($("body").width()-165)+"px;height:"+($("body").height()-175)+"px;'>",i=(i=null!==t&&null!==t.error?i+t.error:t.cellset&&0===t.cellset.length?i+"Empty explain plan!":i+t.cellset[1][0].value)+"</textarea>";Saiku.ui.unblock(),$.fancybox('<div id="fancy_results" class="workspace_results" style="overflow:visible"><table><tr><th clas="row_header">Explain Plan</th></tr><tr><td>'+i+"</td></tr></table></div>",{autoDimensions:!1,autoScale:!1,height:$("body").height()-100,width:$("body").width()-100,transitionIn:"none",transitionOut:"none"})}}),!1}}),WorkspaceDropZone=Backbone.View.extend({template:function(){var e=$("#template-workspace-dropzones").html()||"";return _.template(e)()},events:{"sortstop .fields_list_body.details":"set_measures","sortstop .axis_fields":"select_dimension","click .d_measure":"remove_measure_click","click .d_level":"selections","click .measure_fields.limit":"measure_action","click .axis_fields_header.limit":"limit_axis","click .clear_axis":"clear_axis"},initialize:function(e){this.workspace=e.workspace,_.bindAll(this,"clear_axis","set_measures")},render:function(){var e=this;return $(this.el).html(this.template()),$(this.el).find(".fields_list_body.details ul.connectable").sortable({items:"> li",opacityg:.6,placeholder:"placeholder",tolerance:"pointer",containment:$(e.workspace.el),start:function(e,t){t.placeholder.text(t.helper.text())}}),$(this.el).find(".axis_fields ul.connectable").sortable({connectWith:$(e.el).find(".axis_fields ul.connectable"),forcePlaceholderSize:!1,forceHelperSize:!0,items:"li.selection",opacity:.6,placeholder:"placeholder",tolerance:"touch",cursorAt:{top:10,left:60},containment:$(e.workspace.el),start:function(t,i){var s=$(i.helper).find("a").parent().parent().attr("hierarchycaption");i.placeholder.text(s),$(i.helper).css({width:"auto",height:"auto"}),$(e.el).find(".axis_fields ul.hierarchy li.d_level:visible").addClass("temphide").hide()}}),this},set_measures:function(e,t){var i=[];$(this.el).find(".fields_list_body.details ul.connectable li.d_measure").each(function(e,t){var s={name:$(t).find("a").attr("measure"),type:$(t).find("a").attr("type")};i.push(s)}),this.workspace.query.helper.setMeasures(i),this.workspace.sync_query(),this.workspace.query.run()},remove_measure_click:function(e){e.preventDefault(),($(e.target).hasClass("d_measure")?$(e.target).find("a"):$(e.target)).parent().remove(),this.set_measures()},remove_dimension:function(e,t){if($(t.helper).hasClass("d_measure"))$(t.helper).detach(),this.set_measures();else{var i=$(t.helper).find("a").attr("hierarchy");$(this.el).find('ul.hierarchy[hierarchy="'+i+'"]').parents(".fields_list").attr("title"),$(t.helper).find("a").attr("level"),this.workspace.query.helper.removeHierarchy(i),this.workspace.sync_query(),this.workspace.query.run()}},synchronize_query:function(){var e=this;this.reset_dropzones();var t=this.workspace.query.helper.model();if(t.hasOwnProperty("queryModel")&&t.queryModel.hasOwnProperty("axes")){var i=t.queryModel.axes;console.dir(i),this.workspace.query.helper.getHierarchy("[Store].[Stores]");for(var s in i){var a=$(e.el).find('.fields_list[title="'+s+'"]');_.each(i[s].hierarchies,function(t){var i=$(e.workspace.dimension_list.el).find('ul.d_hierarchy[hierarchy="'+t.name+'"]').clone().removeClass("d_hierarchy").addClass("hierarchy");i.find("li.d_level").hide();for(var s in t.levels)i.find('li a[level="'+s+'"]').parent().show(),$(e.workspace.dimension_list.el).find('ul.d_hierarchy[hierarchy="'+t.name+'"] li a[level="'+s+'"]').parent().draggable("disable").parents(".parent_dimension").find(".folder_collapsed").addClass("selected");for(var r in t.cmembers)t.cmembers.hasOwnProperty(r)&&(s=r.split(".")[r.split(".").length-1].replace(/[\[\]]/gi,""),i.find('li a[level="'+s+'"]').parent().show(),$(e.workspace.dimension_list.el).find('ul.d_hierarchy[hierarchy="'+t.name+'"] li a[level="'+s+'"]').parent().draggable("disable").parents(".parent_dimension").find(".folder_collapsed").addClass("selected"));(t=$('<li class="selection"></li>')).append(i),t.appendTo(a.find("ul.connectable"))})}_.each(t.queryModel.details.measures||[],function(t){(t=$(e.workspace.dimension_list.el).find('.measure_tree a.measure[measure="'+t.name+'"]').parent()).clone().show().appendTo($(e.el).find(".fields_list_body.details ul.connectable")),t.draggable("disable")}),this.update_dropzones()}},reset_dropzones:function(){$(this.el).find(".fields_list_body ul.connectable").find("li.selection, li.d_measure").remove(),$(this.workspace.dimension_list.el).find("li.ui-draggable-disabled").draggable("enable"),$(this.el).find('.fields_list[title="ROWS"] .limit').removeClass("on"),$(this.el).find('.fields_list[title="COLUMNS"] .limit').removeClass("on"),$(this.workspace.el).find(".fields_list_body .clear_axis").addClass("hide")},update_dropzones:function(){$(this.workspace.el).find(".fields_list_body").each(function(e,t){var i=$(t);0===i.find("ul.connectable li.selection, ul.connectable li.d_measure").length?i.siblings(".clear_axis").addClass("hide"):i.siblings(".clear_axis").removeClass("hide")})},clear_axis:function(e){return e.preventDefault(),e=$(e.target).siblings(".fields_list_body").parent().attr("title"),"DETAILS"==e?this.workspace.query.helper.clearMeasures():this.workspace.query.helper.clearAxis(e),Saiku.session.trigger("workspaceDropZone:clear_axis",{workspace:this.workspace,axis:e}),this.workspace.sync_query(),this.workspace.query.run(),!1},select_dimension:function(e,t){if(Saiku.session.trigger("workspaceDropZone:select_dimension",{workspace:this.workspace}),$(t.item).is(":visible")){$(this.el).find(".axis_fields ul.hierarchy").each(function(e,t){$(t).find("li.temphide").show().removeClass("temphide")});var i=t.item.find(".level").attr("hierarchy"),s=-1;t.item.parents("ul.connectable").find("li.selection").each(function(e,t){$(t).find("ul.hierarchy").attr("hierarchy")==i&&(s=e)});var a=t.item.parents(".axis_fields").parent().attr("title"),r=$(e.target).parents(".axis_fields").parent().attr("title"),n=t.item.hasClass("d_level");if(t.item.hasClass("dimension-level-calcmember"))r=t.item.find("a.level").attr("uniquename"),this.workspace.toolbar.$el.find(".group_parents").removeClass("on"),this.workspace.toolbar.group_parents(),this.workspace.query.helper.includeLevelCalculatedMember(a,i,o,r,s);else if(n){var o=t.item.find("a.level").attr("level");this.workspace.query.helper.includeLevel(a,i,o,s)}else this.workspace.query.helper.moveHierarchy(r,a,i,s);$(t.item).detach(),this.workspace.sync_query(),this.workspace.query.run()}},find_type_time:function(e,t,i){void 0===this.workspace.metadata&&(this.workspace.metadata=Saiku.session.sessionworkspace.cube[this.workspace.selected_cube]);var s={};return s.dimensions=_.findWhere(this.workspace.metadata.attributes.data.dimensions,{name:e}),void 0===t&&(t=e),s.hierarchies=_.findWhere(s.dimensions.hierarchies,{name:t}),void 0!==s.hierarchies&&null!==s.hierarchies||(s.hierarchies=_.findWhere(s.dimensions.hierarchies,{name:e+"."+t})),s.level=_.findWhere(s.hierarchies.levels,{name:i}),null!==s.level&&void 0!==s.level||(s.level=_.findWhere(s.hierarchies.levels,{caption:i})),s},selections:function(e,t){e&&e.preventDefault();var i=$(e.target).hasClass("d_level")?$(e.target).find(".level"):$(e.target),s=i.attr("hierarchy").replace(/[\[\]]/gi,"").split(".")[0],a=i.attr("hierarchy").replace(/[\[\]]/gi,"").split(".")[1]?i.attr("hierarchy").replace(/[\[\]]/gi,"").split(".")[1]:i.attr("hierarchy").replace(/[\[\]]/gi,"").split(".")[0],r=i.attr("level"),n=this.find_type_time(s,a,r),o=i.attr("hierarchy"),l=i.attr("href").replace("#","");this.member=new Member({},{cube:this.workspace.selected_cube,dimension:l});var d,c=decodeURIComponent(this.member.hierarchy);return(c=this.workspace.query.helper.getHierarchy(c))&&c.levels.hasOwnProperty(r)&&(d=c.levels[r]),n.level&&void 0!==n.level.annotations&&null!==n.level.annotations&&(void 0!==n.level.annotations.AnalyzerDateFormat||void 0!==n.level.annotations.SaikuDayFormatString)&&(_.has(d,"selection")&&0===d.selection.members.length||1===_.size(d)&&_.has(d,"name")||_.has(d,"mdx")&&d.mdx||2===_.size(d)&&_.has(d,"name")&&_.has(d,"mdx"))?new DateFilterModal({dimension:s,hierarchy:a,target:i,name:i.attr("level"),data:n,analyzerDateFormat:n.level.annotations.AnalyzerDateFormat,dimHier:o,key:l,workspace:this.workspace}).open():new SelectionsModal({target:i,name:i.text(),key:l,workspace:this.workspace}).open(),!1},measure_action:function(e){var t=this;if(void 0===this.workspace.query||"QUERYMODEL"!=this.workspace.query.model.type||"view"==Settings.MODE)return!1;e=$(e.target).hasClass("limit")?$(e.target):$(e.target).parent();var i={HEADER:{name:"Position",disabled:!0,i18n:!0},sep1:"---------",BOTTOM_COLUMNS:{name:"Columns | Measures",i18n:!0},TOP_COLUMNS:{name:"Measures | Columns",i18n:!0},BOTTOM_ROWS:{name:"Rows | Measures",i18n:!0},TOP_ROWS:{name:"Measures | Rows",i18n:!0},sep2:"---------",reset:{name:"Reset Default",i18n:!0},cancel:{name:"Cancel",i18n:!0}};$.each(i,function(e,t){recursive_menu_translate(t,Saiku.i18n.po_file)}),$.contextMenu("destroy",".limit"),$.contextMenu({appendTo:e,selector:".limit",ignoreRightClick:!0,build:function(e,s){var a=t.workspace.query;return{callback:function(e,t){var i=a.helper.model().queryModel.details;if("cancel"!==e){if("reset"===e)i.location=SaikuOlapQueryTemplate.queryModel.details.location,i.axis=SaikuOlapQueryTemplate.queryModel.details.axis;else{var s=e.split("_")[0],r=e.split("_")[1];i.location=s,i.axis=r}a.run()}},items:i}}}),e.contextMenu()},limit_axis:function(e){var t=this;if(void 0===this.workspace.query||"QUERYMODEL"!=this.workspace.query.model.type||"view"==Settings.MODE)return!1;var i=$(e.target).hasClass("limit")?$(e.target):$(e.target).parent(),s=i.siblings(".fields_list_body").parent().attr("title");$.contextMenu("destroy",".limit"),$.contextMenu({appendTo:i,selector:".limit",ignoreRightClick:!0,build:function(e,a){var r,n,o,l,d,c,h,u,p,f={},m=Saiku.session.sessionworkspace.cube[t.workspace.selected_cube].get("data").measures,y=t.workspace.query.helper.getAxis(s),g=!1,v=!1,b=!1;y&&y.filters&&_.each(y.filters,function(e){"N"==e.flavour&&(r=y.function,n=e.expressions[0],o=e.expressions[1],b=!0),"Generic"==e.flavour&&(l=e.expressions[0],g=!0)}),y&&y.sortOrder&&(d=y.sortOrder,c=y.sortEvaluationLiteral,v=!0),y&&y.aggregators&&0<y.aggregators.length&&(p=y.aggregators[0]),null!==r&&null===o?u=r+"###SEPARATOR###"+n:null!==r&&null!==o&&null!==n&&(u="custom"),v&&null!==d&&(h="customsort"),_.each(m,function(e){f[e.uniqueName]={name:e.caption,payload:{n:10,sortliteral:e.uniqueName}}}),_.each(y.hierarchies,function(e){for(var t in e.levels)console.log(t)});var k={filter:{name:"Filter",i18n:!0,items:{customfilter:{name:"Custom...",i18n:!0},clearfilter:{name:"Clear Filter",i18n:!0}}},limit:{name:"Limit",i18n:!0,items:{"TopCount###SEPARATOR###10":{name:"Top 10",i18n:!0},"BottomCount###SEPARATOR###10":{name:"Bottom 10",i18n:!0},TopCountQuick:{name:"Top 10 by...",i18n:!0,items:(k=function(e,t){var i,s={};for(i in e)s[t+"###SEPARATOR###"+i]=_.clone(e[i]),s[t+"###SEPARATOR###"+i].fun=t,t==r&&o==i&&e[i].payload.n==n&&(u=t+"Quick",s[t+"###SEPARATOR###"+i].name="<b>"+e[i].name+"</b>"),t==d&&c==i&&(h=t+"Quick",s[t+"###SEPARATOR###"+i].name="<b>"+e[i].name+"</b>");return s})(f,"TopCount")},BottomCountQuick:{name:"Bottom 10 by...",i18n:!0,items:k(f,"BottomCount")},customtop:{name:"Custom Limit...",i18n:!0},clearlimit:{name:"Clear Limit",i18n:!0}}},sort:{name:"Sort",i18n:!0,items:{ASCQuick:{name:"Ascending",i18n:!0,items:k(f,"ASC")},DESCQuick:{name:"Descending",i18n:!0,items:k(f,"DESC")},BASCQuick:{name:"Ascending (Breaking Hierarchy)",i18n:!0,items:k(f,"BASC")},BDESCQuick:{name:"Descending (Breaking Hierarchy)",i18n:!0,items:k(f,"BDESC")},customsort:{name:"Custom...",i18n:!0},clearsort:{name:"Clear Sort",i18n:!0}}},grand_totals:{name:"Grand totals",i18n:!0,items:{show_totals_not:{name:"None",i18n:!0},show_totals_sum:{name:"Sum",i18n:!0},show_totals_min:{name:"Min",i18n:!0},show_totals_max:{name:"Max",i18n:!0},show_totals_avg:{name:"Avg",i18n:!0}}},cancel:{name:"Cancel",i18n:!0}};$.each(k,function(e,t){recursive_menu_translate(t,Saiku.i18n.po_file)});var w=k.grand_totals.items;if(p)for(var S in w)S.substring(12)==p&&(w[S].name="<b>"+w[S].name+"</b");else w.show_totals_not.name="<b>"+w.show_totals_not.name+"</b";return f[10]={payload:{n:10}},g&&(p=k.filter,p.name="<b>"+p.name+"</b>",p.items.customfilter.name="<b>"+p.items.customfilter.name+"</b>"),v&&(v=k.sort.items,k.sort.name="<b>"+k.sort.name+"</b>",h in v&&(v[h].name="<b>"+v[h].name+"</b>")),b&&(v=k.limit.items,k.limit.name="<b>"+k.limit.name+"</b>",u in v&&(v[u].name="<b>"+v[u].name+"</b>")),{callback:function(e,a){var d;if("cancel"!=e)if("clearfilter"==e)i.removeClass("on"),t.workspace.query.helper.removeFilter(y,"Generic"),t.synchronize_query(),t.workspace.query.run();else if("customfilter"==e)d=function(e){var i=[];i.push(e),t.workspace.query.helper.removeFilter(y,"Generic"),y.filters.push({flavour:"Generic",operator:null,function:"Filter",expressions:i}),t.synchronize_query(),t.workspace.query.run()},new FilterModal({axis:s,success:d,query:t.workspace.query,expression:l,expressionType:"Filter"}).render().open();else if("clearlimit"==e)i.removeClass("on"),t.workspace.query.helper.removeFilter(y,"N"),t.synchronize_query(),t.workspace.query.run();else if("customtop"==e)d=function(e,i,s){var a=[];a.push(i),s&&a.push(s),t.workspace.query.helper.removeFilter(y,"N"),y.filters.push({flavour:"N",operator:null,function:e,expressions:a}),t.synchronize_query(),t.workspace.query.run()},new CustomFilterModal({axis:s,measures:m,success:d,query:t.workspace.query,func:r,n:n,sortliteral:o}).render().open();else if("customsort"==e)d=function(e,i){y.sortOrder=e,y.sortEvaluationLiteral=i,t.synchronize_query(),t.workspace.query.run()},new FilterModal({axis:s,success:d,query:t.workspace.query,expression:c,expressionType:"Order"}).render().open();else{if("clearsort"==e)y.sortOrder=null,y.sortEvaluationLiteral=null,t.synchronize_query();else if(0===e.indexOf("show_totals_")){d=e.substring(12);var h=[];h.push(d),y.aggregators=h}else{d=e.split("###SEPARATOR###")[0];var u=e.split("###SEPARATOR###")[1];-1<_.indexOf(["ASC","BASC","DESC","BDESC"],d)?(y.sortOrder=d,y.sortEvaluationLiteral=f[u].payload.sortliteral):-1<_.indexOf(["Param"],d)?y.sortEvaluationLiteral=f[u].payload.sortliteral:((h=[]).push(f[u].payload.n),(u=f[u].payload.sortliteral)&&h.push(u),t.workspace.query.helper.removeFilter(y,"N"),y.filters.push({flavour:"N",operator:null,function:d,expressions:h})),t.synchronize_query()}t.workspace.query.run()}},items:k}}}),i.contextMenu()}}),Table=Backbone.View.extend({className:"table_wrapper",events:{"click th.row":"clicked_cell","click th.col":"clicked_cell"},initialize:function(e){this.workspace=e.workspace,this.renderer=new SaikuTableRenderer,_.bindAll(this,"render","process_data"),this.workspace.bind("query:result",this.render),this.id=_.uniqueId("table_"),$(this.el).attr("id",this.id)},clicked_cell:function(e){var t=this;0<$(this.workspace.el).find(".workspace_results.ui-selectable").length&&$(this.workspace.el).find(".workspace_results").selectable("destroy"),e=$(e.target).hasClass("row")||$(e.target).hasClass("col")?$(e.target).find("div"):$(e.target),$(document),$.contextMenu("destroy",".row, .col"),$.contextMenu({appendTo:e,selector:".row, .col",ignoreRightClick:!0,build:function(e,i){var s=$(i.currentTarget).find("div"),a=$(i.currentTarget).hasClass("row")?"ROWS":"COLUMNS",r=s.attr("rel").split(":"),n=parseInt(r[0]),r=parseInt(r[1]),o=t.workspace.query.result.lastresult().cellset[n][r];(n=t.workspace.query).get("schema"),n.get("connection"),n.get("catalog"),n.get("cube");var l,d=o.properties.dimension,c=o.properties.hierarchy,h=o.properties.level,u="",p=JSON.stringify({hierarchy:c,uniquename:h,type:"level",action:"delete"})+","+JSON.stringify({hierarchy:c,uniquename:o.properties.uniquename,type:"member",action:"add"}),n=o.properties.uniquename,f={},r=t.workspace.selected_cube;Saiku.session.sessionworkspace.cube[r]&&l&&measures||("undefined"!=typeof localStorage&&localStorage&&null!==localStorage.getItem("cube."+r)?Saiku.session.sessionworkspace.cube[r]=new Cube(JSON.parse(localStorage.getItem("cube."+r))):(Saiku.session.sessionworkspace.cube[r]=new Cube({key:r}),Saiku.session.sessionworkspace.cube[r].fetch({async:!1})),l=Saiku.session.sessionworkspace.cube[r].get("data").dimensions);var m=[],r=t.workspace.query.helper.getHierarchy(c);return _.each(r.levels,function(e){m.push(c+".["+e.name+"]")}),_.each(l,function(e){e.name==d&&_.each(e.hierarchies,function(e){e.uniqueName==c&&_.each(e.levels,function(e){f[e.name]={name:e.caption,payload:JSON.stringify({hierarchy:c,uniquename:e.uniqueName,type:"level",action:"add"})},-1<_.indexOf(m,e.uniqueName)&&(f[e.name].disabled=!0,f["remove-"+e.name]={name:e.caption,payload:JSON.stringify({hierarchy:c,uniquename:e.uniqueName,type:"level",action:"delete"})}),e.uniqueName==h&&(u=e.caption,l_name=e.name),f["keep-"+e.name]=f[e.name],f["include-"+e.name]=JSON.parse(JSON.stringify(f[e.name])),f["keep-"+e.name].payload=p+","+f[e.name].payload})})}),f.keeponly={payload:p},f.getchildren={payload:n},f.hasOwnProperty("remove-"+l_name)&&f.hasOwnProperty("include-"+l_name)&&(f.showall={payload:f["remove-"+l_name].payload+", "+f["include-"+l_name].payload}),l=function(e){var t,i={};for(t in f)null!==e&&e.length<t.length&&t.substr(0,e.length)==e&&(i[t]=f[t]);return i},n={name:{name:"<b>"+s.html()+"</b>",disabled:!0},sep1:"---------",keeponly:{name:"Keep Only",i18n:!0,payload:p}},"Measures"!=d&&(n.fold1key={name:"Include Level",i18n:!0,items:l("include-")},n.fold2key={name:"Keep and Include Level",i18n:!0,items:l("keep-")},n.fold3key={name:"Remove Level",i18n:!0,items:l("remove-")},n.filterlevel={name:"Filter Level",i18n:!0}),$.each(n,function(e,t){recursive_menu_translate(t,Saiku.i18n.po_file)}),{callback:function(e,i){var r=[];if("keeponly"===e){var n=t.workspace.query.helper.getHierarchy(c);n&&n.levels.hasOwnProperty(u)&&(r.push({uniqueName:o.properties.uniquename,caption:o.properties.uniquename}),n.levels[u].selection={type:"INCLUSION",members:r},t.workspace.drop_zones.synchronize_query(),t.workspace.query.run(!0))}else if("filterlevel"===e)r=o.properties.level.substring(o.properties.level.lastIndexOf(".")+1),r=r.replace("[","").replace("]",""),new SelectionsModal({target:s,name:"Filter Level",key:o.properties.hierarchy+"/"+r,workspace:t.workspace,axis:"ROWS"}).open();else if("remove"===e.substring(0,e.indexOf("-"))){var l=e.substring(e.indexOf("-")+1);t.workspace.query.helper.removeLevel(c,l),t.workspace.drop_zones.synchronize_query(),t.workspace.query.run(!0)}else"keep"===e.substring(0,e.indexOf("-"))?(l=e.substring(e.indexOf("-")+1),(n=t.workspace.query.helper.getHierarchy(c))&&n.levels.hasOwnProperty(u)&&(r.push({uniqueName:o.properties.uniquename,caption:o.properties.uniquename}),n.levels[u].selection={type:"INCLUSION",members:r},t.workspace.query.helper.includeLevel(a,c,l,null),t.workspace.drop_zones.synchronize_query(),t.workspace.query.run(!0))):"include"===e.substring(0,e.indexOf("-"))&&(l=e.substring(e.indexOf("-")+1),t.workspace.query.helper.includeLevel(a,c,l,null),t.workspace.drop_zones.synchronize_query(),t.workspace.query.run(!0))},items:n}}}),e.contextMenu()},render:function(e,t){void 0===e||void 0===e.data||$(this.workspace.el).is(":visible")&&!$(this.el).is(":visible")||null!==e.data&&null!==e.data.error||null===e.data||e.data.height&&0===e.data.height||(this.clearOut(),$(this.el).html("Rendering "+e.data.width+" columns and "+e.data.height+" rows..."),_.delay(this.process_data,2,e.data))},clearOut:function(){this.renderer.clear(),$(this.workspace.el).find(".workspace_results").unbind("scroll");var e=document.getElementById(this.id);null==e&&(this.workspace.tab.select(),e=document.getElementById(this.id));var t=e.firstChild;t&&e.removeChild(t)},process_data:function(e){this.workspace.processing.hide(),this.workspace.adjust(),this.clearOut(),$(this.el).html("<table></table>"),this.renderer.render(e,{htmlObject:$(this.el).find("table"),batch:Settings.TABLE_LAZY,batchSize:Settings.TABLE_LAZY_SIZE,batchIntervalSize:Settings.TABLE_LAZY_LOAD_ITEMS,batchIntervalTime:Settings.TABLE_LAZY_LOAD_TIME}),this.post_process()},post_process:function(){"QM"==this.workspace.query.get("type")&&"view"!=Settings.MODE?$(this.el).addClass("headerhighlight"):$(this.el).removeClass("headerhighlight"),$(this.el).find(".i18n").i18n(Saiku.i18n.po_file),this.workspace.trigger("table:rendered",this)}}),Workspace=Backbone.View.extend({className:"tab_container",events:{"click .sidebar_separator":"toggle_sidebar","change .cubes":"new_query","drop .sidebar":"remove_dimension","drop .workspace_results":"remove_dimension","click .refresh_cubes":"refresh","click .cancel":"cancel","click .admin":"admin"},initialize:function(e){_.bindAll(this,"caption","adjust","toggle_sidebar","prepare","new_query","set_class_charteditor","init_query","update_caption","populate_selections","refresh","sync_query","cancel","cancelled","no_results","error","switch_view_state"),_.extend(this,Backbone.Events),this.loaded=!1,this.bind("query:result",this.render_result),this.toolbar=new WorkspaceToolbar({workspace:this}),this.toolbar.render(),this.upgrade=new Upgrade({workspace:this}),this.upgrade.render(),this.querytoolbar=new QueryToolbar({workspace:this}),this.querytoolbar.render(),this.drop_zones=new WorkspaceDropZone({workspace:this}),this.drop_zones.render(),this.table=new Table({workspace:this}),this.chart=new Chart({workspace:this}),this.dateFilter=new DateFilterCollection,this.item={},this.viewState=e&&e.viewState?e.viewState:Settings.DEFAULT_VIEW_STATE,this.isReadOnly="view"==Settings.MODE||!1,e&&e.item&&(this.item=e.item)&&this.item.hasOwnProperty("acl")&&0>_.indexOf(this.item.acl,"WRITE")&&(this.isReadOnly=!0,this.viewState="view"),e&&(e.query||e.viewState)||(this.viewState="edit"),e&&e.query&&(this.query=e.query,this.query.workspace=this,this.query.save({},{success:this.init_query,error:function(){if(Saiku.ui.unblock(),1>$("body").find(".error_loading_query").length){var e=Saiku.i18n&&Saiku.i18n.po_file.error_loading_query?Saiku.i18n.po_file.error_loading_query:null;e||($('<span class="i18n error_loading_query">Error Loading Query</span>').hide().appendTo("body"),Saiku.i18n.translate(),e=$(".error_loading_query").text())}else e=$(".error_loading_query").text();alert(e)}})),Saiku.session.bind("tab:add",this.prepare),e=Saiku.URLParams.paramsURI(),Saiku.URLParams.equals({schema:e.schema,cube:e.cube}),this.data_connections(e)},afterRender:function(){console.log("After render")},caption:function(e){if(this.query&&this.query.model){if(this.item&&this.item.name)return this.item.name.split(".")[0];if(this.query.model.mdx)return this.query.model.name}else if(this.query&&this.query.get("name"))return this.query.get("name");return e&&Saiku.tabs.queryCount++,"<span class='i18n'>Unsaved query</span> ("+Saiku.tabs.queryCount+")"},selected_cube_template:function(e){var t=Saiku.session.sessionworkspace;return t.selected=e,_.template('<select class="cubes"><option value="" class="i18n">Select a cube</option><% _.each(connections, function(connection) { %><% _.each(connection.catalogs, function(catalog) { %><% _.each(catalog.schemas, function(schema) { %><% if (schema.cubes.length > 0) { %><optgroup label="<%= (schema.name !== "" ? schema.name : catalog.name) %> <%= (connection.name) %>"><% _.each(schema.cubes, function(cube) { %><% if ((typeof cube["visible"] === "undefined" || cube["visible"]) && selected !== cube.caption) { %><option value="<%= connection.name %>/<%= catalog.name %>/<%= ((schema.name === "" || schema.name === null) ? "null" : schema.name) %>/<%= encodeURIComponent(cube.name) %>"><%= ((cube.caption === "" || cube.caption === null) ? cube.name : cube.caption) %></option><% } else if ((typeof cube["visible"] === "undefined" || cube["visible"]) && selected === cube.caption) { %><option value="<%= connection.name %>/<%= catalog.name %>/<%= ((schema.name === "" || schema.name === null) ? "null" : schema.name) %>/<%= encodeURIComponent(cube.name) %>" selected><%= ((cube.caption === "" || cube.caption === null) ? cube.name : cube.caption) %></option><% } %><% }); %></optgroup><% } %><% }); %><% }); %><% }); %></select>')(t)},template:function(){var e=$("#template-workspace").html()||"",t=!1;return this.isUrlCubeNavigation&&(t=this.selected_cube.split("/")[3],t=this.selected_cube_template(t)),_.template(e)({cube_navigation:t||Saiku.session.sessionworkspace.cube_navigation})},refresh:function(e){e&&e.preventDefault(),Saiku.session.sessionworkspace.refresh()},render:function(){if($(this.el).html(this.template()),this.processing=$(this.el).find(".query_processing"),this.isReadOnly||Settings.MODE&&("view"==Settings.MODE||"table"==Settings.MODE||"map"==Settings.MODE||"chart"==Settings.MODE)?($(this.el).find(".workspace_editor").remove(),this.toggle_sidebar(),$(this.el).find(".sidebar_separator").remove(),$(this.el).find(".workspace_inner").css({"margin-left":0}),$(this.el).find(".workspace_fields").remove(),$(this.el).find(".sidebar").hide(),$(this.toolbar.el).find(".run, .auto, .toggle_fields, .toggle_sidebar,.switch_to_mdx, .new").parent().remove()):($(this.el).find(".workspace_editor").append($(this.drop_zones.el)),$(this.el).find(".sidebar").droppable({accept:".d_measure, .selection"}),$(this.el).find(".workspace_results").droppable({accept:".d_measure, .selection"})),!Settings.MODE||"table"!=Settings.MODE&&"chart"!=Settings.MODE&&"map"!=Settings.MODE?($(this.el).find(".workspace_toolbar").append($(this.toolbar.el)),$(this.el).find(".query_toolbar").append($(this.querytoolbar.el)),$(this.el).find(".upgrade").append($(this.upgrade.el))):($(this.el).find(".workspace_toolbar").remove(),$(this.el).find(".query_toolbar").remove()),this.switch_view_state(this.viewState,!0),$(this.el).find(".workspace_results").append($(this.table.el)),this.chart.render_view(),this.tab.bind("tab:select",this.adjust),$(window).resize(this.adjust),Saiku.session.trigger("workspace:new",{workspace:this}),Settings.PLUGIN&&0==Settings.BIPLUGIN5&&Saiku.session.isAdmin){var e=$("<a />").attr({href:"#adminconsole",title:"Admin Console"}).click(Saiku.AdminConsole.show_admin).addClass("button admin_console");$(this.el).find(".refresh_cubes_nav").css("margin-right","40px"),$(this.el).find(".admin_console_nav").append(e)}return this},clear:function(){this.table.clearOut(),$(this.el).find(".workspace_results table,.connectable").html(""),$(this.el).find(".workspace_results_info").empty(),$(this.el).find(".parameter_input").empty(),$(this.chart.el).find("div.canvas").empty(),$(this.querytoolbar.el).find("ul.options a.on").removeClass("on"),$(this.el).find('.fields_list[title="ROWS"] .limit').removeClass("on"),$(this.el).find('.fields_list[title="COLUMNS"] .limit').removeClass("on"),Saiku.session.trigger("workspace:clear",{workspace:this})},adjust:function(){var e=$(this.el).find(".sidebar_separator"),t=87;!0!==Settings.PLUGIN&&!0!==Settings.BIPLUGIN||(t=2,"table"==Settings.MODE&&(t=-5)),(0===$("#header").length||$("#header").is("hidden"))&&(t=2),e.height($("body").height()-t),$(this.el).find(".sidebar").height($("body").height()-t),$(this.querytoolbar.el).find("div").height($("body").height()-t-10);var e=$(this.el).find(".workspace_editor").is(":hidden")?0:$(this.el).find(".workspace_editor").height(),i=$(this.el).find(".query_processing").is(":hidden")?0:$(this.el).find(".query_processing").height()+62,s=$(this.el).find(".upgradeheader").is(":hidden")?0:$(this.el).find(".upgrade").height();$(this.el).find(".workspace_results").css({height:$("body").height()-t-$(this.el).find(".workspace_toolbar").height()-$(this.el).find(".workspace_results_info").height()-e-i-s-20}),this.querytoolbar&&$(this.querytoolbar.el).find("a").tipsy({delayIn:700,fade:!0}),this.toolbar&&$(this.toolbar.el).find("a").tipsy({delayIn:900,fade:!0}),this.trigger("workspace:adjust",{workspace:this})},toggle_sidebar:function(){$(this.el).find(".sidebar").toggleClass("hide"),$(this.toolbar.el).find(".toggle_sidebar").toggleClass("on");var e=($(this.el).find(".sidebar").is(":visible")?$(this.el).find(".sidebar").width():0)+$(this.el).find(".sidebar_separator").width()+1;$(this.el).find(".workspace_inner").css({"margin-left":e})},prepare:function(){$(this.el).find(".cubes").parent().css({backgroundColor:"#AC1614"}).delay(300).animate({backgroundColor:"#fff"},"slow")},data_connections:function(e){var t=this;_.each(Saiku.session.sessionworkspace.connections,function(i){_.each(i.catalogs,function(s){_.each(s.schemas,function(a){0<a.cubes.length&&_.each(a.cubes,function(r){if(void 0===r.visible||r.visible){var n=""===a.name||null===a.name?"null":a.name;r=""===r.caption||null===r.caption?r.name:r.caption,e.schema===n&&e.cube===r&&(t.selected_cube=i.name+"/"+s.name+"/"+n+"/"+r,t.isUrlCubeNavigation=!0,_.delay(t.new_query,1e3))}})})})})},create_new_query:function(e){if(initFormat(),e.query&&(e.query.destroy(),e.query.clear(),e.query.name&&(e.query.name=void 0,e.update_caption(!0)),e.query.name=void 0),e.clear(),e.processing.hide(),Saiku.session.trigger("workspace:clear",{workspace:e}),e.selected_cube=$(e.el).find(".cubes").val()?$(e.el).find(".cubes").val():e.selected_cube,!e.selected_cube)return $(e.el).find(".calculated_measures, .addMeasure").hide(),$(e.el).find(".dimension_tree").html(""),$(e.el).find(".measure_tree").html(""),!1;e.metadata=Saiku.session.sessionworkspace.cube[e.selected_cube];for(var t=e.selected_cube.split("/"),i=t[3],s=4,a=t.length;s<a;s++)i+="/"+t[s];this.query=new Query({cube:{connection:t[0],catalog:t[1],schema:"null"==t[2]?"":t[2],name:decodeURIComponent(i)}},{workspace:e}),e.query=this.query,e.query.save({},{data:{json:JSON.stringify(this.query.model)},async:!1}),e.init_query()},new_query:function(){this.query&&Settings.QUERY_OVERWRITE_WARNING?new WarningModal({title:"New Query",message:"You are about to clear your existing query",okay:this.create_new_query,okayobj:this}).render().open():this.create_new_query(this)},init_query:function(e){initFormat();var t=this;try{var i=this.query.model.properties?this.query.model.properties:{},s="RENDER_MODE"in Settings?Settings.RENDER_MODE:"saiku.ui.render.mode"in i?i["saiku.ui.render.mode"]:null,a="RENDER_TYPE"in Settings?Settings.RENDER_TYPE:"saiku.ui.render.type"in i?i["saiku.ui.render.type"]:null;"table"==Settings.MODE?s="table":"chart"==Settings.MODE?s="chart":"map"==Settings.MODE&&(s="map"),void 0!==s&&null!==s&&this.querytoolbar.switch_render(s),"chart"==s?(!Settings.MODE||"chart"!==Settings.MODE||"map_heat"!==a&&"map_geo"!==a&&"map_marker"!==a||(this.query.setProperty("saiku.ui.render.mode","chart"),a="stackedBar"),$(this.chart.el).find(".canvas_wrapper").hide(),this.chart.renderer.switch_chart(a),$(this.querytoolbar.el).find('ul.chart [href="#'+a+'"]').parent().siblings().find(".on").removeClass("on"),$(this.querytoolbar.el).find('ul.chart [href="#'+a+'"]').addClass("on"),this.set_class_charteditor()):"table"==s&&a in this.querytoolbar?(this.querytoolbar.render_mode="table",this.querytoolbar.spark_mode=a,$(this.querytoolbar.el).find("ul.table a."+a).addClass("on")):"map"===s&&(this.querytoolbar.$el.find("ul.chart > li").find("a").removeClass("on"),this.querytoolbar.$el.find('ul.chart [href="#'+s+'"]').addClass("on"))}catch(e){Saiku.error(this.cid,e)}if(null!=this.query.model.mdx){var r=this.query.model.mdx.split("-------------------");if(r.length>1){for(condFormatting=!0,queryFormatted=!1,this.query.model.mdx=r[0],oldqueryModel=this.query.model.queryModel,p=r[2],conditions=[],p=p.split(",");p[0];){var n={};n.measure=p[0],n.condition=p[1],n.value=p[2],n.value2=p[3],n.color=p[4],n.hideVal=p[5],p.splice(0,6),conditions.push(n)}oldmdx=r[1],this.query.model.type="QUERYMODEL"}}condFormatting&&!queryFormatted?("table"==Settings.MODE&&this.query?this.query.run(!0):($(this.el).find(".workspace_editor").removeClass("hide").show(),$(this.el).find(".workspace_fields").removeClass("disabled").removeClass("hide"),$(this.el).find(".workspace_editor .mdx_input").addClass("hide"),$(this.el).find(".workspace_editor .editor_info").addClass("hide"),$(this.toolbar.el).find(".auto, .toggle_fields, .query_scenario, .buckets, .non_empty, .swap_axis, .mdx, .switch_to_mdx, .zoom_mode, .drillacross").parent().show(),$(this.el).find(".run").attr("href","#run_query"),this.adjust(),this.switch_view_state(this.viewState,!0),$(this.el).find(".sidebar").hasClass("hide")||"chart"!=Settings.MODE&&"table"!=Settings.MODE&&"map"!=Settings.MODE&&"view"!=Settings.MODE&&!this.isReadOnly||this.toggle_sidebar(),"view"==Settings.MODE&&this.query||this.isReadOnly?(this.query.run(!0),void 0===this.selected_cube&&(i=this.query.model.cube.schema,this.selected_cube=this.query.model.cube.connection+"/"+this.query.model.cube.catalog+"/"+(""===i||null===i?"null":i)+"/"+encodeURIComponent(this.query.model.cube.name),$(this.el).find(".cubes").val(this.selected_cube))):(void 0===this.selected_cube&&(i=this.query.model.cube.schema,this.selected_cube=this.query.model.cube.connection+"/"+this.query.model.cube.catalog+"/"+(""===i||null===i?"null":i)+"/"+encodeURIComponent(this.query.model.cube.name),$(this.el).find(".cubes").val(this.selected_cube)),this.selected_cube?(i=Saiku.session.sessionworkspace.cube[this.selected_cube],this.dimension_list=new DimensionList({workspace:this,cube:i}),this.dimension_list.render(),$(this.el).find(".metadata_attribute_wrapper").html("").append($(this.dimension_list.el)),i.has("data")||i.fetch({success:function(){t.trigger("cube:loaded")}}),this.trigger("query:new",{workspace:this})):($(this.el).find(".calculated_measures, .addMeasure").hide(),$(this.el).find(".dimension_tree").html(""),$(this.el).find(".measure_tree").html("")),void 0!==e&&this.query.run(!0),Saiku.i18n.translate())),queryFormatted=!0,this.query.model.type="MDX",this.query.run(!0)):"table"==Settings.MODE&&this.query?this.query.run(!0):("MDX"==this.query.model.type?(this.query.setProperty("saiku.olap.result.formatter","flat"),$(this.el).find(".sidebar").hasClass("hide")||this.toggle_sidebar(),$(this.el).find(".workspace_fields").addClass("hide"),this.toolbar.switch_to_mdx()):($(this.el).find(".workspace_editor").removeClass("hide").show(),$(this.el).find(".workspace_fields").removeClass("disabled").removeClass("hide"),$(this.el).find(".workspace_editor .mdx_input").addClass("hide"),$(this.el).find(".workspace_editor .editor_info").addClass("hide"),$(this.toolbar.el).find(".auto, .toggle_fields, .query_scenario, .buckets, .non_empty, .swap_axis, .mdx, .switch_to_mdx, .zoom_mode, .drillacross").parent().show(),$(this.el).find(".run").attr("href","#run_query")),this.adjust(),this.switch_view_state(this.viewState,!0),$(this.el).find(".sidebar").hasClass("hide")||"chart"!=Settings.MODE&&"table"!=Settings.MODE&&"map"!=Settings.MODE&&"view"!=Settings.MODE&&!this.isReadOnly||this.toggle_sidebar(),"view"==Settings.MODE&&this.query||this.isReadOnly?(this.query.run(!0),void 0===this.selected_cube&&(i=this.query.model.cube.schema,this.selected_cube=this.query.model.cube.connection+"/"+this.query.model.cube.catalog+"/"+(""===i||null===i?"null":i)+"/"+encodeURIComponent(this.query.model.cube.name),$(this.el).find(".cubes").val(this.selected_cube))):(void 0===this.selected_cube&&(i=this.query.model.cube.schema,this.selected_cube=this.query.model.cube.connection+"/"+this.query.model.cube.catalog+"/"+(""===i||null===i?"null":i)+"/"+encodeURIComponent(this.query.model.cube.name),$(this.el).find(".cubes").val(this.selected_cube)),this.selected_cube?(i=Saiku.session.sessionworkspace.cube[this.selected_cube],this.dimension_list=new DimensionList({workspace:this,cube:i}),this.dimension_list.render(),$(this.el).find(".metadata_attribute_wrapper").html("").append($(this.dimension_list.el)),i.has("data")||i.fetch({success:function(){t.trigger("cube:loaded")}}),this.trigger("query:new",{workspace:this})):($(this.el).find(".calculated_measures, .addMeasure").hide(),$(this.el).find(".dimension_tree").html(""),$(this.el).find(".measure_tree").html("")),void 0!==e&&this.query.run(!0),Saiku.i18n.translate()))},set_class_charteditor:function(){this.query.getProperty("saiku.ui.chart.options")&&$(this.querytoolbar.el).find('ul.chart [href="#charteditor"]').addClass("on")},synchronize_query:function(){this.isReadOnly||Settings.hasOwnProperty("MODE")},sync_query:function(e){if("QUERYMODEL"===this.query.helper.model().type){var t=this;if(e=e||$(t.dimension_list.el),!t.isReadOnly&&(!Settings.hasOwnProperty("MODE")||"table"!=Settings.MODE&&"view"!=Settings.MODE)){e.find(".selected").removeClass("selected");var i=t.query.helper.getCalculatedMeasures(),s=t.query.helper.getCalculatedMembers();if(i&&0<i.length?(i=_.template($("#template-calculated-measures").html(),{measures:i}),e.find(".calculated_measures").html(i),e.find(".calculated_measures").find(".measure").parent("li").draggable({cancel:".not-draggable",connectToSortable:$(t.el).find(".fields_list_body.details ul.connectable"),helper:"clone",placeholder:"placeholder",opacity:.6,tolerance:"touch",containment:$(t.el),cursorAt:{top:10,left:35}})):e.find(".calculated_measures").empty(),s&&0<s.length){t=this,e=e.find(".dimension_tree").find(".parent_dimension").find(".d_hierarchy");var a,r,i=s.length;for(e.find(".dimension-level-calcmember").remove(),r=0;r<i;r++)e.each(function(e,i){$(i).attr("hierarchy")===s[r].hierarchyName&&(a=_.template($("#template-calculated-member").html(),{member:s[r]}),a=$(i).closest(".parent_dimension").find("span.root").hasClass("collapsed")?$(a).hide():$(a).show(),$(i).append(a),$(i).find(".level-calcmember").parent("li").draggable({cancel:".not-draggable, .hierarchy",connectToSortable:$(t.el).find(".fields_list_body.columns > ul.connectable, .fields_list_body.rows > ul.connectable, .fields_list_body.filter > ul.connectable"),containment:$(t.el),helper:function(e,t){var i=$(e.target).hasClass("d_level")?$(e.target):$(e.target).parent(),s=i.find("a").attr("hierarchy"),a=i.find("a").attr("level");return(i=i.parent().clone().removeClass("d_hierarchy").addClass("hierarchy")).find('li a[hierarchy="'+s+'"]').parent().hide(),i.find('li a[level="'+a+'"]').parent().show(),(s=$('<li class="selection selection-calcmember"></li>')).append(i),s},placeholder:"placeholder",opacity:.6,tolerance:"touch",cursorAt:{top:10,left:85}}))})}else e.find(".dimension_tree").find(".parent_dimension").find(".d_hierarchy").find(".dimension-level-calcmember").remove();t.drop_zones.synchronize_query()}}Saiku.i18n.translate()},populate_selections:function(e){return e.workspace.sync_query(),!1},update_caption:function(e){e=this.caption(e),this.tab.set_caption(e)},remove_dimension:function(e,t){"QUERYMODEL"==this.query.model.type&&this.drop_zones.remove_dimension(e,t)},update_parameters:function(){var e=this;if($(this.el).find(".parameter_input").html(""),e.hasOwnProperty("query")&&Settings.ALLOW_PARAMETERS&&"view"!==Settings.MODE&&"view"!==e.viewState){var t,i="<span class='i18n'>Parameters</span>: ",s=this.query.helper.model().parameters,a=!1;for(t in s)a="",s[t]&&null!==s[t]&&(a=s[t]),i+="<b>"+t+"</b> <input type='text' placeholder='"+t+"' value='"+a+"' />",a=!0;i+="",a?$(this.el).find(".parameter_input").html(i):$(this.el).find(".parameter_input").html(""),$(this.el).find(".parameter_input input").off("change"),$(this.el).find(".parameter_input input").on("change",function(t){var i=$(t.target).attr("placeholder");t=$(t.target).val(),e.query.helper.model().parameters[i]=t})}},render_result:function(e){if($(this.el).find(".workspace_results_info").empty(),null!==e.data&&null!==e.data.error)return this.error(e);if(null===e.data||e.data.cellset&&0===e.data.cellset.length)return this.no_results(e);var t=(new Date).getHours();10>t&&(t="0"+t);var i=(new Date).getMinutes();10>i&&(i="0"+i),t=t+":"+i,i=null!==e.data.runtime?(e.data.runtime/1e3).toFixed(2):"",t='<b><span class="i18n">Info:</span></b> &nbsp;'+t+"&emsp;/ &nbsp;"+e.data.width+" x "+e.data.height+"&nbsp; / &nbsp;"+i+"s",this.update_parameters(),$(this.el).find(".workspace_results_info").html(t),void 0!=(e=e.workspace.query.getProperty("saiku.ui.headings"))&&(e=JSON.parse(e),t="",null!=e.title&&""!=e.title&&(t='<h3><span class="i18n">Title:</span></h3> &nbsp;'+e.title+"<br/>"),null!=e.variable&&""!=e.variable&&(t+='<h3><span class="i18n">Variable:</span></h3> &nbsp;'+e.variable+"<br/>"),null!=e.explanation&&""!=e.explanation&&(t+='<h3><span class="i18n">Explanation:</span></h3> &nbsp;'+e.explanation),$(this.el).find(".workspace_results_titles").html(t)),this.adjust()},switch_view_state:function(e,t){var i=e||"edit";"edit"==i?(this.toolbar.toggle_fields_action("show",t),this.query&&"MDX"==this.query.get("type")&&this.toolbar.editor.gotoLine(0),$(this.el).find(".sidebar").hasClass("hide")&&this.toggle_sidebar(),$(this.toolbar.el).find(".auto, .toggle_fields, .toggle_sidebar,.switch_to_mdx, .new").parent().css({display:"block"})):"view"==i&&(this.toolbar.toggle_fields_action("hide",t),$(this.el).find(".sidebar").hasClass("hide")||this.toggle_sidebar(),$(this.toolbar.el).find(".auto, .toggle_fields, .toggle_sidebar,.switch_to_mdx").parent().hide()),this.viewState=i,this.update_parameters(),$(window).trigger("resize")},block:function(e){Settings.LOGO_32x32?$(this.el).block({message:'<img class="saiku_logo_override" style="float:left" src="'+Settings.LOGO_32x32+'"/> '+e}):$(this.el).block({message:'<span class="saiku_logo" style="float:left">&nbsp;&nbsp;</span> '+e}),Saiku.i18n.translate()},unblock:function(){isIE||$(this.el).unblock(),Saiku.ui.unblock()},cancel:function(e){var t=this;e&&e.preventDefault(),this.query.action.del("/cancel",{success:function(){t.cancelled()}})},admin:function(e){Saiku.AdminConsole.show_admin()},cancelled:function(e){this.processing.html('<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Canceling Query...</span>').show()},no_results:function(e){this.processing.html('<span class="i18n">No Results</span>').show()},error:function(e){this.processing.html(safe_tags_replace(e.data.error)).show()}}),DeleteRepositoryObject=Modal.extend({type:"delete",buttons:[{text:"Yes",method:"del"},{text:"No",method:"close"}],initialize:function(e){this.options.title="Confirm deletion",this.query=e.query,this.success=e.success,this.message='<span class="i18n">Are you sure you want to delete </span><span>'+this.query.get("name")+"?</span>"},del:function(){this.query.set("id",_.uniqueId("query_")),this.query.id=_.uniqueId("query_"),this.query.url=this.query.url()+"?file="+encodeURIComponent(this.query.get("file")),this.query.destroy({success:this.success,dataType:"text",error:this.error,wait:!0}),this.close()},error:function(){$(this.el).find("dialog_body").html('<span class="i18n">Could not delete repository object</span>')}}),MoveRepositoryObject=Modal.extend({type:"save",closeText:"Move",events:{click:"select_root_folder","click .dialog_footer a":"call","click .query":"select_name","dblclick .query":"open_query","click li.folder":"toggle_folder","keyup .search_file":"search_file","click .cancel_search":"cancel_search","click .export_btn":"export_zip","change .file":"select_file"},buttons:[{id:"test",text:"Move",method:"open_query"},{text:"Cancel",method:"close"}],initialize:function(e){var t=this;this.movefolder=e.query,this.success=e.success,this.message='<br/><b><div class=\'query_name\'><span class=\'i18n\'>Please select a folder.....</span></div></b><br/><div class=\'RepositoryObjects\'>Loading....</div><br><div style="height:25px; line-height:25px;"><b><span class="i18n">Search:</span></b> &nbsp; <span class="search"><input type="text" class="search_file"></input><span class="cancel_search"></span></span></div>',_.extend(this.options,{title:"Move"}),this.selected_folder=null,this.repository=new Repository({},{dialog:this}),this.bind("open",function(){var e=$("body").height()/2+$("body").height()/6;420<e&&(e=420),$(this.el).find(".RepositoryObjects").height(e),$(this.el).dialog("option","position","center"),$(this.el).parents(".ui-dialog").css({width:"550px"}),$(this.el).find(".dialog_footer").find('a[href="#open_query"]').hide(),t.repository.fetch()}),_.bindAll(this,"populate","toggle_folder","select_name","select_file","select_folder","open_query")},populate:function(e){function t(e){_.forEach(e,function(e){"FOLDER"===e.type&&(i.queries[e.path]=e,t(e.repoObjects))})}var i=this;$(this.el).find(".RepositoryObjects").html(_.template($("#template-repository-objects").html())({repoObjects:e})),i.queries={},t(e)},select_root_folder:function(e){"name"!==$(e.target).attr("name")&&this.unselect_current_selected_folder()},toggle_folder:function(e){var t=$(e.currentTarget);this.unselect_current_selected_folder(),t.children(".folder_row").addClass("selected");var i=t.children(".folder_content");return t.children(".folder_row").find(".sprite").hasClass("collapsed")?(t.children(".folder_row").find(".sprite").removeClass("collapsed"),i.removeClass("hide")):(t.children(".folder_row").find(".sprite").addClass("collapsed"),i.addClass("hide")),this.select_folder(),this.select_name(e),!1},select_name:function(e){return e=$(e.currentTarget),this.unselect_current_selected_folder(),e.parent().parent().has(".folder").children(".folder_row").addClass("selected"),e=e.find("a").attr("href"),e=e.replace("#",""),$(this.el).find(".query_name").html(e),$(this.el).find(".dialog_footer").find('a[href="#open_query"]').show(),this.select_folder(),!1},unselect_current_selected_folder:function(){$(this.el).find(".selected").removeClass("selected")},select_folder:function(){var e=$(this.el).find(".selected");if(void 0!==(e=0<e.length?e.children("a").attr("href").replace("#",""):null)&&null!==e&&""!==e){var t=$("#importForm");t.find(".directory").val(e);var i=Settings.REST_URL+(new RepositoryZipExport).url()+"upload";t.attr("action",i),$(this.el).find(".zip_folder").text(e),this.selected_folder=e,$(this.el).find(".export_btn, .import_btn").removeAttr("disabled"),this.select_file()}else $(this.el).find(".import_btn, .export_btn").attr("disabled","true")},select_file:function(){var e=$("#importForm").find(".file").val();void 0!==e&&""!==e&&null!==e&&null!==this.selected_folder?$(this.el).find(".import_btn").removeAttr("disabled"):$(this.el).find(".import_btn").attr("disabled","true")},open_query:function(e){var t=$(e.currentTarget),i=$(this.el).find(".query_name").html();t.hasClass("query")&&(i=t.find("a").attr("href").replace("#",""));var s=this;return(new MoveObject).save({source:this.movefolder.get("file"),target:i},{success:function(){s.close(),s.success()}}),e.preventDefault(),!1}}),MoveObject=Backbone.Model.extend({url:function(){return"api/repository/resource/move"}}),OpenQuery=Backbone.View.extend({className:"tab_container",events:{"click .query":"view_query","dblclick .query":"select_and_open_query","click .add_folder":"add_folder","click li.folder":"toggle_folder","click .workspace_toolbar a.button":"prevent_default","click .workspace_toolbar a.run":"open_query","click .workspace_toolbar a.edit":"edit_query","click .workspace_toolbar [href=#edit_folder]":"edit_folder","click .workspace_toolbar [href=#delete_folder]":"delete_repoObject","click .workspace_toolbar [href=#delete_query]":"delete_repoObject","click .workspace_toolbar [href=#edit_permissions]":"edit_permissions","click .queries":"click_canvas","keyup .search_file":"search_file","click .cancel_search":"cancel_search"},template:function(){return _.template($("#template-open-dialog").html())()},template_repository_objects:function(e){$(this.el).find(".sidebar ul").html(_.template($("#template-repository-objects").html())({repoObjects:e}))},caption:function(){return"Repository"},render:function(){$(this.el).html(this.template()),this.tab.bind("tab:select",this.fetch_queries),this.tab.bind("tab:select",this.adjust),$(window).resize(this.adjust);var e=this,t={open:{name:"Open",i18n:!0},edit:{name:"Edit",i18n:!0},delete:{name:"Delete",i18n:!0},move:{name:"Move",i18n:!0},sep1:"---------",new:{name:"New Folder",i18n:!0},opencontents:{name:"Open Folder Contents",i18n:!0}};return $.each(t,function(e,t){recursive_menu_translate(t,Saiku.i18n.po_file)}),$.contextMenu("destroy","li.query, div.folder_row"),$.contextMenu({selector:"li.query, div.folder_row",events:{show:function(t){$(e.el).find(".selected").removeClass("selected"),$(this).addClass("selected");var i=$(this).find("a").attr("href").replace("#","");void 0!==(i=e.queries[i]).acl&&0>_.indexOf(i.acl,"WRITE")?(t.commands.delete.disabled=!0,t.items.delete.disabled=!0,t.commands.edit.disabled=!0,t.items.edit.disabled=!0,t.commands.move.disabled=!0,t.items.move.disabled=!0):(t.commands.delete.disabled=!1,t.items.delete.disabled=!1,t.commands.edit.disabled=!1,t.items.edit.disabled=!1,t.commands.move.disabled=!1,t.items.move.disabled=!1),$(this).hasClass("folder_row")?(t.commands.open.disabled=!0,t.items.open.disabled=!0):(t.commands.open.disabled=!1,t.items.open.disabled=!1)}},callback:function(t,i){var s=$(this).find("a").attr("href").replace("#",""),a=e.queries[s];e.selected_query=new SavedQuery({file:s,name:a.name,type:a.type}),"open"==t&&$(this).hasClass("query")&&e.open_query(),"edit"==t&&$(this).hasClass("query")?e.edit_query():"new"==t?e.add_folder():"delete"==t?e.delete_repoObject():"move"==t?e.move_repoObject():"opencontents"==t&&e.open_contents()},items:t}),Saiku.session.trigger("openQuery:new",{openQuery:this}),Settings.REPOSITORY_LAZY&&this.$el.find(".search_file").prop("disabled",!0),this},initialize:function(e){_.bindAll(this,"adjust","fetch_queries","clear_query","select_and_open_query","cancel_search","add_folder"),this.repository=new Repository({},{dialog:this})},fetch_queries:function(){this.repository.fetch()},populate:function(e){function t(e){_.forEach(e,function(e){i.queries[e.path]=e,"FOLDER"===e.type&&t(e.repoObjects)})}var i=this;i.template_repository_objects(e),i.queries={},t(e)},search_file:function(e){var t=$(this.el).find(".search_file").val().toLowerCase();return void 0===t||""===t||null===t||27==e.which||9==e.which?this.cancel_search():($(this.el).find(".search_file").val()?$(this.el).find(".cancel_search").show():$(this.el).find(".cancel_search").hide(),$(this.el).find("li.query").removeClass("hide"),$(this.el).find("li.query a").each(function(e){-1==$(this).text().toLowerCase().indexOf(t)&&$(this).parent("li.query").addClass("hide")}),$(this.el).find("li.folder").addClass("hide"),$(this.el).find("li.query").not(".hide").parents("li.folder").removeClass("hide"),$(this.el).find("li.folder .folder_row").find(".sprite").removeClass("collapsed"),$(this.el).find("li.folder .folder_content").removeClass("hide")),!1},cancel_search:function(e){$(this.el).find("input.search_file").val(""),$(this.el).find(".cancel_search").hide(),$(this.el).find("li.query, li.folder").removeClass("hide"),$(this.el).find(".folder_row").find(".sprite").addClass("collapsed"),$(this.el).find("li.folder .folder_content").addClass("hide"),$(this.el).find(".search_file").val("").focus(),$(this.el).find(".cancel_search").hide()},view_query:function(e){e.preventDefault();t=(e=$(e.currentTarget)).find("a");this.unselect_current_selected(),e.addClass("selected"),e=t.attr("href").replace("#","");var t=t.text(),i=this.queries[e];$(this.el).find(".workspace_toolbar").removeClass("hide"),$(this.el).find(".for_queries").addClass("hide"),$(this.el).find(".for_folder").addClass("hide"),$(this.el).find(".add_folder").parent().addClass("hide"),void 0!==i.acl&&-1<_.indexOf(i.acl,"READ")&&$(this.el).find(".for_queries .run").parent().removeClass("hide"),void 0!==i.acl&&-1<_.indexOf(i.acl,"WRITE")&&($(this.el).find(".for_queries .delete").parent().removeClass("hide"),$(this.el).find(".for_queries .edit").parent().removeClass("hide")),void 0!==i.acl&&-1<_.indexOf(i.acl,"GRANT")&&$(this.el).find(".for_queries .edit_permissions").parent().removeClass("hide");try{if(1<(n=e.split("/")).length){var s=n.splice(0,n.length-1).join("/"),a=this.queries[s];void 0!==a.acl&&-1<_.indexOf(a.acl,"WRITE")&&$(this.el).find(".add_folder").parent().removeClass("hide")}else 1==n.length&&$(this.el).find(".add_folder").parent().removeClass("hide")}catch(e){}var r,n=$(this.el).find(".workspace_results").html("<h3><strong>"+i.name+"</strong></h3>"),n=$('<ul id="query_info" />').appendTo(n);for(r in i)i.hasOwnProperty(r)&&"name"!=r&&n.append($("<li />").html("<strong>"+r+"</strong> : "+i[r]));return this.selected_query=new SavedQuery({file:e,name:t,type:i.type}),!1},view_folder:function(e){e=(t=$(e.currentTarget).children("div").children("a")).attr("href").replace("#","");var t=t.text(),i=this.queries[e];$(this.el).find(".workspace_toolbar").removeClass("hide"),$(this.el).find(".add_folder").parent().addClass("hide"),$(this.el).find(".for_queries").addClass("hide"),$(this.el).find(".for_folder").addClass("hide"),void 0!==i.acl&&-1<_.indexOf(i.acl,"WRITE")&&($(this.el).find(".for_folder .delete").parent().removeClass("hide"),$(this.el).find(".add_folder").parent().removeClass("hide")),void 0!==i.acl&&-1<_.indexOf(i.acl,"GRANT")&&$(this.el).find(".for_folder .edit_permissions").parent().removeClass("hide"),$(this.el).find(".workspace_results").html("<h3><strong>"+t+"</strong></h3>"),this.selected_query=new SavedQuery({file:e,name:t,type:i.type})},prevent_default:function(e){return e.preventDefault(),!1},add_folder:function(e){if($selected=$(this.el).find(".selected"),e="","undefined"!=typeof $selected&&$selected)if($selected.hasClass("folder_row"))e=$selected.children("a").attr("href"),e=1<e.length?e.substring(1,e.length):e,e+="/";else if($selected.hasClass("query")&&!$selected.parent().hasClass("RepositoryObjects")){var t=$selected.find("a");e=t.attr("href"),t=t.text(),e=e.substring(1,e.length-t.length)}return new AddFolderModal({path:e,success:this.clear_query}).render().open(),!1},click_canvas:function(e){return $(e.currentTarget).hasClass("sidebar")&&$(this.el).find(".selected").removeClass("selected"),$(this.el).find(".add_folder").parent().removeClass("hide"),!1},toggle_folder:function(e){var t=$(e.currentTarget),i=(i=t.children(".folder_row").find("a").attr("href")).replace("#","");this.unselect_current_selected(),t.children(".folder_row").addClass("selected");var s=t.children(".folder_content");return t.children(".folder_row").find(".sprite").hasClass("collapsed")?(t.children(".folder_row").find(".sprite").removeClass("collapsed"),s.removeClass("hide"),Settings.REPOSITORY_LAZY&&this.fetch_lazyload(t,i)):(t.children(".folder_row").find(".sprite").addClass("collapsed"),s.addClass("hide"),Settings.REPOSITORY_LAZY&&t.find(".folder_content").remove()),this.view_folder(e),!1},fetch_lazyload:function(e,t){new RepositoryLazyLoad({},{dialog:this,folder:e,path:t}).fetch(),Saiku.ui.block("Loading...")},template_repository_folder_lazyload:function(e,t){e.find(".folder_content").remove(),e.append(_.template($("#template-repository-folder-lazyload").html())({repoObjects:t}))},populate_lazyload:function(e,t){Saiku.ui.unblock(),this.template_repository_folder_lazyload(e,t)},select_and_open_query:function(e){var t=(e=$(e.currentTarget).find("a")).attr("href").replace("#","");e.text(),this.selected_query=new SavedQuery({file:t,name:t}),this.open_query()},open_query:function(e){Saiku.ui.block("Opening query...");var t=this.queries[this.selected_query.get("file")],i=_.extend({file:this.selected_query.get("file"),formatter:Settings.CELLSET_FORMATTER},Settings.PARAMS),i=new Query(i,{name:this.selected_query.get("name")}),s=null;return e&&!e.hasOwnProperty("currentTarget")&&(s=e),"saiku"===t.fileType?Saiku.tabs.add(new Workspace({query:i,item:t,viewState:s})):Saiku.session.trigger("openQuery:open_query",{query:i,item:t,viewState:s}),!1},open_contents:function(e){var t=[],i=this.queries[this.selected_query.get("file")];return _.forEach(i.repoObjects,function(e){"FILE"===e.type&&t.push(e)}),new WarningModal({title:"Open Multiple Queries",message:"You are about to open "+t.length+" queries",okay:this.run_open_contents,okayobj:{files:t,viewstate:e}}).render().open(),!1},run_open_contents:function(e){_.forEach(e.files,function(t){Saiku.ui.block("Opening query...");var i=_.extend({file:t.path,formatter:Settings.CELLSET_FORMATTER},Settings.PARAMS),i=new Query(i,{name:t.name}),s=null;e.viewstate&&!e.viewstate.hasOwnProperty("currentTarget")&&(s=viewstate),Saiku.tabs.add(new Workspace({query:i,item:t,viewState:s}))})},edit_query:function(){this.open_query("edit")},delete_repoObject:function(e){return new DeleteRepositoryObject({query:this.selected_query,success:this.clear_query}).render().open(),!1},move_repoObject:function(e){return new MoveRepositoryObject({query:this.selected_query,success:this.clear_query}).render().open(),!1},edit_folder:function(e){return alert("todo: edit folder properties/permissions"),!1},edit_permissions:function(e){new PermissionsModal({workspace:this.workspace,title:"<span class='i18n'>Permissions</span>",file:this.selected_query.get("file")}).open()},clear_query:function(){$(this.el).find(".workspace_toolbar").addClass("hide"),$(this.el).find(".workspace_results").html(""),this.fetch_queries()},adjust:function(){$separator=$(this.el).find(".sidebar_separator"),$separator.height($("body").height()-87),$(this.el).find(".sidebar").css({width:300,height:$("body").height()-87}),$(this.el).find(".workspace_inner").css({"margin-left":305}),$(this.el).find(".workspace").css({"margin-left":-305}),$(this.el).find(".workspace_results").css({width:$(document).width()-$(this.el).find(".sidebar").width()-30,height:$(document).height()-$("#header").height()-$(this.el).find(".workspace_toolbar").height()-$(this.el).find(".workspace_fields").height()-40})},toggle_sidebar:function(){$(this.el).find(".sidebar").toggleClass("hide");var e=$(this.el).find(".sidebar").hasClass("hide")?5:265;$(this.el).find(".workspace_inner").css({"margin-left":e})},unselect_current_selected:function(){$(this.el).find(".selected").removeClass("selected")}}),SaveQuery=Modal.extend({type:"save",closeText:"Save",events:{click:"select_root_folder","click .dialog_footer a":"call","submit form":"save","click .query":"select_name","click li.folder":"toggle_folder","keyup .search_file":"search_file","click .cancel_search":"cancel_search"},buttons:[{text:"Save",method:"save"},{text:"Cancel",method:"close"}],folder_name:null,file_name:null,initialize:function(e){var t=this,i="";if(e.query.name){e.query.name=e.query.name.replace(/:/g,"/");var s=e.query.name.split("/"),i=e.query.name;this.file_name=s[s.length-1],1<s.length&&(this.folder_name=s.splice(0,s.length-1).join("/"))}this.query=e.query,this.message=_.template("<form id='save_query_form'><div class=\"box-search-file\" style=\"height:25px; line-height:25px;\"><b><span class=\"i18n\">Search:</span></b> &nbsp; <span class=\"search\"><input type=\"text\" class=\"search_file\"></input><span class=\"cancel_search\"></span></span></div><div class='RepositoryObjects'><span class='i18n'>Loading...</span></div><label for='name' class='i18n'>File:</label>&nbsp;<input type='text' name='name' value='<%= name %>' /><br /></form>")({name:i}),_.extend(this.options,{title:"Save query"}),this.repository=new Repository({},{dialog:this}),this.bind("open",function(){var e=$("body").height()/2+$("body").height()/6;420<e&&(e=420);var i=($("body").height()-600)/2*100/$("body").height();$(this.el).find(".RepositoryObjects").height(e),$(this.el).dialog("option","position","center"),$(this.el).parents(".ui-dialog").css({width:"550px",top:i+"%"}),t.repository.fetch(),Settings.REPOSITORY_LAZY&&this.$el.find(".box-search-file").hide()}),_.bindAll(this,"copy_to_repository","close","toggle_folder","select_name","populate","set_name","cancel_search"),isIE&&9>isIE&&$(this.el).find("form").on("submit",this.save)},populate:function(e){$(this.el).find(".RepositoryObjects").html(_.template($("#template-repository-objects").html())({repoObjects:e})),this.context_menu_disabled(),this.select_last_location()},context_menu_disabled:function(){this.$el.find(".RepositoryObjects").find(".folder_row, .query").addClass("context-menu-disabled")},select_root_folder:function(e){"name"!==$(e.target).attr("name")&&this.unselect_current_selected_folder()},toggle_folder:function(e){var t=(t=(e=$(e.currentTarget)).children(".folder_row").find("a").attr("href")).replace("#","");this.unselect_current_selected_folder(),e.children(".folder_row").addClass("selected");var i=e.find("a").attr("href").replace("#","");return this.set_name(i,null),i=e.children(".folder_content"),e.children(".folder_row").find(".sprite").hasClass("collapsed")?(e.children(".folder_row").find(".sprite").removeClass("collapsed"),i.removeClass("hide"),Settings.REPOSITORY_LAZY&&this.fetch_lazyload(e,t)):(e.children(".folder_row").find(".sprite").addClass("collapsed"),i.addClass("hide"),Settings.REPOSITORY_LAZY&&e.find(".folder_content").remove()),this.set_last_location(t),!1},fetch_lazyload:function(e,t){new RepositoryLazyLoad({},{dialog:this,folder:e,path:t}).fetch(),Saiku.ui.block("Loading...")},template_repository_folder_lazyload:function(e,t){e.find(".folder_content").remove(),e.append(_.template($("#template-repository-folder-lazyload").html())({repoObjects:t}))},populate_lazyload:function(e,t){Saiku.ui.unblock(),this.template_repository_folder_lazyload(e,t)},set_name:function(e,t){if(null!==e){this.folder_name=e;var i=(null!==this.folder_name?this.folder_name+"/":"")+(null!==this.file_name?this.file_name:"");$(this.el).find('input[name="name"]').val(i)}null!==t&&$(this.el).find('input[name="name"]').val(t)},search_file:function(e){var t=$(this.el).find(".search_file").val().toLowerCase();return void 0===t||""===t||null===t||27==e.which||9==e.which?this.cancel_search():($(this.el).find(".search_file").val()?$(this.el).find(".cancel_search").show():$(this.el).find(".cancel_search").hide(),$(this.el).find("li.query").removeClass("hide"),$(this.el).find("li.query a").filter(function(e){return-1==$(this).text().toLowerCase().indexOf(t)}).parent().addClass("hide"),$(this.el).find("li.folder").addClass("hide"),$(this.el).find("li.query").not(".hide").parents("li.folder").removeClass("hide"),$(this.el).find("li.folder .folder_row").find(".sprite").removeClass("collapsed"),$(this.el).find("li.folder .folder_content").removeClass("hide")),!1},cancel_search:function(e){$(this.el).find("input.search_file").val(""),$(this.el).find(".cancel_search").hide(),$(this.el).find("li.query, li.folder").removeClass("hide"),$(this.el).find(".folder_row").find(".sprite").addClass("collapsed"),$(this.el).find("li.folder .folder_content").addClass("hide"),$(this.el).find(".search_file").val("").focus(),$(this.el).find(".cancel_search").hide()},select_name:function(e){e=$(e.currentTarget),this.unselect_current_selected_folder(),e.addClass("selected");var t=e.find("a").attr("href").replace("#","");return this.set_name(null,t),e=e.parent().parent().has(".folder").children(".folder_row").find("a").attr("href"),e=e.replace("#",""),this.set_last_location(e),!1},unselect_current_selected_folder:function(){$(this.el).find(".selected").removeClass("selected")},save:function(e){if(condFormatting){var t="";$.each(conditions,function(e,i){t+=i.measure+","+i.condition+","+i.value+","+i.value2+","+i.color+","+i.hideVal+","}),this.query.model.mdx+="-------------------\n"+oldmdx+"-------------------"+t.substring(0,t.length-1),this.query.model.type="QUERYMODEL",this.query.model.queryModel=oldqueryModel,queryFormatted=!1}var i=this,s=$(this.el).find('input[name="name"]').val();return null!==this.folder_name&&void 0!==this.folder_name&&0<this.folder_name.length?null!==s&&0<s.length?this.repository.fetch({success:function(t,a){var r=[];if(r.push.apply(r,i.get_files(a)),!(-1<r.indexOf(s)&&i.query.get("name")!=s))return i.query.set({name:s,folder:""}),i.query.trigger("query:save"),i.copy_to_repository(),e.stopPropagation(),e.preventDefault(),!1;new OverwriteModal({name:s,foldername:"",parent:i}).render().open()}}):alert("You need to enter a name!"):alert("You need select a folder!"),!1},save_remote:function(e,t,i){return i.query.set({name:e,folder:t}),i.query.trigger("query:save"),i.copy_to_repository(),event.preventDefault(),!1},get_files:function(e){var t=this,i=[];return _.each(e,function(e){"FOLDER"===e.type?i.push.apply(i,t.get_files(e.repoObjects)):i.push(e.path)}),i},copy_to_repository:function(){var e=this,t=this.query.get("folder")+(t=6<(t=this.query.get("name")).length&&t.indexOf(".saiku")==t.length-6?t:t+".saiku");this.query.workspace.tab.$el.find(".saikutab").text(t.replace(/^.*[\\\/]/,"").split(".")[0]),new SavedQuery({name:this.query.get("name"),file:t,content:JSON.stringify(this.query.model)}).save({},{success:this.close,error:function(t,i,s){return i&&403==i.status&&i.responseText?alert(i.responseText):e.close(),!0},dataType:"text"})},set_last_location:function(e){"undefined"!=typeof localStorage&&localStorage&&!Settings.REPOSITORY_LAZY&&(Settings.LOCALSTORAGE_EXPIRATION&&0!==Settings.LOCALSTORAGE_EXPIRATION?localStorage.setItem("last-folder",e):localStorage.clear())},select_last_location:function(){localStorage.getItem("last-folder")&&!Settings.REPOSITORY_LAZY&&$(this.el).find('a[href="\\#'+localStorage.getItem("last-folder")+'"]').parent().parent().has(".folder").children(".folder_row").find(".sprite").removeClass("collapsed").parentsUntil($("div.RepositoryObjects")).each(function(){$(this).hasClass("folder")&&($(this).children(".folder_row").find(".sprite").removeClass("collapsed"),$(this).children(".folder_content").removeClass("hide"))})}}),OpenDialog=Modal.extend({type:"save",closeText:"Open",events:{click:"select_root_folder","click .dialog_footer a":"call","click .query":"select_name","dblclick .query":"open_query","click li.folder":"toggle_folder","keyup .search_file":"search_file","click .cancel_search":"cancel_search","click .export_btn":"export_zip","change .file":"select_file"},buttons:[{id:"test",text:"Open",method:"open_query"},{text:"Cancel",method:"close"}],initialize:function(e){var t=this;this.message='<div class="box-search-file" style="height:25px; line-height:25px;"><b><span class="i18n">Search:</span></b> &nbsp; <span class="search"><input type="text" class="search_file"></input><span class="cancel_search"></span></span></div><div class=\'RepositoryObjects\'>Loading....</div><br><b><div class=\'query_name\'><span class=\'i18n\'>Please select a file.....</span></div></b><br/>',Settings.ALLOW_IMPORT_EXPORT&&(this.message+="<span class='export_zip'> </span> <b><span class='i18n'>Import or Export Files for Folder</span>: </b> <span class='i18n zip_folder'>< Select Folder... ></span> &nbsp; <input type='submit' value='Export' class='export_btn' disabled /><br/><br /><br /><form id='importForm' target='_blank' method='POST' enctype='multipart/form-data'><input type='hidden' name='directory' class='directory'/><input type='file' name='file' class='file'/><input type='submit' value='Import' class='import_btn' disabled /></form>"),_.extend(this.options,{title:"Open"}),this.selected_folder=null,this.repository=new Repository({},{dialog:this}),this.bind("open",function(){var e=$("body").height()/2+$("body").height()/6;420<e&&(e=420);var i=($("body").height()-600)/2*100/$("body").height();$(this.el).find(".RepositoryObjects").height(e),$(this.el).dialog("option","position","center"),$(this.el).parents(".ui-dialog").css({width:"550px",top:i+"%"}),$(this.el).find(".dialog_footer").find('a[href="#open_query"]').hide(),t.repository.fetch(),Settings.REPOSITORY_LAZY&&this.$el.find(".box-search-file").hide()}),_.bindAll(this,"close","toggle_folder","select_name","populate","cancel_search","export_zip","select_folder","select_file","select_last_location")},populate:function(e){function t(e){_.forEach(e,function(e){i.queries[e.path]=e,"FOLDER"===e.type&&t(e.repoObjects)})}var i=this;$(this.el).find(".RepositoryObjects").html(_.template($("#template-repository-objects").html())({repoObjects:e})),i.queries={},t(e),this.context_menu_disabled(),this.select_last_location()},context_menu_disabled:function(){this.$el.find(".RepositoryObjects").find(".folder_row, .query").addClass("context-menu-disabled")},select_root_folder:function(e){"name"!==$(e.target).attr("name")&&this.unselect_current_selected_folder()},toggle_folder:function(e){var t=(t=(e=$(e.currentTarget)).children(".folder_row").find("a").attr("href")).replace("#","");this.unselect_current_selected_folder(),e.children(".folder_row").addClass("selected");var i=e.children(".folder_content");return e.children(".folder_row").find(".sprite").hasClass("collapsed")?(e.children(".folder_row").find(".sprite").removeClass("collapsed"),i.removeClass("hide"),Settings.REPOSITORY_LAZY&&this.fetch_lazyload(e,t)):(e.children(".folder_row").find(".sprite").addClass("collapsed"),i.addClass("hide"),Settings.REPOSITORY_LAZY&&e.find(".folder_content").remove()),this.select_folder(),this.set_last_location(t),!1},fetch_lazyload:function(e,t){new RepositoryLazyLoad({},{dialog:this,folder:e,path:t}).fetch(),Saiku.ui.block("Loading...")},template_repository_folder_lazyload:function(e,t){e.find(".folder_content").remove(),e.append(_.template($("#template-repository-folder-lazyload").html())({repoObjects:t}))},populate_lazyload:function(e,t){Saiku.ui.unblock(),this.template_repository_folder_lazyload(e,t)},select_name:function(e){e=$(e.currentTarget),this.unselect_current_selected_folder();var t=(t=e.parent().parent().has(".folder").children(".folder_row").find("a").attr("href")).replace("#","");return this.set_last_location(t),e.addClass("selected"),e=e.find("a").attr("href"),e=e.replace("#",""),$(this.el).find(".query_name").html(e),$(this.el).find(".dialog_footer").find('a[href="#open_query"]').show(),this.select_folder(),!1},unselect_current_selected_folder:function(){$(this.el).find(".selected").removeClass("selected")},search_file:function(e){var t=$(this.el).find(".search_file").val().toLowerCase();return void 0===t||""===t||null===t||27==e.which||9==e.which?this.cancel_search():($(this.el).find(".search_file").val()?$(this.el).find(".cancel_search").show():$(this.el).find(".cancel_search").hide(),$(this.el).find("li.query").removeClass("hide"),$(this.el).find("li.query a").filter(function(e){return-1==$(this).text().toLowerCase().indexOf(t)}).parent().addClass("hide"),$(this.el).find("li.folder").addClass("hide"),$(this.el).find("li.query").not(".hide").parents("li.folder").removeClass("hide"),$(this.el).find("li.folder .folder_row").find(".sprite").removeClass("collapsed"),$(this.el).find("li.folder .folder_content").removeClass("hide")),!1},cancel_search:function(e){$(this.el).find("input.search_file").val(""),$(this.el).find(".cancel_search").hide(),$(this.el).find("li.query, li.folder").removeClass("hide"),$(this.el).find(".folder_row").find(".sprite").addClass("collapsed"),$(this.el).find("li.folder .folder_content").addClass("hide"),$(this.el).find(".search_file").val("").focus(),$(this.el).find(".cancel_search").hide()},export_zip:function(e){if(void 0!==(e=this.selected_folder)&&""!==e){var t=Settings.REST_URL+new RepositoryZipExport({directory:e}).url();window.open(t+"?directory="+e+"&type=saiku")}},select_folder:function(){var e=$(this.el).find(".selected");if(void 0!==(e=0<e.length?e.children("a").attr("href").replace("#",""):null)&&null!==e&&""!==e){var t=$("#importForm");t.find(".directory").val(e);var i=Settings.REST_URL+(new RepositoryZipExport).url()+"upload";t.attr("action",i),$(this.el).find(".zip_folder").text(e),this.selected_folder=e,$(this.el).find(".export_btn, .import_btn").removeAttr("disabled"),this.select_file()}else $(this.el).find(".import_btn, .export_btn").attr("disabled","true")},select_file:function(){var e=$("#importForm").find(".file").val();void 0!==e&&""!==e&&null!==e&&null!==this.selected_folder?$(this.el).find(".import_btn").removeAttr("disabled"):$(this.el).find(".import_btn").attr("disabled","true")},open_query:function(e){var t=$(e.currentTarget),i=$(this.el).find(".query_name").html();t.hasClass("query")&&(i=t.find("a").attr("href").replace("#","")),new SavedQuery({file:i}),this.close(),Saiku.ui.block("Opening query...");var t=this.queries[i],s=_.extend({file:i,formatter:Settings.CELLSET_FORMATTER},Settings.PARAMS),i=new Query(s,{name:i});return Saiku.tabs.add(new Workspace({query:i,item:t})),e.preventDefault(),!1},set_last_location:function(e){"undefined"!=typeof localStorage&&localStorage&&!Settings.REPOSITORY_LAZY&&(Settings.LOCALSTORAGE_EXPIRATION&&0!==Settings.LOCALSTORAGE_EXPIRATION?localStorage.setItem("last-folder",e):localStorage.clear())},select_last_location:function(){localStorage.getItem("last-folder")&&!Settings.REPOSITORY_LAZY&&$(this.el).find('a[href="\\#'+localStorage.getItem("last-folder")+'"]').parent().parent().has(".folder").children(".folder_row").find(".sprite").removeClass("collapsed").parentsUntil($("div.RepositoryObjects")).each(function(){$(this).hasClass("folder")&&($(this).children(".folder_row").find(".sprite").removeClass("collapsed"),$(this).children(".folder_content").removeClass("hide"))})}}),Tab=Backbone.View.extend({tagName:"li",events:{"click a":"select","mousedown a":"remove","click .close_tab":"remove"},template:function(){return _.template("<a class='saikutab' href='#<%= id %>'><%= caption %></a><span class='close_tab sprite'>Close tab</span>")({id:this.id,caption:this.caption})},initialize:function(e){_.extend(this,Backbone.Events),_.extend(this,e),this.content.tab=this,this.caption=this.content.caption(),this.id=_.uniqueId("tab_"),this.close=e.close},render:function(){var e=this;this.content.render(),$(this.el).html(this.template()),!1===this.close&&($(this.el).find(".close_tab").hide(),$(this.el).css("padding-right","10px"));var t={new:{name:"New",i18n:!0},duplicate:{name:"Duplicate",i18n:!0},closeothers:{name:"Close Others",i18n:!0},closethis:{name:"Close This",i18n:!0}};return $.each(t,function(e,t){recursive_menu_translate(t,Saiku.i18n.po_file)}),$.contextMenu("destroy",".saikutab"),$.contextMenu({selector:".saikutab",callback:function(t,i){var s=i.$trigger.attr("href").replace("#",""),s=Saiku.tabs.find(s);"closethis"==t?(s.remove(),e.select()):"closeothers"==t?(s.select(),Saiku.tabs.close_others(s)):"duplicate"==t?Saiku.tabs.duplicate(s):"new"==t&&Saiku.tabs.new_tab()},items:t}),this},set_caption:function(e){$(this.el).find(".saikutab").html(e)},destroy:function(){this.content&&this.content.query&&this.content.query.destroy()},select:function(){return this.parent.select(this),$(this.el).addClass("selected"),this.trigger("tab:select"),!1},remove:function(e){if(!e||2===e.which||$(e.target).hasClass("close_tab")){this.parent.remove(this);try{$(this.el).remove(),this.destroy()}catch(e){Log.log(JSON.stringify({Message:"Tab could not be removed",Tab:JSON.stringify(this)}))}}return!1},rendered:function(){return $.contains(document,this.el)}}),TabPager=Backbone.View.extend({className:"pager_contents",events:{"click a":"select"},initialize:function(e){this.tabset=e.tabset,$(this.el).hide().appendTo("body"),$(window).click(function(e){$(e.target).hasClass("pager_contents")||$(".pager_contents").hide()})},render:function(){for(var e="",t=0,i=this.tabset._tabs.length;t<i;t++)e+="<a href='#"+t+"'>"+this.tabset._tabs[t].caption+"</a><br />";$(this.el).html(e),$(this.el).find(".i18n").i18n(Saiku.i18n.po_file)},select:function(e){var t=$(e.target).attr("href").replace("#","");return this.tabset._tabs[t].select(),$(this.el).hide(),e.preventDefault(),!1}}),TabSet=Backbone.View.extend({className:"tabs",queryCount:0,dashCount:0,events:{"click a.pager":"togglePager","click a.new":"new_tab"},_tabs:[],render:function(){return $(this.el).html('<a href="#pager" class="pager sprite"></a><ul><li class="newtab"><a class="new">+&nbsp;&nbsp;</a></li></ul>').appendTo($("#header")),this.content=$('<div id="tab_panel">').appendTo($("body")),this.pager=new TabPager({tabset:this}),this},add:function(e,t){"dashboards"===e.pluginName?this.dashCount++:this.queryCount++;var i=new Tab({content:e,close:t});return this._tabs.push(i),i.parent=this,i.render().select(),$(i.el).insertBefore($(this.el).find("ul li.newtab")),Saiku.session.trigger("tab:add",{tab:i}),this.pager.render(),Saiku.i18n.translate(),Saiku.session.trigger("workspace:toolbar:render",null),i},find:function(e){for(var t=0,i=this._tabs.length;t<i;t++)if(this._tabs[t].id==e)return this._tabs[t];return null},select:function(e){$(this.el).find("li").removeClass("selected"),Saiku.session.tabSelected=e.id,Saiku.session.trigger("tab:select",{tab:e}),this.content.children().detach(),this.content.append($(e.content.el))},remove:function(e){for(var t=0,i=this._tabs.length;t<i;t++)this._tabs[t]==e&&(this._tabs.splice(t,1),Saiku.session.trigger("tab:remove",{tab:e}),this.pager.render(),this._tabs[this._tabs[t]?t:this._tabs.length-1].select());return!0},close_others:function(e){var t=_.indexOf(this._tabs,e);for(this._tabs[t].select(),t=0;1<this._tabs.length;)this._tabs[t]!=e?this._tabs[t].remove():t++},close_all:function(){for(var e=0,t=this._tabs.length;e<t;e++)this._tabs[e].remove()},togglePager:function(){return $(this.pager.el).toggle(),!1},new_tab:function(){return this.add(new Workspace),this._tabs[this._tabs.length-1].select(),!1},duplicate:function(e){return Saiku.ui.block("Duplicating tab..."),e.content.query?this.add(new Workspace({query:new Query({json:JSON.stringify(e.content.query.model)},Settings.PARAMS),viewState:e.content.viewState})):this.add(new Workspace),Saiku.ui.unblock(),!1}}),RepositoryUrl="api/repository",repoPathUrl=function(){return Settings.BIPLUGIN?"pentaho/repository":RepositoryUrl},RepositoryObject=Backbone.Model.extend({initialize:function(e,t){t&&t.dialog&&(this.dialog=t.dialog,this.file=t.file)},parse:function(e){if(this.dialog)return this.dialog.generate_grids_reports(e),e},url:function(){return this.file?repoPathUrl()+"/resource?file="+this.file:repoPathUrl()+"/resource"}}),RepositoryAclObject=Backbone.Model.extend({url:function(){return repoPathUrl()+"/resource/acl"},parse:function(e){"OK"!=e&&_.extend(this.attributes,e)}}),RepositoryZipExport=Backbone.Model.extend({url:function(){return repoPathUrl()+"/zip"}}),SavedQuery=Backbone.Model.extend({parse:function(e){},url:function(){return repoPathUrl()+"/resource"},move_query_to_workspace:function(e,t){var i,s=t,a=e.get("file");for(i in Settings)if("PARAM"==i.match("^PARAM"))var r=i.substring(5,i.length),n=new RegExp("\\$\\{"+r+"\\}","g"),r=new RegExp("\\$\\{"+r.toLowerCase()+"\\}","g"),s=s.replace(n,Settings[i]),s=s.replace(r,Settings[i]);s=new Query({xml:s,formatter:Settings.CELLSET_FORMATTER},{name:a}),Saiku.tabs.add(new Workspace({query:s}))}}),Repository=Backbone.Collection.extend({model:SavedQuery,file:null,initialize:function(e,t){t&&t.dialog&&(this.dialog=t.dialog,this.type=t.type)},parse:function(e){return this.dialog&&this.dialog.populate(e),e},url:function(){var e=repoPathUrl()+"?type="+(this.type?this.type:"saiku,sdb");return Settings.REPO_BASE&&!this.file&&(e+="&path="+Settings.REPO_BASE),e}}),RepositoryLazyLoad=Backbone.Model.extend({url:function(){return repoPathUrl()+"?type="+(this.type?this.type:"saiku")+"&path="+this.path},initialize:function(e,t){t&&t.dialog&&(this.dialog=t.dialog,this.folder=t.folder,this.path=t.path)},parse:function(e){return this.dialog&&this.dialog.populate_lazyload(this.folder,e),e}}),Result=Backbone.Model.extend({result:null,firstRun:!1,initialize:function(e,t){this.query=t.query},parse:function(e){this.query.workspace.unblock(),this.query.workspace.processing.hide(),this.result=e,e.error||(this.query.model=_.extend({},e.query)),this.firstRun=!0,this.query.workspace.trigger("query:result",{workspace:this.query.workspace,data:e})},hasRun:function(){return this.firstRun},lastresult:function(){return this.result},url:function(){return"api/query/execute"}}),QueryAction=Backbone.Model.extend({initialize:function(e,t){this.query=t.query,this.url=this.query.url},gett:function(e,t){this.handle("fetch",e,t)},post:function(e,t){this.handle("save",e,t)},put:function(e,t){this.id=_.uniqueId("queryaction_"),this.handle("save",e,t),delete this.id},del:function(e,t){this.id=_.uniqueId("queryaction_"),this.handle("delete",e,t),delete this.id},handle:function(e,t,i){this.url=this.query.url()+t,this.attributes=i.data?i.data:{},"save"==e?this.save({},i):"delete"==e?(this.set("id",this.id),this.destroy(i)):"fetch"==e&&(this.parse=function(){},this.fetch(i))}}),QueryScenario=Backbone.Model.extend({initialize:function(e,t){_.bindAll(this,"attach_listeners","activate","clicked_cell","save_writeback","cancel_writeback","check_input"),this.query=t.query},activate:function(){$(this.query.workspace.el).find("td.data").unbind("click").addClass("cellhighlight").click(this.clicked_cell)},attach_listeners:function(e){e.workspace.query&&e.workspace.query.properties&&"true"===e.workspace.query.properties.properties["org.saiku.connection.scenario"]&&$(e.workspace.el).find(".query_scenario").hasClass("on")&&$(e.workspace.el).find("td.data").click(this.clicked_cell)},clicked_cell:function(e){var t=(e=$(e.target).hasClass("data")?$(e.target).find("div"):$(e.target)).attr("alt");e.attr("rel"),t=$("<input type='text' value='"+t+"' />").keyup(this.check_input).blur(this.cancel_writeback),e.html("").append(t),t.focus()},check_input:function(e){return 13==e.which?this.save_writeback(e):27!=e.which&&9!=e.which||this.cancel_writeback(e),!1},save_writeback:function(e){e=$(e.target).closest("input"),this.set({value:e.val(),position:e.parent().attr("rel")}),this.save();var t=e.val();e.parent().text(t)},cancel_writeback:function(e){(e=$(e.target).closest("input")).parent().text(e.parent().attr("alt"))},parse:function(){this.query.run()},url:function(){return this.query.url()+"/cell/"+this.get("position")+"/"+this.get("value")}}),Query=Backbone.Model.extend({formatter:Settings.CELLSET_FORMATTER,properties:null,initialize:function(e,t){_.extend(this,t),_.bindAll(this,"run"),this.uuid="xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}).toUpperCase(),this.model=_.extend({name:this.uuid},SaikuOlapQueryTemplate),e.cube&&(this.model.cube=e.cube),this.helper=new SaikuOlapQueryHelper(this),this.action=new QueryAction({},{query:this}),this.result=new Result({limit:Settings.RESULT_LIMIT},{query:this}),this.scenario=new QueryScenario({},{query:this})},parse:function(e){this.id=this.uuid,e.name&&(this.uuid=this.id=e.name),this.model=_.extend(this.model,e),this.model.properties=_.extend({},Settings.QUERY_PROPERTIES,this.model.properties)},setProperty:function(e,t){this.model.properties[e]=t},getProperty:function(e){return this.model.properties[e]},run:function(e,t){var i=this;if(Saiku.ui.unblock(),void 0===this.model.properties||!1!==this.model.properties["saiku.olap.query.automatic_execution"]||!1!==e&&void 0!==e&&null!==e){this.workspace.unblock(),$(this.workspace.el).find(".workspace_results_info").empty(),this.workspace.trigger("query:run"),this.result.result=null;var s,a=!1,r="Query Validation failed!",n=this.helper.model();for(s in this.attributes){var o=this.attributes[s];if("PARAM"===s.substring(0,5)){var l=s.substring(5,s.length);n.parameters[l]=o}}"OLAP"==n.queryType&&("QUERYMODEL"==n.type?(s=0<Object.keys(n.queryModel.axes.COLUMNS.hierarchies).length,o=0<Object.keys(n.queryModel.axes.ROWS.hierarchies).length,l="COLUMNS"==n.queryModel.details.axis&&0<n.queryModel.details.measures.length,o&&s&&l||(r=""),s||l||(r+='<span class="i18n">You need to include at least one measure or a level on columns for a valid query.</span>'),o||(r+='<span class="i18n">You need to include at least one level on rows for a valid query.</span>'),(s||l)&&o&&(a=!0)):"MDX"==n.type&&((a=n.mdx&&0<n.mdx.length)||(r='<span class="i18n">You need to enter some MDX statement to execute.</span>'))),a?(this.workspace.table.clearOut(),$(this.workspace.processing).html('<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Running query...</span> [&nbsp;<a class="cancel i18n" href="#cancel">Cancel</a>&nbsp;]').show(),this.workspace.adjust(),this.workspace.trigger("query:fetch"),Saiku.i18n.translate(),this.workspace.block('<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Running query...</span> [&nbsp;<a class="cancel i18n" href="#cancel">Cancel</a>&nbsp;]'),this.result.save({},{contentType:"application/json",data:JSON.stringify(n),error:function(){Saiku.ui.unblock(),i.workspace.table.clearOut(),$(i.workspace.processing).html('<span class="i18n">Error executing query. Please check the server logs or contact your administrator!</span>').show(),i.workspace.adjust(),Saiku.i18n.translate()}})):(this.workspace.table.clearOut(),$(this.workspace.processing).html(r).show(),this.workspace.adjust(),Saiku.i18n.translate())}},enrich:function(){var e=this;this.workspace.query.action.post("/../enrich",{contentType:"application/json",data:JSON.stringify(e.model),async:!1,success:function(t,i){e.model=i}})},url:function(){return"api/query/"+encodeURI(this.uuid)}}),Session=Backbone.Model.extend({username:null,password:null,sessionid:null,upgradeTimeout:null,isAdmin:!1,id:null,initialize:function(e,t){_.extend(this,Backbone.Events),_.bindAll(this,"check_session","process_session","load_session","login","brute_force"),t&&t.username&&t.password?(this.username=t.username,this.password=t.password,Settings.DEMO?this.check_session():this.save({username:this.username,password:this.password},{success:this.check_session,error:this.check_session})):this.check_session()},check_session:function(){null===this.sessionid||null===this.username||null===this.password?(this.clear(),this.fetch({success:this.process_session,error:this.brute_force})):(this.username=encodeURIComponent(options.username),this.load_session())},brute_force:function(e,t){this.clear(),this.fetch({success:this.process_session,error:this.show_error})},show_error:function(e,t){Saiku.ui.unblock(),this.form=new SessionErrorModal({issue:t.responseText}),this.form.render().open()},load_session:function(){this.sessionworkspace=new SessionWorkspace},process_session:function(e,t){return null===t||null==t.sessionid?(Saiku.ui.unblock(),this.form=Settings.DEMO?new DemoLoginForm({session:this}):new LoginForm({session:this}),this.form.render().open()):(this.sessionid=t.sessionid,this.roles=t.roles,this.isAdmin=t.isadmin,this.username=encodeURIComponent(t.username),this.language=t.language,void 0!==this.language&&this.language!=Saiku.i18n.locale&&(Saiku.i18n.locale=this.language,Saiku.i18n.automatic_i18n()),(new License).fetch_license("api/license/",function(e){"success"===e.status&&(Settings.LICENSE=e.data.toJSON()),Saiku.session.isAdmin&&(new LicenseQuota).fetch_quota("api/license/quota",function(e){"success"===e.status&&(Settings.LICENSEQUOTA=e.data.toJSON())})}),this.load_session()),this},error:function(){$(this.form.el).dialog("open")},login:function(e,t){var i=this;this.save({username:e,password:t},{dataType:"text",success:this.check_session,error:function(e,t){i.login_failed(t.responseText)}})},login_failed:function(e){this.form=new LoginForm({session:this}),this.form.render().open(),this.form.setError(e)},logout:function(){Saiku.ui.unblock(),$("#header").empty().hide(),$("#tab_panel").remove(),Saiku.tabs=new TabSet,Saiku.toolbar.remove(),Saiku.toolbar=new Toolbar,"undefined"!=typeof localStorage&&localStorage&&localStorage.clear(),this.set("id",_.uniqueId("queryaction_")),this.destroy({async:!1}),this.clear(),this.roles=this.password=this.username=this.sessionid=null,this.isAdmin=!1,this.destroy({async:!1}),document.location.reload(!1),delete this.id},url:function(){return"session"}}),SessionErrorModal=Modal.extend({initialize:function(e,t){_.extend(this.options,{title:"Error"}),this.reportedissue=e.issue,this.message="There has been an error creating a session:<br>"+this.reportedissue},events:{"click a":"close"},dummy:function(){return!0},type:"info"}),SplashScreen=Backbone.View.extend({events:{"click .run_query":"run_query","click .run_dashboards":"run_dashboard"},initialize:function(e){_.bindAll(this,"caption"),_.extend(this,Backbone.Events)},run_query:function(){return Saiku.tabs.add(new Workspace),!1},run_dashboard:function(){if(void 0===Saiku.Dashboards)alert("Please upgrade to Saiku Enterprise for Dashboards");else{var e=_.find(Saiku.tabs._tabs,function(e){return e.content instanceof Dashboards});e?e.select():Saiku.tabs.add(new Dashboards)}return!1},template:function(){var e=$("<div> <div id='splash'> <nav> <ul> <li class='active'><a class='welcome' href='#'>Welcome</a></li> <li><a class='features' href='#'>Features</a></li> <li><a class='help' href='#'>Get Help</a></li> <li class='enterprisetoggle enterprise'><a class='enterprise' href='#'>Enterprise</a></li> </ul> <h2>Explore Data. Visualise. Act.</h2> </nav> <section class='stabs'> <section style='margin-top:50px;min-height:700px;' id='welcome'> <div style='width:50%;float:left;'> <h1 class='saikulogo'>Saiku</h1> <p>Saiku has the power to change the way you think about your business and make decisions.   Saiku provides powerful, web based analytics for everyone in your organisation. Quickly and easily analyse data from any data  source to discover what is really happening inside and outside your organisation.   </p> <h2>Quick Links</h2> <ul class='quicklinks'> <li><a class='run_query' href='#'>Create a new query</a></li> <li><a href='#' title='Dashboards' class='run_dashboards'>Create a dashboard</a></li> <li>  <a href='http://saiku.meteorite.bi' target='_blank'>Visit the website</a></li> <li><a href='http://jira.meteorite.bi' target='_blank'>Report a bug</a></li> </ul> <p class='fixed'><a class='enterprisetoggle button' href='http://meteorite.bi' target='_blank'>Get Enterprise</a></p> <h2>News</h2> <div id='news'></div> </div> <div style='width:40%;margin-left:10%;float:left;' id='dyn_content' class='enterprisetoggle'> <h2>Discover more about Saiku</h2><p>Saiku Analytics provides both a Community Version and an Enterprise Version with added features. To find out more you can <a href='http://meteorite.bo'>visit our website</a> or watch the videos on our <a href='https://www.youtube.com/channel/UChivLeroOJx0_JamfuZ_XHA'>Youtube channel</a>.</p><p>If you are using Saiku Analytics in a business or commercial product, you can help give back in many ways. Swing by our <a href='http://webchat.freenode.net/?channels=##saiku'IRC channel</a> and help foster the community, join the <a href='http://community.meteorite.bi'>mailing lists</a> and ask/answer questions, <a href='http://meteorite.bi'>sponsor a new feature</a>, or best of all <a href='http://www.meteorite.bi/saiku-pricing'>purchase an EE license</a>, which funds development of Saiku Community Edition along with Enterprise Edition.</p><div></div> </div> </section> <section style='display:none !important;margin-top:50px' id='features'> <h1 class='saikulogo'>Saiku</h1> <h2>Features</h2> <h3>Web Based Analysis</h3> <p>Saiku provides the user with an entirely browser based experience. We support all modern browsers, and our user interface is 100% HTML and Javascript. <br/>Saiku uses REST based communications, this allows the development of custom user interfaces and facilitates the easy integration of the Saiku Server into other applications and services.</p> <h3>Standards Compliant</h3> <p>Saiku is based upon the Microsoft MDX query language and will work on most JDBC compliant data sources. We also provide a number of connectors to NOSQL data sources.</p> <h3>Dynamic charting</h3> <p>Saiku uses a flexible charting engine to provide a wide range of charts and graphs. These are all HTML & Javascript only and don't require flash to be installed on the computer.</p> <h3>Pluggable visualisation engine</h3> <p>Saiku Enterprise boasts a fully pluggable visualisation engine. This allows developers to build third party extensions and plug them into Saiku Enterprise to extend or replace the existing visualisations.</p> </section> <section style='display:none !important;margin-top:50px' id='help'> <h1 class='saikulogo'>Saiku</h1> <h2>Help</h2> <p>We provide Training, Consulting and Support to ensure you get the most from Saiku and your data. Our services cover all aspects of data analysis including data strategy, design, architecture, deployment and application/software support.</p> <table style='margin-bottom:100px;'> <tr> <th>Wiki</th> <th>Support</th> </tr> <tr> <td>Why not try our new <a href='http://wiki.meteorite.bi' target='_blank'>Wiki site</a><br/>for community documentation.</td> <td>If you require more, <br/><a href='mailto:info@meteorite.bi'>contact us</a> for support!.</td> </tr> </table> </section> <section style='display:none !important;margin-top:50px' id='enterprise'> <h1 class='saikulogo'>Saiku</h1> <h2>Enterprise</h2> <p>Saiku Enterprise is our fully supported and tested server and Pentaho plugin system. Buy Saiku Enterprise from as little as $15 per user per month and enjoy the addtional features Saiku Enterprise has to offer</p> <p>To find out more visit our <a href='http://meteorite.bi' target='_blank'>site</a> or <a href='mailto:info@meteorite.bi'>schedule a call</a> with one of us and we can show you why you should choose Saiku Enterprise!</p> </section> </section> </div> </div>").html()||"";return _.template(e)({})},setupPage:function(e){e=$(window).height(),$("body").height(e),$(".stabs section").each(function(){$(this).height()}),e=$("nav li.active a").attr("class"),$("#"+e).fadeIn()},render:function(){return new License,$(this.el).html(this.template()),void 0!=Settings.LICENSE.licenseType&&"trial"!=Settings.LICENSE.licenseType&&"Open Source License"!=Settings.LICENSE.licenseType&&$(this.el).find(".enterprisetoggle").css("visibility","hidden"),this.getContent(),this.getNews(),this.setupPage(this),$("nav li a").click(function(){var e=$(this).attr("class");$("nav li").removeClass("active"),$(this).parent().addClass("active"),$(".stabs section").hide(),$("#"+e).fadeIn()}),this},remove:function(){$(this.el).remove()},caption:function(e){return"Home"},getNews:function(){var e=this;$.ajax({type:"GET",url:"http://meteorite.bi/news.json",async:!1,contentType:"application/json",dataType:"jsonp",jsonpCallback:"jsonCallback",success:function(t){for(var i=0;i<t.item.length;i++)$(e.el).find("#news").append("<h4 style='margin-left: 0.5%;color:#6D6E71;'>"+t.item[i].title+"</h4><strong style='margin-left: 0.5%;color:#6D6E71;'>"+t.item[i].date+"</strong><br/><p style='color:#6D6E71;'>"+t.item[i].body+"</p>")},error:function(e){console.log(e.message)}})},getContent:function(){var e=this;new License,$.ajax({type:"GET",url:"http://meteorite.bi/content.json",async:!1,contentType:"application/json",dataType:"jsonp",jsonpCallback:"jsonCallback2",cache:!0,success:function(t){$(e.el).find("#dyn_content").html(t.item[0].content),$(e.el).find(".responsive-container").fitVids(),$(self.el).html(e.template()),"trial"!=Settings.LICENSE.licenseType&&"Open Source License"!=Settings.LICENSE.licenseType&&$(self.el).find(".enterprisetoggle").css("visibility","hidden")},error:function(e){$(self.el).html(self.template()),"trial"!=Settings.LICENSE.licenseType&&"Open Source License"!=Settings.LICENSE.licenseType&&$(self.el).find(".enterprisetoggle").css("visibility","hidden")}})}}),SessionWorkspace=Backbone.Model.extend({initialize:function(e,t){_.extend(this,Backbone.Events),_.bindAll(this,"process_datasources","prefetch_dimensions"),this.initialized=!1,this.first=!0,"undefined"!=typeof localStorage&&localStorage&&(Settings.LOCALSTORAGE_EXPIRATION&&0!==Settings.LOCALSTORAGE_EXPIRATION||localStorage.clear(),localStorage.getItem("expiration")&&localStorage.getItem("expiration")<=(new Date).getTime()?localStorage.clear():localStorage.getItem("saiku-version")&&localStorage.getItem("saiku-version")===Settings.VERSION||(localStorage.clear(),localStorage.setItem("saiku-version",Settings.VERSION))),Saiku.ui.block("Loading datasources...."),this.fetch({success:this.process_datasources},{})},refresh:function(){"undefined"!=typeof localStorage&&localStorage&&localStorage.clear(),this.clear(),"undefined"!=typeof localStorage&&localStorage&&localStorage.setItem("saiku-version",Settings.VERSION),this.fetch({success:this.process_datasources},{})},destroy:function(){return"undefined"!=typeof localStorage&&localStorage&&localStorage.clear(),!1},process_datasources:function(e,t){if("undefined"!=typeof localStorage&&localStorage&&null===localStorage.getItem("session")){localStorage.setItem("session",JSON.stringify(t));var i=(new Date).getTime()+Settings.LOCALSTORAGE_EXPIRATION;"undefined"!=typeof localStorage&&localStorage&&localStorage.setItem("expiration",i)}this.cube_navigation=_.template($("#template-cubes").html())({connections:t}),this.cube={},this.connections=t,_.delay(this.prefetch_dimensions,20),this.initialized?Settings.INITIAL_QUERY||Saiku.tabs.add(new Workspace):($(Saiku.toolbar.el).prependTo($("#header")),$("#header").show(),Saiku.ui.unblock(),Saiku.tabs.render(),Saiku.events.trigger("session:new",{session:this}),i=Saiku.URLParams.paramsURI(),_.has(i,"splash")?(_.has(i,"splash")&&i.splash||_.has(i,"splash")&&null===i.splash)&&(i.splash=!0):i.splash=!0,!Settings.INITIAL_QUERY&&i.splash?Saiku.tabs.add(new Workspace):Settings.INITIAL_QUERY||Saiku.tabs.add(new Workspace))},prefetch_dimensions:function(){for(var e=0,t=this.connections.length;e<t;e++)for(var i=this.connections[e],s=0,a=i.catalogs.length;s<a;s++)for(var r=i.catalogs[s],n=0,o=r.schemas.length;n<o;n++)for(var l=r.schemas[n],d=0,c=l.cubes.length;d<c;d++){var h=i.name+"/"+r.name+"/"+(""===l.name||null===l.name?"null":l.name)+"/"+encodeURIComponent(l.cubes[d].name);"undefined"!=typeof localStorage&&localStorage&&null!==localStorage.getItem("cube."+h)?this.cube[h]=new Cube(JSON.parse(localStorage.getItem("cube."+h))):(this.cube[h]=new Cube({key:h}),!0===Settings.DIMENSION_PREFETCH&&this.cube[h].fetch())}!this.initialized&&Backbone.history&&(Backbone.history.start(),this.initialized=!0)},url:function(){return this.first?(this.first=!1,encodeURI(Saiku.session.username+"/discover")):encodeURI(Saiku.session.username+"/discover/refresh")}}),Member=Backbone.Model.extend({initialize:function(e,t){this.cube=t.cube;var i=t.dimension.split("/");this.hierarchy=decodeURIComponent(i[0]),this.level=decodeURIComponent(i[1])},url:function(){return encodeURI(Saiku.session.username+"/discover/")+this.cube+"/hierarchies/"+encodeURIComponent(this.hierarchy)+"/levels/"+encodeURIComponent(this.level)}}),Plugin=Backbone.Model.extend({}),PluginCollection=Backbone.Collection.extend({model:Plugin,url:"info"}),SettingsOverride=Backbone.Model.extend({}),SettingsOverrideCollection=Backbone.Collection.extend({model:SettingsOverride,url:"info/ui-settings"}),License=Backbone.Model.extend({url:"api/license",initialize:function(){_.bindAll(this,"fetch_license")},fetch_license:function(e,t){this.fetch({success:function(e){t&&"function"==typeof t&&t({status:"success",data:e})},error:function(e){t&&"function"==typeof t&&t({status:"error",data:e})}})}}),LicenseUserModel=Backbone.Model.extend({url:"api/license/users"}),LicenseUsersCollection=Backbone.Collection.extend({url:"api/license/users",model:LicenseUserModel}),LicenseQuota=Backbone.Model.extend({url:"api/license/quota",initialize:function(){_.bindAll(this,"fetch_quota")},fetch_quota:function(e,t){this.fetch({success:function(e){t&&"function"==typeof t&&t({status:"success",data:e})},error:function(e){t&&"function"==typeof t&&t({status:"error",data:e})}})}}),Saiku={toolbar:{},tabs:new TabSet,splash:new SplashScreen,session:null,events:_.extend({},Backbone.Events),routers:[],leaflet:"undefined"!=typeof L?L:{},ui:{block:function(e){$(".processing_message").html(e),$(".processing_message").removeClass("i18n_translated").addClass("i18n"),Saiku.i18n.translate(),$(".processing,.processing_container").show()},unblock:function(){$(".processing,.processing_container, .blockOverlay").hide(),$(".blockUI").fadeOut("slow")}},log:function(e,t){console&&console.log&&(console.log("Logging for: "+e),t&&console.log(t))},error:function(e,t){console&&console.error&&(console.error("Logging for: "+e),console.error(t))},URLParams:{buildValue:function(e){return/^\s*$/.test(e)?null:/^(true|false)$/i.test(e)?"true"===e.toLowerCase():isFinite(e)?parseFloat(e):e},paramsURI:function(){var e,t,i={},s=window.location.search.substr(1).split("&"),a=s.length;if(1<window.location.search.length)for(e=0;e<a;e++)t=s[e].split("="),i[decodeURIComponent(t[0])]=1<t.length?this.buildValue(decodeURIComponent(t[1])):null;return i},equals:function(){var e=Array.prototype.slice.call(arguments),t=this.paramsURI();return!!_.isEqual(t,e[0])}},loadCSS:function(e,t){var i=window.document.createElement("link"),s=window.document.getElementsByTagName("script")[0];return i.rel="stylesheet",i.href=e,i.media="only x",s.parentNode.insertBefore(i,s),setTimeout(function(){i.media=t||"all"}),i},loadJS:function(e,t){var i=window.document.createElement("script"),s=window.document.getElementsByTagName("script")[0];return i.src=e,i.async=!0,s.parentNode.insertBefore(i,s),t&&"function"==typeof t&&(i.onload=t),i},toPattern:function(e,t){var i,s=("object"==typeof t?t.pattern:t).split(""),a=e.toString().replace(/[^0-9a-zA-Z]/g,""),r=0,n=s.length;for(i=0;i<n&&!(r>=a.length);i++)"9"===s[i]&&a[r].match(/[0-9]/)||"A"===s[i]&&a[r].match(/[a-zA-Z]/)||"S"===s[i]&&a[r].match(/[0-9a-zA-Z]/)?s[i]=a[r++]:"9"!==s[i]&&"A"!==s[i]&&"S"!==s[i]||(s=s.slice(0,i));return s.join("").substr(0,i)}};Saiku.singleton=function(){var e;return Saiku.singleton=function(){if(e)return e;e=this,this.set=function(e){this.data=e},this.get=function(){return this.data}},Saiku.singleton}(),Backbone.emulateHTTP=!1,Settings.BIPLUGIN||$(document).ready(function(){var e=new PluginCollection;e.fetch({success:function(){var t=new SettingsOverrideCollection;t.fetch({success:function(){var i=e.size(),s=0;e.each(function(e){if(s+=1,"js/saiku/plugins/I18n/plugin.js"!=e.attributes.path)jQuery.ajax({async:!1,type:"GET",url:e.attributes.path,data:null,success:function(){if(s==i){var e=t.size(),a=0;t.each(function(t){a+=1;for(var i in t.attributes)Settings[i]=t.attributes[i];void 0!=Settings.CSS&&Saiku.loadCSS(Settings.CSS,null),e==a&&(Saiku.session=new Session({},{username:Settings.USERNAME,password:Settings.PASSWORD}),Saiku.toolbar=new Toolbar)})}},dataType:"script"});else if(s==i){var a=t.size(),r=0;t.each(function(e){r+=1;for(var t in e.attributes)Settings[t]=e.attributes[t];void 0!=Settings.CSS&&Saiku.loadCSS(Settings.CSS,null),a==r&&(Saiku.session=new Session({},{username:Settings.USERNAME,password:Settings.PASSWORD}),Saiku.toolbar=new Toolbar)})}})},error:function(){var t=e.size(),i=0;e.each(function(e){i+=1,"js/saiku/plugins/I18n/plugin.js"!=e.attributes.path?jQuery.ajax({async:!1,type:"GET",url:e.attributes.path,data:null,success:function(){i==t&&(void 0!=Settings.CSS&&Saiku.loadCSS(Settings.CSS,null),Saiku.session=new Session({},{username:Settings.USERNAME,password:Settings.PASSWORD}),Saiku.toolbar=new Toolbar)},dataType:"script"}):i==t&&(void 0!=Settings.CSS&&Saiku.loadCSS(Settings.CSS,null),Saiku.session=new Session({},{username:Settings.USERNAME,password:Settings.PASSWORD}),Saiku.toolbar=new Toolbar)})}})}})});var SaikuTimeLogger=function(e){this._element=$(e),this._timestamps=[],this._events=[]};SaikuTimeLogger.prototype.log=function(e){var t=(new Date).getTime();if(e||(e="Unknown"),0<this._timestamps.length){var i=this._timestamps[this._timestamps.length-1];1<t-i&&this._element.append("<div>"+(t-i)+" ms "+e+"  (previous: "+this._events[this._events.length-1]+" )</div>")}this._timestamps.push(t),this._events.push(e)};var DateFilterModal=Modal.extend({type:"date-filter",buttons:[{text:"Clear",method:"clear_date_filter"},{text:"Save",method:"save"},{text:"Open Standard Filter",method:"open_standard_filter"},{text:"Cancel",method:"finished"},{text:"Help",method:"help"}],events:{"click a":"call","focus .selection-date":"selection_date","click .selection-radio":"disable_divselections","click .operator-radio":"show_fields","click #add-date":"add_selected_date","click .del-date":"del_selected_date"},template_days_mdx:"Filter({parent}.Members, {parent}.CurrentMember.NAME {comparisonOperator} '{dates}'",template_many_years_mdx:" {logicalOperator} {parent}.CurrentMember.NAME {comparisonOperator} '{dates}'",template_mdx:"IIF(ISEMPTY(CurrentDateMember([{dimension}.{hierarchy}], '[\"{dimension}.{hierarchy}\"]\\.{analyzerDateFormat}', EXACT)), {}, { {parent} CurrentDateMember([{dimension}.{hierarchy}], '[\"{dimension}.{hierarchy}\"]\\.{analyzerDateFormat}', EXACT)})",template_last_mdx:"{parent} LastPeriods({periodAmount}, CurrentDateMember([{dimension}.{hierarchy}], '[\"{dimension}.{hierarchy}\"]\\.{analyzerDateFormat}', EXACT))",template_dialog:_.template('<div class="box-selections"><div class="selection-option"><input type="radio" class="selection-radio" name="selection-radio" id="selection-radio-operator" level-type="TIME_DAYS" disabled></div><div class="available-selections" selection-name="operator" available="false"><span class="i18n">Operator:</span><br><div class="selection-options"><div class="form-group-selection"><label><input type="radio" name="operator-radio" class="operator-radio" id="op-equals" value="=" data-operator="equals"> <span class="i18n">Equals</span></label></div><div class="form-group-selection"><label><input type="radio" name="operator-radio" class="operator-radio" id="op-after" value=">" data-operator="after"> <span class="i18n">After</span></label></div><div class="form-group-selection"><label><input type="radio" name="operator-radio" class="operator-radio" id="op-before" value="<" data-operator="before"> <span class="i18n">Before</span></label></div><div class="form-group-selection"><label><input type="radio" name="operator-radio" class="operator-radio" id="op-between" value=">=|<=" data-operator="between"> <span class="i18n">Between</span></label><br></div><div class="form-group-selection"><label><input type="radio" name="operator-radio" class="operator-radio" id="op-different" value="<>" data-operator="different"> <span class="i18n">Different</span></label></div><div class="form-group-selection"><label><input type="radio" name="operator-radio" class="operator-radio" id="op-after-equals" value=">=" data-operator="after&equals"> <span class="i18n">After&amp;Equals</span></label></div><div class="form-group-selection"><label><input type="radio" name="operator-radio" class="operator-radio" id="op-before-equals" value="<=" data-operator="before&equals"> <span class="i18n">Before&amp;Equals</span></label></div><div class="form-group-selection"><label><input type="radio" name="operator-radio" class="operator-radio" id="op-notbetween" value=">=||<=" data-operator="notbetween"> <span class="i18n">Not Between</span></label><br></div><div class="inline-form-group"><div class="form-group" id="div-selection-date" hidden><label>Select a date:</label><input type="text" class="selection-date" id="selection-date" placeholder="Choose a date"><a class="form_button" id="add-date">add</a></div><div class="form-group" id="div-selected-date" hidden><fieldset><legend>Selected date:</legend><ul id="selected-date"></ul></fieldset></div></div><div class="form-group" id="div-select-start-date" hidden><label>Select a start date:</label><input type="text" class="selection-date" id="start-date" placeholder="Choose a date"></div><div class="form-group" id="div-select-end-date" hidden><label>Select an end date:</label><input type="text" class="selection-date" id="end-date" placeholder="Choose a date"></div></div></div></div><div class="box-selections"><div class="selection-option"><input type="radio" class="selection-radio" name="selection-radio" id="selection-radio-fixed-date"></div><div class="available-selections" selection-name="fixed-date" available="false"><span class="i18n">Fixed Date:</span><br><div class="selection-options"><div class="form-group-selection"><label><input type="radio" name="fixed-radio" id="fd-yesterday" data-leveltype="TIME_DAYS"> <span class="i18n">Yesterday</span></label></div><div class="form-group-selection"><label><input type="radio" name="fixed-radio" id="fd-today" data-leveltype="TIME_DAYS"> <span class="i18n">Today</span></label></div><div class="form-group-selection"><label><input type="radio" name="fixed-radio" id="fd-week" data-leveltype="TIME_WEEKS"> <span class="i18n">Current Week</span></label></div><div class="form-group-selection"><label><input type="radio" name="fixed-radio" id="fd-month" data-leveltype="TIME_MONTHS"> <span class="i18n">Current Month</span></label></div><div class="form-group-selection"><label><input type="radio" name="fixed-radio" id="fd-quarter" data-leveltype="TIME_QUARTERS"> <span class="i18n">Current Quarter</span></label><br></div><div class="form-group-selection"><label><input type="radio" name="fixed-radio" id="fd-year" data-leveltype="TIME_YEARS"> <span class="i18n">Current Year</span></label></div></div></div></div><div class="box-selections"><div class="selection-option"><input type="radio" class="selection-radio" name="selection-radio" id="selection-radio-available"></div><div class="available-selections" selection-name="rolling-date" available="false"><span class="i18n">Rolling Date:</span><br><div class="selection-options"><div class="form-group-rolling"><select><option value="last">Last</option><option value="next" disabled class="keep-disabled">Next</option></select></div><div class="form-group-rolling"><input type="text" id="date-input"></div><div class="form-group-rolling"><select id="period-select"><option name="TIME_DAYS" id="rd-days">Day(s)</option><option name="TIME_WEEKS" id="rd-weeks">Week(s)</option><option name="TIME_MONTHS" id="rd-months">Month(s)</option><option name="TIME_YEARS" id="rd-years">Year(s)</option></select></div></div></div></div>'),initialize:function(e){_.extend(this,e),this.options.title='<span class="i18n">Date Filter</span>',this.message="Loading...",this.query=e.workspace.query,this.selectedDates=[],this.levelInfo={cube:this.get_cube_name(),dimension:this.dimension,hierarchy:this.hierarchy,name:this.name},_.bindAll(this,"finished"),this.bind("open",this.post_render),this.render(),this.show_button_clear()?(this.$el.find(".dialog_footer a:nth-child(1)").show(),this.$el.find(".dialog_footer a:nth-child(3)").hide()):this.$el.find(".dialog_footer a:nth-child(1)").hide(),this.$el.parent().find(".ui-dialog-titlebar-close").bind("click",this.finished),this.member=new Member({},{cube:this.workspace.selected_cube,dimension:this.key}),this.$el.find(".dialog_body").html(this.template_dialog),this.$el.find(".available-selections *").prop("disabled",!0).off("click"),this.dataLevels=this.save_data_levels(),this.check_saikuDayFormatString(),this.add_values_fixed_date(),this.add_values_last_periods(),this.populate(),Saiku.i18n.translate()},help:function(e){e.preventDefault(),window.open("http://wiki.meteorite.bi/display/SAIK/Advanced+Date+Filtering")},open_standard_filter:function(e){e.preventDefault(),new SelectionsModal({source:"DateFilterModal",target:this.target,name:this.name,key:this.key,objDateFilter:{dimension:this.dimension,hierarchy:this.hierarchy,data:this.data,analyzerDateFormat:this.analyzerDateFormat,dimHier:this.dimHier},workspace:this.workspace}).open(),this.$el.dialog("destroy").remove()},post_render:function(e){var t=($(window).width()-600)/2,i=600>$(window).width()?$(window).width():600;$(e.modal.el).parents(".ui-dialog").css({width:i,left:"inherit",margin:"0",height:490}).offset({left:t})},check_saikuDayFormatString:function(){var e=this;this.$el.find(".selection-radio").each(function(t,i){_.find(e.dataLevels,function(t){e.name===t.name&&t.saikuDayFormatString&&$(i).prop("disabled",!1)})})},show_fields:function(e){var t=(e=e.type?$(e.currentTarget):$(e)).data("operator");if(void 0!==t)switch(t){case"equals":case"different":e.closest(".selection-options").find("#div-selection-date").show(),e.closest(".selection-options").find("#div-selected-date").show(),e.closest(".selection-options").find("#div-select-start-date").hide(),e.closest(".selection-options").find("#div-select-end-date").hide(),e.closest(".selection-options").find("#add-date").show(),this.clear_operators();break;case"after":case"after&equals":case"before":case"before&equals":e.closest(".selection-options").find("#div-selection-date").show(),e.closest(".selection-options").find("#div-selected-date").hide(),e.closest(".selection-options").find("#div-select-start-date").hide(),e.closest(".selection-options").find("#div-select-end-date").hide(),e.closest(".selection-options").find("#add-date").hide(),this.clear_operators();break;case"between":case"notbetween":e.closest(".selection-options").find("#div-selection-date").hide(),e.closest(".selection-options").find("#div-selected-date").hide(),e.closest(".selection-options").find("#div-select-start-date").show(),e.closest(".selection-options").find("#div-select-end-date").show(),e.closest(".selection-options").find("#add-date").hide(),this.clear_operators();break;default:e.closest(".selection-options").find("#div-selection-date").hide(),e.closest(".selection-options").find("#div-selected-date").hide(),e.closest(".selection-options").find("#div-select-start-date").hide(),e.closest(".selection-options").find("#div-select-end-date").hide(),e.closest(".selection-options").find("#add-date").hide(),this.clear_operators()}else this.$el.find(".selection-options").find("#div-selection-date").hide(),this.$el.find(".selection-options").find("#div-selected-date").hide(),this.$el.find(".selection-options").find("#div-select-start-date").hide(),this.$el.find(".selection-options").find("#div-select-end-date").hide(),this.$el.find(".selection-options").find("#add-date").hide(),this.clear_operators()},save_data_levels:function(){var e=this,t=[];return _.each(this.data.hierarchies.levels,function(i,s,a){void 0===a[s].annotations.AnalyzerDateFormat&&void 0===a[s].annotations.SaikuDayFormatString||(void 0!==a[s].annotations.AnalyzerDateFormat?t.push({name:a[s].name,analyzerDateFormat:a[s].annotations.AnalyzerDateFormat.replace(/[.]/gi,"\\."),levelType:a[s].levelType,saikuDayFormatString:a[s].annotations.SaikuDayFormatString||""}):t.push({name:a[s].name,analyzerDateFormat:"",levelType:a[s].levelType,saikuDayFormatString:a[s].annotations.SaikuDayFormatString||""}),a[s].annotations.SaikuDayFormatString&&(e.saikuDayFormatString=a[s].annotations.SaikuDayFormatString))}),t},add_values_fixed_date:function(){var e=this;this.$el.find(".available-selections").each(function(t,i){"fixed-date"===$(i).attr("selection-name")&&($(i).find("input:radio").each(function(t,i){var s=$(i).data("leveltype");_.find(e.dataLevels,function(t,a){s===t.levelType?$(i).val(e.dataLevels[a].analyzerDateFormat):"yesterday"!==s&&"today"!==s||t.name!==e.name||_.isEmpty(e.dataLevels[a].analyzerDateFormat)||void 0===e.dataLevels[a].analyzerDateFormat||null===e.dataLevels[a].analyzerDateFormat||"TIME_DAYS"!==e.dataLevels[a].levelType||$(i).val(e.dataLevels[a].analyzerDateFormat)})}),$(i).find("input:radio").each(function(e,t){null!==$(t).val()&&void 0!==$(t).val()&&""!==$(t).val()&&"on"!==$(t).val()||$(t).addClass("keep-disabled")}))})},add_values_last_periods:function(){var e=this;this.$el.find(".available-selections").each(function(t,i){"rolling-date"===$(i).attr("selection-name")&&($(i).find("#period-select > option").each(function(t,i){var s=$(i).attr("name");_.find(e.dataLevels,function(t,a){s===t.levelType&&$(i).val(e.dataLevels[a].analyzerDateFormat)})}),$(i).find("#period-select > option").each(function(e,t){null!==$(t).attr("value")&&void 0!==$(t).attr("value")&&""!==$(t).attr("value")||$(t).addClass("keep-disabled")}))})},selection_date:function(e){e=$(e.currentTarget);var t=this.saikuDayFormatString.replace(/yyyy/gi,"yy");e.datepicker({dateFormat:t})},clear_selections:function(e){this.show_fields(e),this.$el.find('input[type="text"]').val(""),this.$el.find("select").prop("selectedIndex",0),this.$el.find("#selected-date").empty(),this.$el.find(".available-selections *").prop("checked",!1),this.selectedDates=[]},clear_operators:function(){this.$el.find('input[type="text"]').val(""),this.$el.find("#selected-date").empty(),this.selectedDates=[]},disable_divselections:function(e){var t=Array.prototype.slice.call(arguments),i=e.type?$(e.currentTarget):$(e);t[1]||this.clear_selections(e),this.$el.find(".available-selections").attr("available",!1),this.$el.find(".available-selections *").prop("disabled",!0).off("click"),i.closest(".box-selections").find(".available-selections").attr("available",!0),i.closest(".box-selections").find(".available-selections *:not(.keep-disabled)").prop("disabled",!1).on("click"),e.type&&i.closest(".box-selections").find("select").each(function(e,t){$(t).find("option:not([disabled])").first().attr("selected","selected")})},day_format_string:function(){var e=this.saikuDayFormatString;return e=e.replace(/[a-zA-Z]/gi,"9")},add_selected_date:function(e){e.preventDefault();var t=$(e.currentTarget),i=this.day_format_string();e=this.$el.find("#selection-date"),t=t.closest(".inline-form-group").find("#div-selected-date").find("#selected-date"),""!==e.val()?(i=Saiku.toPattern(e.val(),i),e.css("border","1px solid #ccc"),t.append($("<li></li>").text(i).append('<a href="#" class="del-date" data-date="'+i+'">x</a>')),this.selectedDates.push(i)):e.css("border","1px solid red"),e.val("")},del_selected_date:function(e){e.preventDefault();var t=(e=$(e.currentTarget)).data("date");this.selectedDates=_.without(this.selectedDates,t),e.parent().remove()},populate:function(){var e,t=this.get_date_filter();if(t&&!_.isEmpty(t))if("operator"===t.type){var i=this.$el.find("#"+t.checked),s=i.data("operator"),a=this;(e=this.$el.find("#selection-radio-operator")).prop("checked",!0),i.prop("checked",!0),this.disable_divselections(e,!0),this.show_fields(i),this.selectedDates=t.values,"after"===s||"after&equals"===s||"before"===s||"before&equals"===s?this.$el.find("#selection-date").val(this.selectedDates[0]):"between"===s?(a.$el.find("#start-date").val(this.selectedDates[0]),a.$el.find("#end-date").val(this.selectedDates[1])):"notbetween"===s?(a.$el.find("#start-date").val(this.selectedDates[0]),a.$el.find("#end-date").val(this.selectedDates[1])):_.each(this.selectedDates,function(e,t){a.$el.find("#selected-date").append($("<li></li>").text(e).append('<a href="#" class="del-date" data-date="'+e+'">x</a>'))})}else"fixed-date"===t.type?((e=this.$el.find("#selection-radio-fixed-date")).prop("checked",!0),this.$el.find("#"+t.checked).prop("checked",!0)):((e=this.$el.find("#selection-radio-available")).prop("checked",!0),this.$el.find("#date-input").val(t.periodAmount),this.$el.find('select#period-select option[id="'+t.periodSelect+'"]').prop("selected",!0)),this.disable_divselections(e,!0)},populate_mdx:function(e,t,i){if(e.tagdim=e.dimension.replace(/m/g,"\\m").replace(/y/g,"\\y").replace(/q/g,"\\q").replace(/d/g,"\\d"),e.taghier=e.hierarchy.replace(/m/g,"\\m").replace(/y/g,"\\y").replace(/q/g,"\\q").replace(/d/g,"\\d"),e.workinglevel!==e.level&&void 0!==e.workinglevel?(e.parent="[{dimension}.{hierarchy}].[{level}].members,",e.parent=e.parent.replace(/{(\w+)}/g,function(t,i){return e[i]})):e.parent="",this.template_mdx=this.template_mdx.replace(/{(\w+)}/g,function(t,i){return e[i]}),"dayperiods"===t){if(e.parent="[{dimension}.{hierarchy}].[{level}]",e.parent=e.parent.replace(/{(\w+)}/g,function(t,i){return e[i]}),1<this.selectedDates.length){for(t=this.selectedDates.length,i=0;i<t;i++)if(e.dates=this.selectedDates[i],">=|<="===e.comparisonOperator)0===i?(e.comparisonOperator=e.comparisonOperator.split("|")[0],this.template_days_mdx=this.template_days_mdx.replace(/{(\w+)}/g,function(t,i){return e[i]}),e.comparisonOperator=">=|<="):(e.logicalOperator="AND",e.comparisonOperator=e.comparisonOperator.split("|")[1],this.template_days_mdx+=this.template_many_years_mdx.replace(/{(\w+)}/g,function(t,i){return e[i]}));else if(">=||<="===e.comparisonOperator){if(0!==i)return e.logicalOperator="AND",e.comparisonOperator=e.comparisonOperator.split("||")[1],this.template_days_mdx+=this.template_many_years_mdx.replace(/{(\w+)}/g,function(t,i){return e[i]}),this.template_days_mdx+"))";this.template_days_mdx="EXCEPT({parent}.Members, "+this.template_days_mdx,e.comparisonOperator=e.comparisonOperator.split("||")[0],this.template_days_mdx=this.template_days_mdx.replace(/{(\w+)}/g,function(t,i){return e[i]}),e.comparisonOperator=">=||<="}else 0===i?this.template_days_mdx=this.template_days_mdx.replace(/{(\w+)}/g,function(t,i){return e[i]}):(e.logicalOperator="<>"===e.comparisonOperator?"AND":"OR",this.template_days_mdx+=this.template_many_years_mdx.replace(/{(\w+)}/g,function(t,i){return e[i]}));return this.template_days_mdx+")"}return e.dates=this.selectedDates[0],this.template_days_mdx=this.template_days_mdx.replace(/{(\w+)}/g,function(t,i){return e[i]})+")"}return"lastperiods"===t?this.template_last_mdx=this.template_last_mdx.replace(/{(\w+)}/g,function(t,i){return e[i]}):"yesterday"!==t?this.template_mdx:this.template_mdx+".lag(1)"},save:function(e){e.preventDefault(),e=$("<div>Saving...</div>"),$(this.el).find(".dialog_body").children().hide(),$(this.el).find(".dialog_body").prepend(e);var t,i,s,a,r=this,n=null,o={};null!==r.hierarchy&&void 0!==r.hierarchy||(r.hierarchy=r.dimension),this.$el.find(".available-selections").each(function(e,l){if("true"===$(l).attr("available")){o.type=$(l).attr("selection-name"),"operator"===$(l).attr("selection-name")?$(l).find("input:radio").each(function(e,s){if(!0===$(s).is(":checked")){var a=$(s).data("operator");o.checked=$(s).attr("id"),"after"===a||"after&equals"===a||"before"===a||"before&equals"===a?(r.selectedDates=[],r.selectedDates.push(r.$el.find("#selection-date").val())):"between"!==a&&"notbetween"!==a||(r.selectedDates=[],r.selectedDates.push(r.$el.find("#start-date").val()),r.selectedDates.push(r.$el.find("#end-date").val())),t="dayperiods",i=$(s).val(),o.values=r.selectedDates}}):"fixed-date"===$(l).attr("selection-name")?$(l).find("input:radio").each(function(e,i){!0===$(i).is(":checked")&&(t=$(i).attr("id").split("-")[1],s=$(i).val(),o.checked=$(i).attr("id"))}):"rolling-date"===$(l).attr("selection-name")&&(s=$("#period-select").find(":selected").val(),t="lastperiods",a=$(l).find("input:text").val(),o.fixedDateName=t,o.periodAmount=$(l).find("input:text").val(),o.periodSelect=$("#period-select").find(":selected").attr("id"));var d,c,h=r.dataLevels.length;for(c=0;c<h;c++)r.dataLevels[c].analyzerDateFormat===s&&(d=r.dataLevels[c].name);h={dimension:r.dimension,hierarchy:r.hierarchy,level:r.name,analyzerDateFormat:s,periodAmount:a,comparisonOperator:i,workinglevel:d},n="dayperiods"===t&&""!==r.selectedDates[0]&&void 0!==r.selectedDates[0]||"lastperiods"===t&&!_.isEmpty(s)&&"Day(s)"!==s&&!_.isEmpty(a)||"dayperiods"!==t&&"lastperiods"!==t&&!_.isEmpty(s)?r.populate_mdx(h,t):null}});var l=decodeURIComponent(this.member.hierarchy);if(e=decodeURIComponent(this.member.level),l=this.workspace.query.helper.getHierarchy(l),this.get_cube_name(),_.extend(o,this.levelInfo),"dayperiods"===t&&""!==this.selectedDates[0]&&void 0!==r.selectedDates[0]||"lastperiods"===t&&!_.isEmpty(s)&&"Day(s)"!==s&&!_.isEmpty(a)||"dayperiods"!==t&&"lastperiods"!==t&&!_.isEmpty(s))this.set_date_filter(o);else{var d=this.get_uuid(o);this.workspace.dateFilter.remove(d),this.workspace.query.setProperty("saiku.ui.datefilter.data",this.workspace.dateFilter.toJSON())}l&&l.levels.hasOwnProperty(e)&&(l.levels[e]={mdx:n,name:e}),this.finished()},get_cube_name:function(){return decodeURIComponent(this.workspace.selected_cube.split("/")[3])},get_uuid:function(e){return"["+e.cube+"]."+this.dimHier+".["+e.name+"]"},set_date_filter:function(e){var t=this.workspace.dateFilter,i=t.toJSON(),s=this.get_uuid(e);e.id=s,e.key=this.key,i&&!_.isEmpty(i)&&t.get(s)?(t=t.get(s)).set(e):t.add(e),this.workspace.query.setProperty("saiku.ui.datefilter.data",t.toJSON())},get_date_filter:function(){var e={cube:this.get_cube_name(),dimension:this.dimension,hierarchy:this.hierarchy,name:this.name},e=this.get_uuid(e);return e=(e=this.workspace.dateFilter.get(e))?e.toJSON():[]},clear_date_filter:function(e){e.preventDefault(),this.workspace.dateFilter.toJSON();var t;t=this.get_uuid(this.levelInfo);var i=decodeURIComponent(this.member.hierarchy),s=decodeURIComponent(this.member.level);(i=this.workspace.query.helper.getHierarchy(i))&&i.levels.hasOwnProperty(s)&&(i.levels[s]={mdx:null,name:s}),this.workspace.dateFilter.remove(t),this.workspace.query.setProperty("saiku.ui.datefilter.data",this.workspace.dateFilter.toJSON()),this.clear_selections(e),this.finished()},show_button_clear:function(){var e,t=this.workspace.dateFilter,i=t.toJSON();return e=this.get_uuid(this.levelInfo),!(!i||_.isEmpty(i))&&!!t.get(e)},finished:function(e){this.$el.dialog("destroy").remove(),e||this.query.run()}}),DateFilterObserver=Backbone.View.extend({initialize:function(e){this.workspace=e.workspace,_.bindAll(this,"receive_data","workspace_levels"),this.workspace.bind("query:result",this.receive_data),Saiku.session.bind("dimensionList:select_dimension",this.receive_data),Saiku.session.bind("workspaceDropZone:select_dimension",this.receive_data),Saiku.session.bind("workspaceDropZone:clear_axis",this.receive_data)},receive_data:function(e){var t=this.workspace.dateFilter.toJSON();if(this.check_dateFilter_saved(),t&&!_.isEmpty(t))return _.delay(this.workspace_levels,1e3,e)},get_cube_name:function(){return decodeURIComponent(this.workspace.selected_cube.split("/")[3])},workspace_levels:function(e){e=this.get_cube_name();var t=this.workspace.query.helper.getAxis("COLUMNS"),i=this.workspace.query.helper.getAxis("ROWS"),s=this.workspace.query.helper.getAxis("FILTER"),a=[];"COLUMNS"===t.location&&0<t.hierarchies.length&&a.push(this.get_axes(e,t)),"ROWS"===i.location&&0<i.hierarchies.length&&a.push(this.get_axes(e,i)),"FILTER"===s.location&&0<s.hierarchies.length&&a.push(this.get_axes(e,s)),a=_.compact(_.union(a[0],a[1],a[2])),this.check_dateFilter_model(a)},get_axes:function(e,t){var i,s=[],a=t.hierarchies.length;for(i=0;i<a;i++)for(var r in t.hierarchies[i].levels)t.hierarchies[i].levels.hasOwnProperty(r)&&s.push("["+e+"]."+t.hierarchies[i].name+".["+r+"]");return s},check_dateFilter_saved:function(){var e=this.workspace.checkDateFilterSaved;this.workspace.item&&!_.isEmpty(this.workspace.item)&&void 0===e&&(e=this.workspace.query.getProperty("saiku.ui.datefilter.data"),this.workspace.dateFilter.add(e)),this.workspace.checkDateFilterSaved=!0},check_dateFilter_model:function(e){var t=[],i=[],s=this.workspace.dateFilter.toJSON(),a=s.length,r=e.length,n=0,o=0;if(0<r&&s&&!_.isEmpty(s))for(;o<r;)e[o]===s[n].id?i.push(s[n].id):t.push(s[n].id),n+1<a?n++:(n=0,o++);else if(0===r&&s&&!_.isEmpty(s)){for(e=0;e<a;e++)this.workspace.dateFilter.remove(s[e].id);this.workspace.query.setProperty("saiku.ui.datefilter.data",this.workspace.dateFilter.toJSON())}this.remove_dateFilter_model(_.difference(t,i))},remove_dateFilter_model:function(e){var t,i=e.length;for(t=0;t<i;t++)this.workspace.dateFilter.remove(e[t]);this.workspace.query.setProperty("saiku.ui.datefilter.data",this.workspace.dateFilter.toJSON())}});Saiku.events.bind("session:new",function(){function e(e){void 0===e.workspace.dateFilterObserver&&(e.workspace.dateFilterObserver=new DateFilterObserver({workspace:e.workspace}))}for(var t=0,i=Saiku.tabs._tabs.length;t<i;t++)e({workspace:Saiku.tabs._tabs[t].content});Saiku.session.bind("workspace:new",e)});var WarningModal=Modal.extend({type:"info",buttons:[{text:"Okay",method:"okay"},{text:"Cancel",method:"close"}],initialize:function(e){this.options.title=e.title,this.message=e.message,this.cancelfunction=e.cancel,this.okayfunction=e.okay,this.okaycallbackobject=e.okayobj,this.cancelcallbackobject=e.cancelobj},close:function(e){"#close"===e.target.hash&&e.preventDefault(),null!=this.cancelfunction&&this.cancelfunction(this.cancelcallbackobject),this.$el.dialog("destroy").remove()},okay:function(e){e.preventDefault(),null!=this.okayfunction&&this.okayfunction(this.okaycallbackobject),this.$el.dialog("destroy").remove()}}),TitlesModal=Modal.extend({type:"info",buttons:[{text:"Okay",method:"okay"},{text:"Cancel",method:"close"}],message:_.template("<form id='login_form'><label for='title' class='i18n'>Title</label><input type='text' id='title' name='title' value='' /><label for='variable' class='i18n'>Variable</label><input type='text' id='variable' name='variable' value='' /><label for='explanation' class='i18n'>Explanation</label><input type='text' id='explanation' name='explanation' value='' /></form>")(),initialize:function(e){this.options.title="Report Titles",this.query=e.query},close:function(e){"#close"===e.target.hash&&e.preventDefault(),this.$el.dialog("destroy").remove()},okay:function(e){e.preventDefault(),e={title:$(this.el).find("#title").val(),variable:$(this.el).find("#variable").val(),explanation:$(this.el).find("#explanation").val()},e=JSON.stringify(e),this.query.setProperty("saiku.ui.headings",e),this.query.run(!0),this.$el.dialog("destroy").remove()}});!function(e){var t;e:{try{document.createElement("$")}catch(e){t=e;break e}t=void 0}e.Base64||(e.Base64={encode:function(e){for(var i,s,a,r,n,o,l=0,d=e.length,c=Math.max,h="";l<d;){if(i=e.charCodeAt(l++)||0,s=e.charCodeAt(l++)||0,o=e.charCodeAt(l++)||0,255<c(i,s,o))throw t;a=i>>2&63,i=(3&i)<<4|s>>4&15,r=(15&s)<<2|o>>6&3,n=63&o,s?o||(n=64):r=n=64,h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(a)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(i)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(r)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(n)}return h}})}(this),Backbone.sync=function(e,t,i){methodMap={create:"POST",read:"GET",update:"PUT",delete:"DELETE"};var s=methodMap[e],a=Settings.REST_URL+(_.isFunction(t.url)?t.url():t.url);void 0===Settings.ERRORS&&(Settings.ERRORS=0);var r=function(){++Settings.ERRORS<Settings.ERROR_TOLERANCE?Saiku.session.logout():Saiku.ui.block("Communication problem with the server. Please reload the application...")};e=!0,!1===i.async&&(e=!1);var n="json";void 0!==i.dataType&&(n=i.dataType);var o="application/x-www-form-urlencoded";void 0!==i.contentType&&(o=i.contentType),t=t.attributes,void 0!==i.data&&(t=i.data),t={url:a,type:s,cache:!1,data:t,contentType:o,dataType:n,success:function(e,t,s){Settings.ERRORS=0,Saiku.ui.unblock(),i.success(e,t,s)},statusCode:{0:function(){r()},401:function(){r()}},error:function(e,t,r){!isIE&&"undefined"!=typeof console&&console&&console.error&&(console.error("Error performing "+s+" on "+a),console.error(r)),i.error&&i.error(e,t,r)},async:e},!1===i.processData&&(t.processData=!1),(Settings.BIPLUGIN&&!Settings.BIPLUGIN5||Backbone.emulateHTTP)&&("PUT"!==s&&"DELETE"!==s||(Backbone.emulateHTTP&&(t.data._method=s),t.type="POST",t.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",s)})),$.ajax(t)};var QueryRouter=Backbone.Router.extend({routes:{"query/open/*query_name":"open_query","query/open":"open_query_repository"},open_query:function(e){Settings.ACTION="OPEN_QUERY";var t;t=!Settings.BIPLUGIN5&&Settings.BIPLUGIN?(Settings.GET.SOLUTION?Settings.GET.SOLUTION+"/":"")+(Settings.GET.PATH&&"/"!=Settings.GET.PATH?Settings.GET.PATH+"/":"")+(Settings.GET.ACTION||""):e;var i=_.extend({file:t},Settings.PARAMS);new Repository({},{dialog:{populate:function(e){if(e&&0<e.length){var s=new Query(i,{name:t});Saiku.tabs.add(new Workspace({query:s,item:e[0]}))}else Saiku.tabs.add(new Workspace);Settings.INITIAL_QUERY=!1}},file:t}).fetch({async:!1,data:{path:t}})},open_query_repository:function(){Toolbar.prototype.open_query()}});Saiku.routers.push(new QueryRouter);